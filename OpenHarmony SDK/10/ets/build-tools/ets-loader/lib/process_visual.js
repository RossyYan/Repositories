"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.findIfVisualFileExists=findIfVisualFileExists,exports.findVisualFile=findVisualFile,exports.getHasSearchedVisualFiles=getHasSearchedVisualFiles,exports.getHasVisual=getHasVisual,exports.parseVisual=parseVisual,exports.visualTransform=visualTransform;var _typescript=_interopRequireDefault(require("typescript")),_fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),_sourceMap=require("source-map"),_validate_ui_syntax=require("./validate_ui_syntax"),_utils=require("./utils"),_pre_define=require("./pre_define"),_main=require("../main.js"),_codegen_ets=require("../codegen/codegen_ets.js");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}const visualMap=new Map,slotMap=new Map,red="[31m",reset="[39m",compilerOptions=_typescript.default.readConfigFile(_path.default.resolve(__dirname,"../tsconfig.json"),_typescript.default.sys.readFile).config.compilerOptions;let hasVisual=compilerOptions.sourceMap=!1,hasSearched=!1;function findIfVisualFileExists(){hasSearched=!0;var e=_main.projectConfig.modulePathMap;if(e)for(const r of Object.values(e)){var t=_path.default.join(r,_pre_define.MODULE_VISUAL_PATH);if(_fs.default.existsSync(t))return void(hasVisual=!0)}}function getHasSearchedVisualFiles(){return hasSearched}function getHasVisual(){return hasVisual}function visualTransform(e,t,r){var a,i;return hasSearched||findIfVisualFileExists(),(void 0===_main.projectConfig.modulePathMap||hasVisual)&&(a=[],i=getParsedContent(e,_path.default.normalize(t),a))?(a.length&&(0,_utils.emitLogInfo)(r,a,!0,t),generateSourceMapForNewAndOriEtsFile(_path.default.normalize(t),e),i):e}function parseVisual(e,t,r,a,i){var n,s;return(n=getParsedContent(r,e,a))?(n=(s=(0,_validate_ui_syntax.sourceReplace)(n,e)).content,a.concat(s.log),s=(0,_validate_ui_syntax.validateUISyntax)(i,n,e,t),a.concat(s),a.length||generateSourceMapForNewAndOriEtsFile(e,i),n):r}function parseStatement(t,r,a,i){var n=this;return t.kind===_typescript.default.SyntaxKind.StructDeclaration&&t.name&&t.members&&t.members.forEach(function(e){_newArrowCheck(this,n),e.kind&&e.kind===_typescript.default.SyntaxKind.MethodDeclaration&&(r=parseMember(t,e,r,a,i))}.bind(this)),r}function parseMember(e,t,r,a,i){let n=r;return t.name&&"build"===t.name.getText()&&("build(){}"===t.getText().replace(/\ +/g,"").replace(/[\r\n]/g,"")?n=insertVisualCode(e,t,i,n):a.push({type:_utils.LogType.ERROR,message:"when the corresponding visual file exists, the build function of the entry component must be empty.",pos:t.pos})),n}function insertVisualCode(e,t,r,a){return insertAboutToAppear(e,t,r,insertBuild(t,r,insertVarAndFunc(t,r,insertImport(r,a),a),a),a)}function insertImport(e,t){var r;return e.etsImport?(r=(e=e.etsImport+"\n")+t,slotMap.set(0,e.length),visualMap.set(0,e.split("\n").length-1),r):t}function insertVarAndFunc(e,t,r,a){t=(t.etsVariable||"")+(t.etsFunction||"");return t?insertVisualCodeBeforePos(e,"\n"+t,r,a):r}function insertBuild(e,t,r,a){return t.build?insertVisualCodeAfterPos(e.body,"\n"+t.build+"\n",r,a):r}function insertAboutToAppear(e,t,r,a,i){if(!r.aboutToAppear)return a;for(const n of e.members)if(n.kind&&n.kind===_typescript.default.SyntaxKind.MethodDeclaration&&n.name&&"aboutToAppear"===n.name.getText())return insertVisualCodeAfterPos(n.body,"\n"+r.aboutToAppear,a,i);return insertVisualCodeBeforePos(t,"\n  aboutToAppear() {\n"+r.aboutToAppear+"  }\n",a,i)}function insertVisualCodeAfterPos(e,t,r,a){var i,n,a=a.substring(0,e.getStart()+1).split("\n").length,s=t.split("\n").length-1,o=visualMap.get(a);visualMap.set(a,o?o+s:s);let l=e.getStart()+1;for([i,n]of slotMap)e.getStart()>=i&&(l+=n);a=r.substring(0,l)+t+r.substring(l);return slotMap.set(e.getStart(),t.length),a}function insertVisualCodeBeforePos(e,t,r,a){var i,n,a=a.substring(0,e.pos).split("\n").length,s=t.split("\n").length-1,o=visualMap.get(a);visualMap.set(a,o?o+s:s);let l=e.pos;for([i,n]of slotMap)e.pos>=i&&(l+=n);a=r.substring(0,l)+t+r.substring(l);return slotMap.set(e.pos,t.length),a}function generateSourceMapForNewAndOriEtsFile(r,t){var a=this;if(process.env.cachePath){var i=new _sourceMap.SourceMapGenerator({file:r}),n=t.split("\n").length;for(let t=1;t<=n;t++){let e=t;for(var[s,o]of visualMap)t>s&&(e+=o);i.addMapping({generated:{line:e,column:0},source:r,original:{line:t,column:0}})}var t=_path.default.parse(r).name+_pre_define.SUPERVISUAL_SOURCEMAP_EXT,l=_path.default.parse(r).dir,u=_path.default.parse(_main.projectConfig.projectPath).dir;let e=_path.default.resolve(process.env.cachePath,_pre_define.SUPERVISUAL+l.replace(u,""));l.includes(u)||(u=getProjectRootPath(),e=_path.default.resolve(process.env.cachePath,_pre_define.SUPERVISUAL+l.replace(u,""))),_fs.default.existsSync(e)&&_fs.default.statSync(e).isDirectory()||(0,_utils.mkDir)(e),_fs.default.writeFile(_path.default.resolve(e,t),i.toString(),function(e){if(_newArrowCheck(this,a),e)return console.error(red,"ERROR: Failed to write visual.js.map",reset)}.bind(this))}}function getProjectRootPath(){let e=_main.projectConfig.projectRootPath;return e=e||(_main.projectConfig.aceModuleJsonPath?_path.default.resolve(_main.projectConfig.projectPath,"../../../../"):_path.default.resolve(_main.projectConfig.projectPath,"../../../../../"))}function findVisualFile(e){if(!/\.ets$/.test(e))return"";var r=_path.default.parse(_main.projectConfig.projectPath).dir,a=_path.default.parse(_main.projectConfig.aceSuperVisualPath).dir,t=e.replace(_main.projectConfig.projectPath,_main.projectConfig.aceSuperVisualPath).replace(r,a).replace(/\.ets$/,".visual");if(_fs.default.existsSync(t))return t;try{var i=getProjectRootPath();let t="";var n=e.replace(i,"").split(_path.default.sep);for(let e=0;e<n.length;++e){if("src"===n[e]){if(e>=n.length-2)break;if(_path.default.join(n[e],n[e+1],n[e+2])===_pre_define.MODULE_ETS_PATH)break}t=_path.default.join(t,n[e])}return r=_path.default.join(i,t,_pre_define.MODULE_ETS_PATH),a=_path.default.join(i,t,_pre_define.MODULE_VISUAL_PATH),e.replace(r,a).replace(/\.ets$/,".visual")}catch(e){return""}}function getVisualContent(e,t){e=(0,_codegen_ets.genETS)(_fs.default.readFileSync(e,"utf-8"));return e&&e.errorType&&""!==e.errorType&&t.push({type:_utils.LogType.ERROR,message:e.errorMessage}),e?e.ets:null}function getParsedContent(e,t,r){var a=this;if(!_main.projectConfig.aceSuperVisualPath||!_validate_ui_syntax.componentCollection.entryComponent&&!_validate_ui_syntax.componentCollection.customComponents)return null;var i=findVisualFile(t);if(!i||!_fs.default.existsSync(i))return null;const n=getVisualContent(i,r);if(!n)return null;clearVisualSlotMap();i=_typescript.default.createSourceFile(t,e,_typescript.default.ScriptTarget.Latest,!0,_typescript.default.ScriptKind.ETS,compilerOptions);let s=e;return i.statements&&i.statements.forEach(function(e){_newArrowCheck(this,a),s=parseStatement(e,s,r,n)}.bind(this)),s}function clearVisualSlotMap(){visualMap.clear(),slotMap.clear()}