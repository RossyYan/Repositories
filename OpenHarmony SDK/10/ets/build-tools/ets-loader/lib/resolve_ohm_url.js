"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.OHMResolverPlugin=void 0,exports.isOhmUrl=isOhmUrl,exports.resolveSourceFile=resolveSourceFile;var fs=_interopRequireWildcard(require("fs")),path=_interopRequireWildcard(require("path")),_compile_info=require("./compile_info");function _getRequireWildcardCache(e){var r,t;return"function"!=typeof WeakMap?null:(r=new WeakMap,t=new WeakMap,(_getRequireWildcardCache=function(e){return e?t:r})(e))}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};r=_getRequireWildcardCache(r);if(r&&r.has(e))return r.get(e);var t,i,o={},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&((i=s?Object.getOwnPropertyDescriptor(e,t):null)&&(i.get||i.set)?Object.defineProperty(o,t,i):o[t]=e[t]);return o.default=e,r&&r.set(e,o),o}function _newArrowCheck(e,r){if(e!==r)throw new TypeError("Cannot instantiate an arrow function")}function _defineProperty(e,r,t){return(r=_toPropertyKey(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==typeof e?e:String(e)}function _toPrimitive(e,r){if("object"!=typeof e||null===e)return e;var t=e[Symbol.toPrimitive];if(void 0===t)return("string"===r?String:Number)(e);t=t.call(e,r||"default");if("object"!=typeof t)return t;throw new TypeError("@@toPrimitive must return a primitive value.")}const projectConfig=require("../main")["projectConfig"],red="[31m",reset="[39m",REG_OHM_URL=/^@bundle:(\S+)\/(\S+)\/(ets|js)\/(\S+)$/;class OHMResolverPlugin{constructor(e="resolve",r="resolve"){_defineProperty(this,"source",void 0),_defineProperty(this,"target",void 0),this.source=e,this.target=r}apply(o){var s=this;const n=o.ensureHook(this.target);o.getHook(this.source).tapAsync("OHMResolverPlugin",function(e,r,t){var i;if(_newArrowCheck(this,s),isOhmUrl(e.request))return i=resolveSourceFile(e.request),e=Object.assign({},e,{request:i}),o.doResolve(n,e,null,r,t);t()}.bind(this))}}function isOhmUrl(e){return!!/^@(\S+):/.test(e)}function addExtension(e,r){let t=".d.ts";return fs.existsSync(e+".ets")&&fs.statSync(e+".ets").isFile()&&(t=".ets"),fs.existsSync(e+".ts")&&fs.statSync(e+".ts").isFile()&&(".d.ts"!==t&&_compile_info.logger.error(red,`ArkTS:ERROR Failed to compile with files with same name ${r} in the same directory`,reset),t=".ts"),fs.existsSync(e+".js")&&fs.statSync(e+".js").isFile()&&(".d.ts"!==t&&_compile_info.logger.error(red,`ArkTS:ERROR Failed to compile with files with same name ${r} in the same directory`,reset),t=".js"),e+t}function resolveSourceFile(e){if(!projectConfig.aceBuildJson)return _compile_info.logger.error(red,"ArkTS:ERROR Failed to resolve OhmUrl because of aceBuildJson not existing ",reset),e;var r=e.match(REG_OHM_URL),t=r[2],i=r[3],t=projectConfig.modulePathMap[t],o=projectConfig.isOhosTest?"src/ohosTest":"src/main";let s=path.join(t,o,i,r[4]);if(s=addExtension(s,r[4]),!fs.existsSync(s)||!fs.statSync(s).isFile()){if(projectConfig.isOhosTest&&(s=addExtension(s=path.join(t,"src/main",i,r[4]),r[4]),fs.existsSync(s))&&fs.statSync(s).isFile())return s;_compile_info.logger.error(red,`ArkTS:ERROR Failed to resolve existed file by this ohm url ${e} `,reset)}return s}exports.OHMResolverPlugin=OHMResolverPlugin;