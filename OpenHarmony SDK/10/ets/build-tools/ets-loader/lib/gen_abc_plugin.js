"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ModuleInfo=exports.GenAbcPlugin=exports.EntryInfo=void 0,exports.initAbcEnv=initAbcEnv;var cachedSourceMaps,fs=_interopRequireWildcard(require("fs")),path=_interopRequireWildcard(require("path")),_cluster=_interopRequireDefault(require("cluster")),_process=_interopRequireDefault(require("process")),_os=_interopRequireDefault(require("os")),_events=_interopRequireDefault(require("events")),_compile_info=require("./compile_info"),childProcess=_interopRequireWildcard(require("child_process")),_utils=require("./utils"),_ark_utils=require("./ark_utils"),_main=require("../main"),_pre_define=require("./pre_define"),_gen_merged_abc=require("./gen_merged_abc"),_gen_aot=require("./gen_aot");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){var i,t;return"function"!=typeof WeakMap?null:(i=new WeakMap,t=new WeakMap,(_getRequireWildcardCache=function(e){return e?t:i})(e))}function _interopRequireWildcard(e,i){if(!i&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};i=_getRequireWildcardCache(i);if(i&&i.has(e))return i.get(e);var t,o,n={},r=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&((o=r?Object.getOwnPropertyDescriptor(e,t):null)&&(o.get||o.set)?Object.defineProperty(n,t,o):n[t]=e[t]);return n.default=e,i&&i.set(e,n),n}function _newArrowCheck(e,i){if(e!==i)throw new TypeError("Cannot instantiate an arrow function")}function _defineProperty(e,i,t){return(i=_toPropertyKey(i))in e?Object.defineProperty(e,i,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[i]=t,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==typeof e?e:String(e)}function _toPrimitive(e,i){if("object"!=typeof e||null===e)return e;var t=e[Symbol.toPrimitive];if(void 0===t)return("string"===i?String:Number)(e);t=t.call(e,i||"default");if("object"!=typeof t)return t;throw new TypeError("@@toPrimitive must return a primitive value.")}let output,isWin=!1,isMac=!1,isDebug=!1,arkDir,nodeJs,intermediateJsBundle=[],fileterIntermediateJsBundle=[],moduleInfos=[],filterModuleInfos=[],commonJsModuleInfos=[],ESMModuleInfos=[],entryInfos=new Map,hashJsonObject={},moduleHashJsonObject={},buildPathInfo="",buildMapFileList=new Set,isHotReloadFirstBuild=!0,protoFilePath="";const red="[31m",reset="[39m",blue="[34m",hashFile="gen_hash.json",ARK="/ark/";class ModuleInfo{constructor(e,i,t,o,n,r){_defineProperty(this,"filePath",void 0),_defineProperty(this,"tempFilePath",void 0),_defineProperty(this,"buildFilePath",void 0),_defineProperty(this,"abcFilePath",void 0),_defineProperty(this,"isCommonJs",void 0),_defineProperty(this,"recordName",void 0),_defineProperty(this,"sourceFile",void 0),_defineProperty(this,"packageName",void 0),this.filePath=e,this.tempFilePath=i,this.buildFilePath=t,this.abcFilePath=o,this.packageName=n,this.isCommonJs=r,this.recordName=(0,_ark_utils.getOhmUrlByFilepath)(e,_main.projectConfig,_compile_info.logger),this.sourceFile=e.replace(_main.projectConfig.projectRootPath+path.sep,"")}}exports.ModuleInfo=ModuleInfo;class EntryInfo{constructor(e,i,t){_defineProperty(this,"npmInfo",void 0),_defineProperty(this,"buildPath",void 0),_defineProperty(this,"entry",void 0),this.npmInfo=e,this.buildPath=i,this.entry=t}}exports.EntryInfo=EntryInfo;class GenAbcPlugin{constructor(e,i,t,o){output=e,arkDir=i,nodeJs=t,isDebug=o}apply(e){var i,t,r=this;if(fs.existsSync(path.resolve(arkDir,"build-win")))isWin=!0;else if(fs.existsSync(path.resolve(arkDir,"build-mac")))isMac=!0;else if(!fs.existsSync(path.resolve(arkDir,"build")))return _compile_info.logger.error(red,"ArkTS:ERROR find build fail",reset),void(_process.default.exitCode=_pre_define.FAIL);checkNodeModules()?(_main.projectConfig.compileMode===_pre_define.ESMODULE&&(_main.projectConfig.cachePath&&!_main.projectConfig.xtsMode&&(t={},i=path.join(_main.projectConfig.cachePath,_pre_define.PREBUILDINFO_JSON),(0,_utils.validateFilePathLength)(i,_compile_info.logger),t.buildMode=_main.projectConfig.buildArkMode,t.bundleName=_main.projectConfig.bundleName,t.moduleName=_main.projectConfig.moduleName,fs.writeFile(i,JSON.stringify(t,null,2),"utf-8",function(e){_newArrowCheck(this,r),e&&_compile_info.logger.error(red,"ArkTS:ERROR Failed to write module build info.",reset)}.bind(this))),(0,_utils.removeDir)(output),(0,_utils.removeDir)(_main.projectConfig.nodeModulesPath)),_main.projectConfig.compileMode===_pre_define.JSBUNDLE&&_process.default.env.minPlatformVersion&&_main.projectConfig.cachePath&&!_main.projectConfig.xtsMode&&(i={},t=path.join(_main.projectConfig.cachePath,_pre_define.PREBUILDINFO_JSON),(0,_utils.validateFilePathLength)(t,_compile_info.logger),i.minAPIVersion=_process.default.env.minPlatformVersion,fs.writeFile(t,JSON.stringify(i,null,2),"utf-8",function(e){_newArrowCheck(this,r),e&&_compile_info.logger.error(red,"ArkTS:ERROR Failed to write bundle build info.",reset)}.bind(this))),_events.default.EventEmitter.defaultMaxListeners=100,e.hooks.compilation.tap("GenAbcPlugin",function(e){_newArrowCheck(this,r),_main.projectConfig.compileMode!==_pre_define.JSBUNDLE&&void 0!==_main.projectConfig.compileMode&&(buildPathInfo=output,e.hooks.finishModules.tap("finishModules",handleFinishModules.bind(this)))}.bind(this)),e.hooks.compilation.tap("GenAbcPlugin",function(e){var o=this;_newArrowCheck(this,r),e.hooks.processAssets.tap("processAssets",function(i){var t=this;_newArrowCheck(this,o),_main.projectConfig.compileMode!==_pre_define.JSBUNDLE&&void 0!==_main.projectConfig.compileMode&&Object.keys(e.assets).forEach(function(e){_newArrowCheck(this,t),path.extname(e)!==_pre_define.EXTNAME_JS&&path.extname(e)!==_pre_define.EXTNAME_JS_MAP||delete i[e]}.bind(this))}.bind(this))}.bind(this)),e.hooks.emit.tap("GenAbcPlugin",function(o){var n=this;_newArrowCheck(this,r),_main.projectConfig.compileMode!==_pre_define.ESMODULE&&Object.keys(o.assets).forEach(function(e){var i,t;_newArrowCheck(this,n),output&&path.extname(e)===_pre_define.EXTNAME_JS&&(i=o.assets[e].source(),t=e.replace(/\.js$/,".temp.js"),writeFileSync(i,output,t,e))}.bind(this))}.bind(this)),e.hooks.afterEmit.tap("GenAbcPluginMultiThread",function(){_newArrowCheck(this,r),_main.projectConfig.compileMode!==_pre_define.ESMODULE&&0!==intermediateJsBundle.length&&(buildPathInfo=output,(0,_ark_utils.isTs2Abc)(_main.projectConfig)||"8"===_process.default.env.minPlatformVersion?invokeWorkersToGenAbc():(0,_ark_utils.isEs2Abc)(_main.projectConfig)?generateAbcByEs2AbcOfBundleMode(intermediateJsBundle):_compile_info.logger.error(red,"ArkTS:ERROR please set panda module",reset))}.bind(this))):_process.default.exitCode=_pre_define.FAIL}}function clearGlobalInfo(){"true"!==_process.default.env.watchMode&&(intermediateJsBundle=[],moduleInfos=[],entryInfos=new Map),fileterIntermediateJsBundle=[],filterModuleInfos=[],commonJsModuleInfos=[],ESMModuleInfos=[],hashJsonObject={},moduleHashJsonObject={},buildMapFileList=new Set}function getEntryInfo(t,o){if(o.descriptionFilePath){let e=!1;var n;for(n of getEntryCandidatesFromPackageJson(o).values())if((0,_utils.toUnixPath)(t)===n){e=!0;break}o=o.descriptionFilePath,o=path.resolve(o,"..");let i=(0,_utils.toUnixPath)(t.replace(o,""));i.startsWith("/")&&(i=i.slice(1,i.length));var r=path.resolve(o,"fake.js"),s=(0,_utils.genTemporaryPath)(r,_main.projectConfig.projectPath,_process.default.env.cachePath,_main.projectConfig),r=(0,_ark_utils.genBuildPath)(r,_main.projectConfig.projectPath,_main.projectConfig.buildPath,_main.projectConfig),o=(0,_utils.toUnixPath)(path.resolve(s,"..")),s=(0,_utils.toUnixPath)(path.resolve(r,".."));return!entryInfos.has(o)&&e&&(r=new EntryInfo(o,s,i),entryInfos.set(o,r)),s}}function getEntryCandidatesFromPackageJson(e){var i=this;let t=e.descriptionFileData,o=path.resolve(e.descriptionFilePath,".."),n=new Set;return t.browser&&("string"==typeof t.browser?n.add((0,_utils.toUnixPath)(path.join(o,t.browser))):Object.keys(t.browser).forEach(function(e){_newArrowCheck(this,i),"string"==typeof e&&"string"==typeof t.browser[e]&&n.add((0,_utils.toUnixPath)(path.join(o,t.browser[e])))}.bind(this))),t.module&&n.add((0,_utils.toUnixPath)(path.join(o,t.module))),t.main&&n.add((0,_utils.toUnixPath)(path.join(o,t.main))),0===n.size&&(n.add((0,_utils.toUnixPath)(path.join(o,"index.js"))),n.add((0,_utils.toUnixPath)(path.join(o,"index.ets"))),n.add((0,_utils.toUnixPath)(path.join(o,"index.ts")))),n}function processNodeModulesFile(e,i,t,o,n,r){var s=getEntryInfo(e,r.resourceResolveData).replace((0,_utils.toUnixPath)(_main.projectConfig.nodeModulesPath),""),s=(0,_utils.toUnixPath)(path.join(_pre_define.PACKAGES,s)).replace(new RegExp(_pre_define.NODE_MODULES,"g"),_pre_define.PACKAGES),r=r.resourceResolveData.descriptionFileData;r&&r.type&&"module"===r.type?(r=new ModuleInfo(e,i,t,o,s,!1),moduleInfos.push(r)):e.endsWith(_pre_define.EXTNAME_MJS)?(r=new ModuleInfo(e,i,t,o,s,!1),moduleInfos.push(r)):(r=new ModuleInfo(e,i,t,o,s,!0),moduleInfos.push(r)),n.push(i),e.endsWith(_pre_define.EXTNAME_JSON)||buildMapFileList.add((0,_utils.toUnixPath)(e.replace(_main.projectConfig.projectRootPath+path.sep,"")))}function processEtsModule(e,i,t,o,n){var r;e.endsWith(_pre_define.EXTNAME_D_ETS)||(t=!0===_main.projectConfig.processTs?(i=i.replace(/\.ets$/,_pre_define.EXTNAME_TS),t.replace(/\.ets$/,_pre_define.EXTNAME_TS)):(i=i.replace(/\.ets$/,_pre_define.EXTNAME_JS),t.replace(/\.ets$/,_pre_define.EXTNAME_JS)),r=(0,_ark_utils.genAbcFileName)(i),(0,_utils.isPackageModulesFile)(e,_main.projectConfig)?processNodeModulesFile(e,i,t,r,o,n):(o=(0,_ark_utils.getPackageInfo)(_main.projectConfig.aceModuleJsonPath)[1],n=new ModuleInfo(e,i,t,r,o,!1),moduleInfos.push(n)),buildMapFileList.add((0,_utils.toUnixPath)(e.replace(_main.projectConfig.projectRootPath+path.sep,""))))}function processTsModule(e,i,t,o,n){var r;e.endsWith(_pre_define.EXTNAME_D_TS)||(!1===_main.projectConfig.processTs&&(i=i.replace(/\.ts$/,_pre_define.EXTNAME_JS),t=t.replace(/\.ts$/,_pre_define.EXTNAME_JS)),r=(0,_ark_utils.genAbcFileName)(i),(0,_utils.isPackageModulesFile)(e,_main.projectConfig)?processNodeModulesFile(e,i,t,r,o,n):(o=(0,_ark_utils.getPackageInfo)(_main.projectConfig.aceModuleJsonPath)[1],n=new ModuleInfo(e,i,t,r,o,!1),moduleInfos.push(n)),buildMapFileList.add((0,_utils.toUnixPath)(e.replace(_main.projectConfig.projectRootPath+path.sep,""))))}function processJsModule(e,i,t,o,n){var r=path.join(i,".."),r=(fs.existsSync(r)&&fs.statSync(r).isDirectory()||mkDir(r),(e.endsWith(_pre_define.EXTNAME_MJS)||e.endsWith(_pre_define.EXTNAME_CJS))&&fs.copyFileSync(e,i),(0,_ark_utils.genAbcFileName)(i));(0,_utils.isPackageModulesFile)(e,_main.projectConfig)?processNodeModulesFile(e,i,t,r,o,n):(o=(0,_ark_utils.getPackageInfo)(_main.projectConfig.aceModuleJsonPath)[1],n=new ModuleInfo(e,i,t,r,o,!1),moduleInfos.push(n)),buildMapFileList.add((0,_utils.toUnixPath)(e.replace(_main.projectConfig.projectRootPath+path.sep,"")))}function processJsonModule(e,i,t,o,n){(0,_utils.isPackageModulesFile)(e,_main.projectConfig)?processNodeModulesFile(e,i,t,"NA",o,n):(o=(0,_ark_utils.getPackageInfo)(_main.projectConfig.aceModuleJsonPath)[1],n=new ModuleInfo(e,i,t,"NA",o,!1),moduleInfos.push(n))}function updateCachedSourceMaps(){var i=this,e=path.join(_process.default.env.cachePath,_pre_define.SOURCEMAPS_JSON);(0,_utils.validateFilePathLength)(e,_compile_info.logger),cachedSourceMaps=fs.existsSync(e)?JSON.parse(fs.readFileSync(e).toString()):{},Object.keys(_ark_utils.newSourceMaps).forEach(function(e){_newArrowCheck(this,i),cachedSourceMaps[e]=_ark_utils.newSourceMaps[e]}.bind(this))}function getCachedModuleList(){var e=path.join(_process.default.env.cachePath,_pre_define.MODULELIST_JSON);return(0,_utils.validateFilePathLength)(e,_compile_info.logger),fs.existsSync(e)?JSON.parse(fs.readFileSync(e).toString()).list:[]}function updateCachedModuleList(e){var i=this,t=path.join(_process.default.env.cachePath,_pre_define.MODULELIST_JSON),o=((0,_utils.validateFilePathLength)(t,_compile_info.logger),path.join(_process.default.env.cachePath,_pre_define.SOURCEMAPS_JSON)),n=((0,_utils.validateFilePathLength)(o,_compile_info.logger),{});n.list=e,fs.writeFile(t,JSON.stringify(n,null,2),"utf-8",function(e){_newArrowCheck(this,i),e&&_compile_info.logger.error(red,"ArkTS:ERROR Failed to write module list.",reset)}.bind(this)),fs.writeFile(o,JSON.stringify(cachedSourceMaps,null,2),"utf-8",function(e){_newArrowCheck(this,i),e&&_compile_info.logger.error(red,"ArkTS:ERROR Failed to write cache sourceMaps json.",reset)}.bind(this))}function writeSourceMaps(){var i=this,e=((0,_utils.mkdirsSync)(_main.projectConfig.buildPath),path.join(_main.projectConfig.buildPath,_pre_define.SOURCEMAPS));(0,_utils.validateFilePathLength)(e,_compile_info.logger),fs.writeFile(e,JSON.stringify(cachedSourceMaps,null,2),"utf-8",function(e){_newArrowCheck(this,i),e&&_compile_info.logger.error(red,"ArkTS:ERROR Failed to write sourceMaps.",reset)}.bind(this))}function eliminateUnusedFiles(i){var t=this,e=getCachedModuleList();0!==e.length&&e.filter(function(e){return _newArrowCheck(this,t),!i.includes(e)}.bind(this)).forEach(function(e){_newArrowCheck(this,t),delete cachedSourceMaps[e]}.bind(this))}function handleFullModuleFiles(e,i){var n=this;const r=[];e.forEach(function(e){if(_newArrowCheck(this,n),void 0!==e&&void 0!==e.resourceResolveData){var i=e.resourceResolveData.path,t=(0,_utils.genTemporaryPath)(i,_main.projectConfig.projectPath,_process.default.env.cachePath,_main.projectConfig);if(0!==t.length){(0,_utils.validateFilePathLength)(t,_compile_info.logger);var o=(0,_ark_utils.genBuildPath)(i,_main.projectConfig.projectPath,_main.projectConfig.buildPath,_main.projectConfig);switch((0,_utils.validateFilePathLength)(o,_compile_info.logger),t=(0,_utils.toUnixPath)(t),o=(0,_utils.toUnixPath)(o),path.extname(i)){case _pre_define.EXTNAME_ETS:processEtsModule(i,t,o,r,e);break;case _pre_define.EXTNAME_TS:processTsModule(i,t,o,r,e);break;case _pre_define.EXTNAME_JS:case _pre_define.EXTNAME_MJS:case _pre_define.EXTNAME_CJS:processJsModule(i,t,o,r,e);break;case _pre_define.EXTNAME_JSON:processJsonModule(i,t,o,r,e);break;default:_compile_info.logger.error(red,"ArkTS:ERROR Cannot find resolve this file path: "+i,reset),_process.default.exitCode=_pre_define.FAIL}}}}.bind(this)),"debug"===_main.projectConfig.buildArkMode&&(e=Array.from(buildMapFileList),updateCachedSourceMaps(),eliminateUnusedFiles(e),updateCachedModuleList(e),writeSourceMaps()),_process.default.env.panda!==_pre_define.TS2ABC?(e=path.join(_main.projectConfig.buildPath,_pre_define.MODULES_ABC),(0,_utils.validateFilePathLength)(e,_compile_info.logger),(0,_gen_merged_abc.generateMergedAbc)(moduleInfos,entryInfos,e),clearGlobalInfo()):invokeWorkersModuleToGenAbc(moduleInfos)}function processEntryToGenAbc(i){if(!(i.size<=0)){(0,_gen_merged_abc.generateNpmEntriesInfo)(i);var i=path.join(_process.default.env.cachePath,_pre_define.NPMENTRIES_TXT),t=((0,_utils.validateFilePathLength)(i,_compile_info.logger),"npm_entries"+_pre_define.EXTNAME_PROTO_BIN),t=path.join(_process.default.env.cachePath,"protos","npm_entries",t);(0,_utils.validateFilePathLength)(t,_compile_info.logger),(0,_utils.mkdirsSync)(path.dirname(t));let e=path.join(arkDir,"build","bin","js2abc");isWin?e=path.join(arkDir,"build-win","bin","js2abc.exe"):isMac&&(e=path.join(arkDir,"build-mac","bin","js2abc")),(0,_utils.validateFilePathLength)(e,_compile_info.logger);i=`"${e}" --compile-npm-entries "${i}" "`+t;try{childProcess.execSync(i)}catch(e){_compile_info.logger.debug(red,"ArkTS:ERROR Failed to generate npm proto file to abc, Error message: "+e,reset)}}}function writeFileSync(e,i,t,o){let n=path.resolve(i,t);(0,_utils.validateFilePathLength)(n,_compile_info.logger);i=path.join(n,"..");fs.existsSync(i)&&fs.statSync(i).isDirectory()||mkDir(i);let r="";if(r=_process.default.env.cachePath?(s=(s=_main.projectConfig.buildPath.split(path.sep))[s.length-1],path.join(_process.default.env.cachePath,_pre_define.TEMPORARY,s,t)):n,(0,_utils.validateFilePathLength)(r,_compile_info.logger),i=path.join(r,".."),fs.existsSync(i)&&fs.statSync(i).isDirectory()||mkDir(i),fs.writeFileSync(r,e),fs.existsSync(r)){var s=fs.statSync(r).size;let e=n.replace(/\.temp\.js$/,"_.js");e=!isDebug&&_main.projectConfig.projectRootPath?(0,_utils.toUnixPath)(e.replace(_main.projectConfig.projectRootPath+path.sep,"")):(0,_utils.toUnixPath)(e),n=(0,_utils.toUnixPath)(n),r=(0,_utils.toUnixPath)(r),intermediateJsBundle.push({path:n,size:s,cacheOutputPath:r,sourceFile:e})}else _compile_info.logger.debug(red,`ArkTS:ERROR Failed to convert file ${o} to bin. ${n} is lost`,reset),_process.default.exitCode=_pre_define.FAIL}function mkDir(e){var i=path.join(e,"..");fs.existsSync(i)&&!fs.statSync(i).isFile()||mkDir(i),fs.mkdirSync(e)}function getSmallestSizeGroup(e){e=Array.from(e);return e.sort(function(e,i){return e[1]-i[1]}),e[0][0]}function splitJsBundlesBySize(i,t){var o=[];if(i.length<t)for(const e of i)o.push([e]);else{i.sort(function(e,i){return i.size-e.size});var n=new Map;for(let e=0;e<t;++e)o.push([]),n.set(e,0);let e=0;for(;e<i.length;){var r=getSmallestSizeGroup(n),s=(o[r].push(i[e]),n.get(r)+i[e].size);n.set(r,s),e++}}return o}function invokeWorkersModuleToGenAbc(e){invokeClusterModuleToAbc()}function initAbcEnv(){let i=[];if("8"===_process.default.env.minPlatformVersion){_process.default.env.panda=_pre_define.TS2ABC;let e=path.join(arkDir,"build","legacy_api8","src","index.js");isWin?e=path.join(arkDir,"build-win","legacy_api8","src","index.js"):isMac&&(e=path.join(arkDir,"build-mac","legacy_api8","src","index.js")),(0,_utils.validateFilePathLength)(e,_compile_info.logger),e='"'+e+'"',i=["--expose-gc",e],isDebug&&i.push("--debug")}else if(_process.default.env.panda===_pre_define.TS2ABC){let e=path.join(arkDir,"build","src","index.js");isWin?e=path.join(arkDir,"build-win","src","index.js"):isMac&&(e=path.join(arkDir,"build-mac","src","index.js")),(0,_utils.validateFilePathLength)(e,_compile_info.logger),e='"'+e+'"',i=["--expose-gc",e],isDebug&&i.push("--debug")}else if(_process.default.env.panda===_pre_define.ES2ABC||"undefined"===_process.default.env.panda||void 0===_process.default.env.panda){let e=path.join(arkDir,"build","bin","es2abc");isWin?e=path.join(arkDir,"build-win","bin","es2abc.exe"):isMac&&(e=path.join(arkDir,"build-mac","bin","es2abc")),(0,_utils.validateFilePathLength)(e,_compile_info.logger),i=['"'+e+'"'],isDebug&&i.push("--debug-info"),_main.projectConfig.compileMode===_pre_define.ESMODULE&&i.push("--merge-abc")}else _compile_info.logger.error(red,"ArkTS:ERROR please set panda module",reset);return i}function invokeClusterModuleToAbc(){"true"===_process.default.env.watchMode&&(_process.default.exitCode=_pre_define.SUCCESS),filterIntermediateModuleByHashJson(buildPathInfo,moduleInfos);var e=initAbcEnv(),i=splitModulesByNumber(filterModuleInfos,_pre_define.MAX_WORKER_NUMBER),e=nodeJs+" "+e.join(" "),t=_pre_define.MAX_WORKER_NUMBER<i.length?_pre_define.MAX_WORKER_NUMBER:i.length;try{("true"===_process.default.env.watchMode?processWorkersOfPreviewMode:processWorkersOfBuildMode)(i,e,t)}catch(e){_compile_info.logger.debug(red,"ArkTS:ERROR failed to generate abc. Error message: "+e,reset),_process.default.env.abcCompileSuccess="false","true"!==_process.default.env.watchMode&&_process.default.exit(_pre_define.FAIL)}}function splitModulesByNumber(i,t){var o=[];if(i.length<t)for(const e of i)o.push([e]);else{for(let e=0;e<t;++e)o.push([]);for(let e=0;e<i.length;e++)o[e%t].push(i[e])}return o}function invokeWorkersToGenAbc(){"true"===_process.default.env.watchMode&&(_process.default.exitCode=_pre_define.SUCCESS);let e="";var i=initAbcEnv(),i=(_process.default.env.panda===_pre_define.TS2ABC?e=nodeJs+" "+i.join(" "):_compile_info.logger.error(red,"ArkTS:ERROR please set panda module",reset),filterIntermediateJsBundleByHashJson(buildPathInfo,intermediateJsBundle),splitJsBundlesBySize(fileterIntermediateJsBundle,_pre_define.MAX_WORKER_NUMBER)),t=_pre_define.MAX_WORKER_NUMBER<i.length?_pre_define.MAX_WORKER_NUMBER:i.length;try{("true"===_process.default.env.watchMode?processWorkersOfPreviewMode:processWorkersOfBuildMode)(i,e,t)}catch(e){_compile_info.logger.debug(red,"ArkTS:ERROR failed to generate abc. Error message: "+e,reset),_process.default.env.abcCompileSuccess="false","true"!==_process.default.env.watchMode&&_process.default.exit(_pre_define.FAIL)}}function filterIntermediateModuleByHashJson(e,i){var o=this;const n=Array();i.forEach(function(i){var t=this,e=(_newArrowCheck(this,o),n.every(function(e){return _newArrowCheck(this,t),i.tempFilePath!==e.tempFilePath}.bind(this)));e&&n.push(i)}.bind(this)),i=n;for(let e=0;e<i.length;++e)filterModuleInfos.push(i[e]);e=genHashJsonPath(e);if(0!==e.length){var t,r={};if(fs.existsSync(e)){e=fs.readFileSync(e).toString(),t=JSON.parse(e),filterModuleInfos=[];for(let e=0;e<i.length;++e){var s,a,l=i[e].tempFilePath,c=(0,_ark_utils.genProtoFileName)(i[e].tempFilePath);if(!fs.existsSync(l)){_compile_info.logger.debug(red,`ArkTS:ERROR ${l} is lost`,reset),_process.default.exitCode=_pre_define.FAIL;break}fs.existsSync(c)&&(s=(0,_utils.toHashData)(l),a=(0,_utils.toHashData)(c),t[l]===s)&&t[c]===a?(r[l]=s,r[c]=a):filterModuleInfos.push(i[e])}}moduleHashJsonObject=r}}function writeModuleHashJson(){for(let e=0;e<filterModuleInfos.length;++e){var i=filterModuleInfos[e].tempFilePath,t=(0,_ark_utils.genProtoFileName)(filterModuleInfos[e].tempFilePath);if(!fs.existsSync(i)||!fs.existsSync(t)){_compile_info.logger.debug(red,`ArkTS:ERROR ${i} is lost`,reset),_process.default.exitCode=_pre_define.FAIL;break}var o=(0,_utils.toHashData)(i),n=(0,_utils.toHashData)(t);moduleHashJsonObject[i]=o,moduleHashJsonObject[t]=n}var e=genHashJsonPath(buildPathInfo);0!==e.length&&fs.writeFileSync(e,JSON.stringify(moduleHashJsonObject))}function filterIntermediateJsBundleByHashJson(e,i){i=removeDuplicateInfoOfBundleList(i);for(let e=0;e<i.length;++e)fileterIntermediateJsBundle.push(i[e]);e=genHashJsonPath(e);if(0!==e.length){var t,o={};if(fs.existsSync(e)){e=fs.readFileSync(e).toString(),t=JSON.parse(e),fileterIntermediateJsBundle=[];for(let e=0;e<i.length;++e){var n,r,s=i[e].cacheOutputPath,a=s.replace(/\.temp\.js$/,".abc");if(!fs.existsSync(s)){_compile_info.logger.debug(red,`ArkTS:ERROR ${s} is lost`,reset),_process.default.exitCode=_pre_define.FAIL;break}fs.existsSync(a)&&(n=(0,_utils.toHashData)(s),r=(0,_utils.toHashData)(a),t[s]===n)&&t[a]===r?(o[s]=n,o[a]=r):fileterIntermediateJsBundle.push(i[e])}}hashJsonObject=o}}function writeHashJson(){for(let e=0;e<fileterIntermediateJsBundle.length;++e){var i=fileterIntermediateJsBundle[e].cacheOutputPath,t=i.replace(/\.temp\.js$/,".abc");if(!fs.existsSync(i)||!fs.existsSync(t)){_compile_info.logger.debug(red,`ArkTS:ERROR ${i} is lost`,reset),_process.default.exitCode=_pre_define.FAIL;break}var o=(0,_utils.toHashData)(i),n=(0,_utils.toHashData)(t);hashJsonObject[i]=o,hashJsonObject[t]=n}var e=genHashJsonPath(buildPathInfo);0!==e.length&&fs.writeFileSync(e,JSON.stringify(hashJsonObject))}function genHashJsonPath(e){var i;return e=(0,_utils.toUnixPath)(e),_process.default.env.cachePath?fs.existsSync(_process.default.env.cachePath)&&fs.statSync(_process.default.env.cachePath).isDirectory()?(i=(i=_main.projectConfig.buildPath.split(path.sep))[i.length-1],i=path.join(_process.default.env.cachePath,_pre_define.TEMPORARY,i,hashFile),(0,_utils.validateFilePathLength)(i,_compile_info.logger),(0,_utils.mkdirsSync)(path.dirname(i)),i):(_compile_info.logger.debug(red,"ArkTS:ERROR hash path does not exist",reset),""):0<=e.indexOf(ARK)?(i=e.split(ARK),e=path.join(i[0],ARK),fs.existsSync(e)&&fs.statSync(e).isDirectory()?(i=path.join(e,hashFile),(0,_utils.validateFilePathLength)(i,_compile_info.logger),i):(_compile_info.logger.debug(red,"ArkTS:ERROR hash path does not exist",reset),"")):(_compile_info.logger.debug(red,"ArkTS:ERROR not cache exist",reset),"")}function checkNodeModules(){if(_process.default.env.panda===_pre_define.TS2ABC){let e=path.join(arkDir,"build");isWin?e=path.join(arkDir,"build-win"):isMac&&(e=path.join(arkDir,"build-mac"));var i=path.join(e,_pre_define.NODE_MODULES);if((0,_utils.validateFilePathLength)(i,_compile_info.logger),!fs.existsSync(i)||!fs.statSync(i).isDirectory())return _compile_info.logger.error(red,`ERROR: node_modules for ark compiler not found.
        Please make sure switch to non-root user before runing "npm install" for safity requirements and try re-run "npm install" under `+e,reset),!1}return!0}function copyFileCachePathToBuildPath(){for(let e=0;e<intermediateJsBundle.length;++e){var i=intermediateJsBundle[e].path.replace(/\.temp\.js$/,".abc"),t=intermediateJsBundle[e].cacheOutputPath,o=intermediateJsBundle[e].cacheOutputPath.replace(/\.temp\.js$/,".abc");if(!fs.existsSync(o)){_compile_info.logger.debug(red,`ArkTS:ERROR ${o} is lost`,reset),_process.default.exitCode=_pre_define.FAIL;break}var n=path.join(i,"..");fs.existsSync(n)&&fs.statSync(n).isDirectory()||mkDir(n),void 0!==_process.default.env.cachePath&&fs.copyFileSync(o,i),void 0===_process.default.env.cachePath&&fs.existsSync(t)&&fs.unlinkSync(t)}}function processExtraAsset(){_main.projectConfig.compileMode===_pre_define.JSBUNDLE||void 0===_main.projectConfig.compileMode?(writeHashJson(),copyFileCachePathToBuildPath()):_main.projectConfig.compileMode===_pre_define.ESMODULE&&(processEntryToGenAbc(entryInfos),writeModuleHashJson(),copyModuleFileCachePathToBuildPath(),mergeProtoToAbc()),clearGlobalInfo()}function handleHotReloadChangedFiles(){if(fs.existsSync(_main.projectConfig.changedFileList)){var e=fs.readFileSync(_main.projectConfig.changedFileList).toString(),e=JSON.parse(e).modifiedFiles;if(void 0!==e&&0!=e.length){var i,t=_main.projectConfig.projectPath.slice(_main.projectConfig.projectRootPath.length+path.sep.length),o=[],n={};moduleInfos=[];for(i of e){var r=path.join(_main.projectConfig.projectPath,i);if((0,_utils.validateFilePathLength)(r,_compile_info.logger),0===(s=(0,_utils.genTemporaryPath)(r,_main.projectConfig.projectPath,_process.default.env.cachePath,_main.projectConfig)).length)return;(0,_utils.validateFilePathLength)(s,_compile_info.logger);var s=(0,_utils.toUnixPath)(s);switch(path.extname(r)){case _pre_define.EXTNAME_ETS:processEtsModule(r,s,"",o,void 0);break;case _pre_define.EXTNAME_TS:processTsModule(r,s,"",o,void 0);break;case _pre_define.EXTNAME_JS:case _pre_define.EXTNAME_MJS:case _pre_define.EXTNAME_CJS:processJsModule(r,s,"",o,void 0);break;case _pre_define.EXTNAME_JSON:return void _compile_info.logger.debug(blue,`ArkTS: json source file: ${r} changed, skip hot reload build`,reset);default:return void _compile_info.logger.debug(blue,`ArkTS:ERROR Cannot resolve file path: ${r}, stop hot reload build`,reset)}var a=(0,_utils.toUnixPath)(path.join(t,i));(0,_utils.validateFilePathLength)(a,_compile_info.logger),n[a]=_ark_utils.newSourceMaps[a]}fs.existsSync(_main.projectConfig.patchAbcPath)||(0,_utils.mkdirsSync)(_main.projectConfig.patchAbcPath);e=path.join(_main.projectConfig.patchAbcPath,_pre_define.MODULES_ABC),e=((0,_utils.validateFilePathLength)(e,_compile_info.logger),(0,_gen_merged_abc.generateMergedAbc)(moduleInfos,entryInfos,e),path.join(_main.projectConfig.patchAbcPath,_pre_define.SOURCEMAPS));(0,_utils.validateFilePathLength)(e,_compile_info.logger),fs.writeFileSync(e,JSON.stringify(n,null,2),"utf-8")}}else _compile_info.logger.debug(blue,`ArkTS: Cannot find file: ${_main.projectConfig.changedFileList}, skip hot reload build`,reset)}function handleFinishModules(e,i){_main.projectConfig.hotReload&&!isHotReloadFirstBuild?handleHotReloadChangedFiles():(handleFullModuleFiles(e,i),_main.projectConfig.hotReload&&(isHotReloadFirstBuild=!1))}function copyModuleFileCachePathToBuildPath(){var e,t=this;protoFilePath=path.join(path.join(_process.default.env.cachePath,"protos",_pre_define.PROTO_FILESINFO_TXT)),(0,_utils.validateFilePathLength)(protoFilePath,_compile_info.logger),(0,_utils.mkdirsSync)(path.dirname(protoFilePath));let i="";(moduleInfos=(0,_ark_utils.removeDuplicateInfo)(moduleInfos)).sort(function(e,i){return _newArrowCheck(this,t),e.tempFilePath<i.tempFilePath?1:-1}.bind(this));for(let e=0;e<moduleInfos.length;++e){var o=(0,_ark_utils.genProtoFileName)(moduleInfos[e].tempFilePath);i+=(0,_utils.toUnixPath)(o)+`
`}0<entryInfos.size&&(e="npm_entries"+_pre_define.EXTNAME_PROTO_BIN,e=path.join(_process.default.env.cachePath,"protos","npm_entries",e),i+=(0,_utils.toUnixPath)(e)+`
`),fs.writeFileSync(protoFilePath,i,"utf-8")}function mergeProtoToAbc(){let e=path.join(arkDir,"build","bin","merge_abc");isWin?e=path.join(arkDir,"build-win","bin","merge_abc.exe"):isMac&&(e=path.join(arkDir,"build-mac","bin","merge_abc")),(0,_utils.mkdirsSync)(_main.projectConfig.buildPath);var i=`"${e}" --input "@${protoFilePath}" --outputFilePath "${_main.projectConfig.buildPath}" --output ${_pre_define.MODULES_ABC} --suffix protoBin`;try{childProcess.execSync(i)}catch(e){_compile_info.logger.debug(red,"ArkTS:ERROR Failed to merge proto file to abc. Error message: "+e,reset)}}function generateAbcByEs2AbcOfBundleMode(e){var t=this;if(filterIntermediateJsBundleByHashJson(buildPathInfo,e),0===fileterIntermediateJsBundle.length)processExtraAsset();else{let i=generateFileOfBundle(fileterIntermediateJsBundle);var o,e=_os.default.cpus().length<16?_os.default.cpus().length:16,e=`${initAbcEnv().join(" ")} "@${i}" --file-threads "${e}"`;_compile_info.logger.debug("gen abc cmd is: ",e);try{"true"===_process.default.env.watchMode?(childProcess.execSync(e),processExtraAsset()):((o=childProcess.exec(e)).on("exit",function(e){_newArrowCheck(this,t),e===_pre_define.FAIL&&(_compile_info.logger.debug(red,"ArkTS:ERROR failed to execute es2abc",reset),_process.default.exit(_pre_define.FAIL)),void 0===_process.default.env.cachePath&&(0,_utils.unlinkSync)(i),processExtraAsset()}.bind(this)),o.on("error",function(e){_newArrowCheck(this,t),_compile_info.logger.debug(red,e.toString(),reset),_process.default.exit(_pre_define.FAIL)}.bind(this)),o.stderr.on("data",function(e){_newArrowCheck(this,t),_compile_info.logger.error(red,e.toString(),reset)}.bind(this)))}catch(e){_compile_info.logger.debug(red,`ArkTS:ERROR failed to generate abc with filesInfo ${i}. Error message: ${e} `,reset),_process.default.env.abcCompileSuccess="false","true"!==_process.default.env.watchMode&&_process.default.exit(_pre_define.FAIL)}finally{"true"===_process.default.env.watchMode&&void 0===_process.default.env.cachePath&&(0,_utils.unlinkSync)(i)}}}function generateFileOfBundle(e){var o=this,i=(0,_ark_utils.buildCachePath)(_pre_define.FILESINFO_TXT,_main.projectConfig,_compile_info.logger);e=removeDuplicateInfoOfBundleList(e);let n="";return e.forEach(function(e){_newArrowCheck(this,o);var i=e.cacheOutputPath,e=e.sourceFile,t=i.replace(/\.temp\.js$/,".abc");n+=i+`;null_recordName;script;${e};${t}
`}.bind(this)),fs.writeFileSync(i,n,"utf-8"),i}function removeDuplicateInfoOfBundleList(e){var o=this;const n=Array();return e.forEach(function(i){var t=this,e=(_newArrowCheck(this,o),n.every(function(e){return _newArrowCheck(this,t),i.path!==e.path}.bind(this)));e&&n.push(i)}.bind(this)),e=n}function processWorkersOfPreviewMode(e,i,t){var o=Object.assign({},_process.default.env),e={splittedData:JSON.stringify(e),cmdPrefix:i,workerNumber:t.toString()},i=(_main.projectConfig.compileMode===_pre_define.JSBUNDLE||void 0===_main.projectConfig.compileMode?e.mode=_pre_define.JSBUNDLE:_main.projectConfig.compileMode===_pre_define.ESMODULE&&(e.cachePath=_process.default.env.cachePath,e.mode=_pre_define.ESMODULE),o.arkEnvParams=JSON.stringify(e),`${nodeJs} "${path.resolve(__dirname,_pre_define.MANAGE_WORKERS_SCRIPT)}"`);childProcess.execSync(i,{env:o}),processExtraAsset()}function processWorkersOfBuildMode(i,t,o){var r=this,n=(0,_utils.nodeLargeOrEqualTargetVersion)(16);if(n&&_cluster.default.isPrimary||!n&&_cluster.default.isMaster){let e=_pre_define.GEN_ABC_SCRIPT;_main.projectConfig.compileMode===_pre_define.ESMODULE&&(e=_pre_define.GEN_MODULE_ABC_SCRIPT),n?_cluster.default.setupPrimary({exec:path.resolve(__dirname,e)}):_cluster.default.setupMaster({exec:path.resolve(__dirname,e)});for(let e=0;e<o;++e){var s,a={inputs:JSON.stringify(i[e]),cmd:t};_main.projectConfig.compileMode===_pre_define.ESMODULE&&(s=e+1,a.workerFileName=`filesInfo_${s}.txt`,a.cachePath=_process.default.env.cachePath),_cluster.default.fork(a)}_cluster.default.on("exit",function(e,i,t){_newArrowCheck(this,r),i===_pre_define.FAIL&&(_process.default.exitCode=_pre_define.FAIL),_compile_info.logger.debug(`worker ${e.process.pid} finished`)}.bind(this)),_process.default.on("exit",function(e){var i,t,o,n=this;_newArrowCheck(this,r),_process.default.exitCode!==_pre_define.FAIL&&"true"!==_process.default.env.watchMode&&(processExtraAsset(),_main.projectConfig.compileMode!==_pre_define.ESMODULE||_main.projectConfig.anBuildMode!==_pre_define.AOT_FULL&&_main.projectConfig.anBuildMode!==_pre_define.AOT_PARTIAL||(i=function(e){_newArrowCheck(this,n),_compile_info.logger.error(e),_process.default.exit(_pre_define.FAIL)}.bind(this),(t=initAbcEnv()).unshift(nodeJs),t=(0,_gen_aot.generateBuiltinAbc)(arkDir,t,_process.default.env.cachePath,_compile_info.logger,i,_main.projectConfig.pandaMode),o=path.join(_main.projectConfig.buildPath,_pre_define.MODULES_ABC),(0,_gen_aot.generateAot)(arkDir,t,o,_main.projectConfig,_compile_info.logger,i)))}.bind(this))}}exports.GenAbcPlugin=GenAbcPlugin;