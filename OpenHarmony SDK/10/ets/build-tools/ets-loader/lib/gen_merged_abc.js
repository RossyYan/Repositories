"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.generateMergedAbc=generateMergedAbc,exports.generateNpmEntriesInfo=generateNpmEntriesInfo;var fs=_interopRequireWildcard(require("fs")),path=_interopRequireWildcard(require("path")),os=_interopRequireWildcard(require("os")),childProcess=_interopRequireWildcard(require("child_process")),process=_interopRequireWildcard(require("process")),_compile_info=require("./compile_info"),_main=require("../main"),_pre_define=require("./pre_define"),_gen_abc_plugin=require("./gen_abc_plugin"),_utils=require("./utils");function _getRequireWildcardCache(e){var t,i;return"function"!=typeof WeakMap?null:(t=new WeakMap,i=new WeakMap,(_getRequireWildcardCache=function(e){return e?i:t})(e))}function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};t=_getRequireWildcardCache(t);if(t&&t.has(e))return t.get(e);var i,r,n={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&((r=o?Object.getOwnPropertyDescriptor(e,i):null)&&(r.get||r.set)?Object.defineProperty(n,i,r):n[i]=e[i]);return n.default=e,t&&t.set(e,n),n}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}const red="[31m",reset="[39m";function generateCompileFilesInfo(e){var r=this;const n=Array();e.forEach(function(t){var i=this,e=(_newArrowCheck(this,r),n.every(function(e){return _newArrowCheck(this,i),t.tempFilePath!==e.tempFilePath}.bind(this)));e&&n.push(t)}.bind(this)),e=n;var t=path.join(process.env.cachePath,_pre_define.FILESINFO_TXT);(0,_utils.validateFilePathLength)(t,_compile_info.logger);let o="";e.forEach(function(e){_newArrowCheck(this,r);var t=e.isCommonJs?"commonjs":"esm",i=e.filePath.replace(_main.projectConfig.projectRootPath+path.sep,"");o+=`${e.tempFilePath};${e.recordName};${t};${(0,_utils.toUnixPath)(i)};${e.packageName}\n`}.bind(this)),fs.writeFileSync(t,o,"utf-8")}function generateNpmEntriesInfo(e){var t=path.join(process.env.cachePath,_pre_define.NPMENTRIES_TXT);(0,_utils.validateFilePathLength)(t,_compile_info.logger);let i="";for(const o of e.values()){var r=o.buildPath.replace((0,_utils.toUnixPath)(_main.projectConfig.nodeModulesPath),"").replace(new RegExp(_pre_define.NODE_MODULES,"g"),_pre_define.PACKAGES),n=(0,_utils.toUnixPath)(path.join(r,o.entry)),n=n.substring(0,n.lastIndexOf(".")).replace(new RegExp(_pre_define.NODE_MODULES,"g"),_pre_define.PACKAGES);i+=`${(0,_utils.toUnixPath)(path.join(_pre_define.PACKAGES,r))}:${(0,_utils.toUnixPath)(path.join(_pre_define.PACKAGES,n))}\n`}fs.writeFileSync(t,i,"utf-8")}function generateAbcCacheFilesInfo(e,t,i){var r=this;let n="";e.forEach(function(e){_newArrowCheck(this,r);var t=e.tempFilePath.substring(0,e.tempFilePath.lastIndexOf("."))+_pre_define.EXTNAME_PROTO_BIN;n+=e.tempFilePath+`;${t}
`}.bind(this));e=t.substring(0,t.lastIndexOf("."))+_pre_define.EXTNAME_PROTO_BIN;n+=t+`;${e}
`,fs.writeFileSync(i,n,"utf-8")}function generateMergedAbc(e,t,i){var r,n=this,t=(generateCompileFilesInfo(e),generateNpmEntriesInfo(t),path.join(process.env.cachePath,_pre_define.FILESINFO_TXT)),o=path.join(process.env.cachePath,_pre_define.NPMENTRIES_TXT),a=path.join(process.env.cachePath,_pre_define.MODULES_CACHE),e=((0,_utils.validateFilePathLength)(a,_compile_info.logger),generateAbcCacheFilesInfo(e,o,a),os.cpus().length<16?os.cpus().length:16);(0,_utils.mkdirsSync)(_main.projectConfig.buildPath);let c=(0,_gen_abc_plugin.initAbcEnv)().join(" ")+` "@${t}" --npm-module-entry-list "${o}" --output "${i}" --file-threads "${e}"`;_main.projectConfig.patch=_main.projectConfig.patch||!1,_main.projectConfig.enableMap=_main.projectConfig.enableMap||!1,_main.projectConfig.inOldSymbolTablePath=_main.projectConfig.inOldSymbolTablePath||_main.projectConfig.projectRootPath,_main.projectConfig.patch&&(o=path.join(_main.projectConfig.inOldSymbolTablePath,_pre_define.PATCH_SYMBOL_TABLE),c+=` --input-symbol-table "${o}" --generate-patch`),_main.projectConfig.enableMap?(i=path.join(_main.projectConfig.inOldSymbolTablePath,_pre_define.PATCH_SYMBOL_TABLE),c+=` --dump-symbol-table "${i}"`):c+=` --cache-file "@${a}"`,_compile_info.logger.debug("gen abc cmd is: ",c);try{"true"===process.env.watchMode?childProcess.execSync(c):((r=childProcess.exec(c)).on("exit",function(e){_newArrowCheck(this,n),1===e&&(_compile_info.logger.debug(red,"ArkTS:ERROR failed to execute es2abc",reset),process.exit(_pre_define.FAIL))}.bind(this)),r.on("error",function(e){_newArrowCheck(this,n),_compile_info.logger.debug(red,e.toString(),reset),process.exit(_pre_define.FAIL)}.bind(this)),r.stderr.on("data",function(e){var t,i=this;_newArrowCheck(this,n),_main.projectConfig.patch?(t=e.split(os.EOL).filter(function(e){return _newArrowCheck(this,i),e.includes("[Patch]")||e.includes("Error:")}.bind(this)),_compile_info.logger.error(red,t.join(os.EOL),reset)):_compile_info.logger.error(red,e.toString(),reset)}.bind(this)))}catch(e){_compile_info.logger.debug(red,`ArkTS:ERROR failed to generate abc with filesInfo ${t}. Error message: `+e,reset),process.env.abcCompileSuccess="false","true"!==process.env.watchMode&&process.exit(_pre_define.FAIL)}}