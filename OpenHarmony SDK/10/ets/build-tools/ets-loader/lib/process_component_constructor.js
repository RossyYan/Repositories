"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.addConstructor=addConstructor,exports.getInitConstructor=getInitConstructor,exports.updateConstructor=updateConstructor;var _typescript=_interopRequireDefault(require("typescript")),_pre_define=require("./pre_define"),_main=require("../main");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}function getInitConstructor(e,t){var r=this;let a=e.find(function(e){return _newArrowCheck(this,r),_typescript.default.isConstructorDeclaration(e)}.bind(this));return initConstructorParams(a=a&&updateConstructor(a,[],[],!0),t)}function updateConstructor(e,t,r,a=!1,i=!1,c){let o;t&&t.length&&(o=Array.from(e.parameters))&&o.push(...t);let n;return r&&r.length&&e&&(n=Array.from(e.body.statements))&&(a?n.unshift(...r):n.push(...r)),e&&(o||e.parameters,i&&addParamsType(e,o,c),e=_typescript.default.factory.updateConstructorDeclaration(e,e.decorators,e.modifiers,o||e.parameters,_typescript.default.factory.createBlock(n||e.body.statements,!0))),e}function initConstructorParams(e,t){var r=this;if(_typescript.default.isIdentifier(t)){t=_main.partialUpdateConfig.partialUpdateMode?new Set([_pre_define.COMPONENT_CONSTRUCTOR_PARENT,_pre_define.COMPONENT_CONSTRUCTOR_PARAMS,_pre_define.COMPONENT_CONSTRUCTOR_LOCALSTORAGE_PU,_pre_define.ELMTID,_pre_define.COMPONENT_PARAMS_LAMBDA_FUNCTION]):new Set([_pre_define.COMPONENT_CONSTRUCTOR_ID,_pre_define.COMPONENT_CONSTRUCTOR_PARENT,_pre_define.COMPONENT_CONSTRUCTOR_PARAMS,_pre_define.COMPONENT_CONSTRUCTOR_LOCALSTORAGE]);const a=Array.from(e.parameters);return 0!==a.length&&a.splice(0,a.length),t.forEach(function(e){_newArrowCheck(this,r),a.push(_typescript.default.factory.createParameterDeclaration(void 0,void 0,void 0,_typescript.default.factory.createIdentifier(e),void 0,void 0,e===_pre_define.ELMTID||e===_pre_define.COMPONENT_PARAMS_LAMBDA_FUNCTION?e===_pre_define.ELMTID?_typescript.default.factory.createPrefixUnaryExpression(_typescript.default.SyntaxKind.MinusToken,_typescript.default.factory.createNumericLiteral("1")):_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_IF_UNDEFINED):void 0))}.bind(this)),_typescript.default.factory.updateConstructorDeclaration(e,void 0,e.modifiers,a,e.body)}}function addParamsType(e,t,r){var a=this,t=t||e.parameters;const i=[];return t.forEach(function(e){_newArrowCheck(this,a);let t=e;switch(e.name.escapedText){case _pre_define.COMPONENT_CONSTRUCTOR_ID:t=_typescript.default.factory.updateParameterDeclaration(e,e.decorators,e.modifiers,e.dotDotDotToken,e.name,e.questionToken,_typescript.default.factory.createKeywordTypeNode(_typescript.default.SyntaxKind.StringKeyword),e.initializer);break;case _pre_define.COMPONENT_CONSTRUCTOR_PARENT:t=_typescript.default.factory.createParameterDeclaration(e.decorators,e.modifiers,e.dotDotDotToken,e.name,e.questionToken,_typescript.default.factory.createTypeReferenceNode(_typescript.default.factory.createIdentifier(_main.partialUpdateConfig.partialUpdateMode?_pre_define.BASE_COMPONENT_NAME_PU:_pre_define.BASE_COMPONENT_NAME),void 0),e.initializer);break;case _pre_define.COMPONENT_CONSTRUCTOR_PARAMS:t=_typescript.default.factory.updateParameterDeclaration(e,e.decorators,e.modifiers,e.dotDotDotToken,e.name,e.questionToken,_typescript.default.factory.createTypeReferenceNode(_typescript.default.factory.createIdentifier(r.getText()+_pre_define.INTERFACE_NAME_SUFFIX),void 0),e.initializer);break;case _pre_define.COMPONENT_CONSTRUCTOR_LOCALSTORAGE_PU:t=_typescript.default.factory.createParameterDeclaration(e.decorators,e.modifiers,e.dotDotDotToken,e.name,_typescript.default.factory.createToken(_typescript.default.SyntaxKind.QuestionToken),_typescript.default.factory.createTypeReferenceNode(_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_LOCALSTORAGE_TYPE_PU),void 0),e.initializer)}i.push(t)}.bind(this)),i}function addConstructor(e,t,r){var a=this;const i=[];t.forEach(function(e,t){_newArrowCheck(this,a);t=_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createThis(),_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_WATCH_FUNCTION)),void 0,[_typescript.default.factory.createStringLiteral(t),_typescript.default.isStringLiteral(e)?_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createThis(),_typescript.default.factory.createIdentifier(e.text)):e]));i.push(t)}.bind(this));var t=createCallSuperStatement(),c=createUPdWithValStatement();return updateConstructor(updateConstructor(e,[],[t],!0),[],[c,...i],!1,!0,r)}function createCallSuperStatement(){return _main.partialUpdateConfig.partialUpdateMode?_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createSuper(),void 0,[_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_PARENT),_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_LOCALSTORAGE_PU),_typescript.default.factory.createIdentifier(_pre_define.ELMTID)])):_typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createSuper(),void 0,[_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_ID),_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_PARENT),_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_LOCALSTORAGE)]))}function createUPdWithValStatement(){return _typescript.default.factory.createExpressionStatement(_typescript.default.factory.createCallExpression(_typescript.default.factory.createPropertyAccessExpression(_typescript.default.factory.createThis(),_typescript.default.factory.createIdentifier(_main.partialUpdateConfig.partialUpdateMode?_pre_define.COMPONENT_CONSTRUCTOR_INITIAL_PARAMS:_pre_define.COMPONENT_CONSTRUCTOR_UPDATE_PARAMS)),void 0,[_typescript.default.factory.createIdentifier(_pre_define.COMPONENT_CONSTRUCTOR_PARAMS)]))}