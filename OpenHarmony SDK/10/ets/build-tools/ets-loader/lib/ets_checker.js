"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.compilerOptions=exports.checkerResult=exports.cache=exports.appComponentCollection=exports.SOURCE_FILES=void 0,exports.createLanguageService=createLanguageService,exports.createWatchCompilerHost=createWatchCompilerHost,exports.dollarCollection=exports.decoratorParamsCollection=void 0,exports.etsStandaloneChecker=etsStandaloneChecker,exports.files=exports.fastBuildLogger=exports.extendCollection=void 0,exports.getArkTSLinterMode=getArkTSLinterMode,exports.importModuleCollection=exports.hotReloadSupportFiles=void 0,exports.incrementWatchFile=incrementWatchFile,exports.instanceInsteadThis=instanceInsteadThis,exports.isStandardMode=isStandardMode,exports.languageService=void 0,exports.printDiagnostic=printDiagnostic,exports.readDeaclareFiles=readDeaclareFiles,exports.resolveModuleNames=resolveModuleNames,exports.resolveTypeReferenceDirectives=resolveTypeReferenceDirectives,exports.serviceChecker=serviceChecker,exports.warnCheckerResult=exports.shouldResolvedFiles=void 0,exports.watchChecker=watchChecker;var _fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),ts=_interopRequireWildcard(require("typescript")),_main=require("../main"),_validate_ui_syntax=require("./validate_ui_syntax"),_pre_define=require("./pre_define"),_process_component_build=require("./process_component_build"),_component_map=require("./component_map"),_compile_info=require("./compile_info"),_utils=require("./utils"),_process_ui_syntax=require("./process_ui_syntax"),_process_visual=require("./process_visual"),_rollupPluginEtsChecker=require("./fast_build/ets_ui/rollup-plugin-ets-checker"),_do_arkTS_linter=require("./do_arkTS_linter");function _getRequireWildcardCache(e){var t,r;return"function"!=typeof WeakMap?null:(t=new WeakMap,r=new WeakMap,(_getRequireWildcardCache=function(e){return e?r:t})(e))}function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};t=_getRequireWildcardCache(t);if(t&&t.has(e))return t.get(e);var r,o,s={},i=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&((o=i?Object.getOwnPropertyDescriptor(e,r):null)&&(o.get||o.set)?Object.defineProperty(s,r,o):s[r]=e[r]);return s.default=e,t&&t.set(e,s),s}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}const fse=require("fs-extra"),SOURCE_FILES=new Map;function collectSourceFilesMap(e){var t=this;e.getSourceFiles().forEach(function(e){_newArrowCheck(this,t),SOURCE_FILES.set(_path.default.normalize(e.fileName),e)}.bind(this))}function readDeaclareFiles(){var t=this;const r=[];return _fs.default.readdirSync(_path.default.resolve(__dirname,"../declarations")).forEach(function(e){_newArrowCheck(this,t),/\.d\.ts$/.test(e)&&r.push(_path.default.resolve(__dirname,"../declarations",e))}.bind(this)),r}exports.SOURCE_FILES=SOURCE_FILES;const compilerOptions=ts.readConfigFile(_path.default.resolve(__dirname,"../tsconfig.json"),ts.sys.readFile).config.compilerOptions;function setCompilerOptions(e){var t=this;const r=["*"],o=_path.default.resolve(_main.projectConfig.projectPath);"rollup"===process.env.compileTool&&e&&e.length?e.forEach(function(e){_newArrowCheck(this,t),/oh_modules$/.test(e)||/node_modules$/.test(e)||r.push(_path.default.join(_path.default.relative(o,e),"*"))}.bind(this)):_main.projectConfig.aceModuleJsonPath?(r.push("../../../../*"),r.push("../*")):(r.push("../../../../../*"),r.push("../../*")),Object.assign(compilerOptions,{allowJs:!1,emitNodeModulesFiles:!0,importsNotUsedAsValues:ts.ImportsNotUsedAsValues.Preserve,module:ts.ModuleKind.CommonJS,moduleResolution:ts.ModuleResolutionKind.NodeJs,noEmit:!0,target:ts.ScriptTarget.ES2017,baseUrl:o,paths:{"*":r},lib:["lib.es2020.d.ts"],types:_main.projectConfig.compilerTypes,etsLoaderPath:_main.projectConfig.etsLoaderPath,needDoArkTsLinter:getArkTSLinterMode()!==_do_arkTS_linter.ArkTSLinterMode.NOT_USE,isCompatibleVersion:getArkTSLinterMode()===_do_arkTS_linter.ArkTSLinterMode.COMPATIBLE_MODE}),_main.projectConfig.compileMode===_pre_define.ESMODULE&&Object.assign(compilerOptions,{importsNotUsedAsValues:ts.ImportsNotUsedAsValues.Remove,module:ts.ModuleKind.ES2020}),"oh_modules"===_main.projectConfig.packageDir&&Object.assign(compilerOptions,{packageManagerType:"ohpm"})}function getInitCheckConfig(e,t){return{tagName:e,message:t,needConditionCheck:!1,type:ts.DiagnosticCategory.Error,specifyCheckConditionFuncName:"",tagNameShouldExisted:!0}}function getCheckJSDocTagNameConfig(e,t){let r=!1;var o=[];return(_main.ohosSystemModulePaths.includes(_path.default.normalize(t))||isArkuiDependence(t))&&(isCardFile(e)&&(r=!0,o.push(getInitCheckConfig("form","'{0}' can't support form application."))),_main.projectConfig.isCrossplatform)&&(r=!0,o.push(getInitCheckConfig("crossplatform","'{0}' can't support crossplatform application."))),{needCheck:r,checkConfig:o}}exports.compilerOptions=compilerOptions;const files={};function createLanguageService(e,t){var r=this,t=(setCompilerOptions(t),e.forEach(function(e){_newArrowCheck(this,r),files[e]={version:0}}.bind(this)),{getScriptFileNames:function(){return _newArrowCheck(this,r),[...e,...readDeaclareFiles()]}.bind(this),getScriptVersion:function(e){return _newArrowCheck(this,r),files[_path.default.resolve(e)]||(files[_path.default.resolve(e)]={version:0}),files[_path.default.resolve(e)].version.toString()}.bind(this),getScriptSnapshot:function(e){var t;if(_newArrowCheck(this,r),_fs.default.existsSync(e))return/(?<!\.d)\.(ets|ts)$/.test(e)?(appComponentCollection.set(_path.default.join(e),new Set),t=instanceInsteadThis(t=processContent(_fs.default.readFileSync(e).toString(),e),e,[]),ts.ScriptSnapshot.fromString(t)):ts.ScriptSnapshot.fromString(_fs.default.readFileSync(e).toString())}.bind(this),getCurrentDirectory:function(){return _newArrowCheck(this,r),process.cwd()}.bind(this),getCompilationSettings:function(){return _newArrowCheck(this,r),compilerOptions}.bind(this),getDefaultLibFileName:function(e){return _newArrowCheck(this,r),ts.getDefaultLibFilePath(e)}.bind(this),fileExists:ts.sys.fileExists,readFile:ts.sys.readFile,readDirectory:ts.sys.readDirectory,resolveModuleNames:resolveModuleNames,resolveTypeReferenceDirectives:resolveTypeReferenceDirectives,directoryExists:ts.sys.directoryExists,getDirectories:ts.sys.getDirectories,getTagNameNeededCheckByFile:function(e,t){return _newArrowCheck(this,r),getCheckJSDocTagNameConfig(e,t)}.bind(this)});return ts.createLanguageService(t,ts.createDocumentRegistry())}exports.files=files;let cache={};exports.cache=cache;const hotReloadSupportFiles=new Set,shouldResolvedFiles=(exports.hotReloadSupportFiles=hotReloadSupportFiles,new Set),appComponentCollection=(exports.shouldResolvedFiles=shouldResolvedFiles,new Map),allResolvedModules=(exports.appComponentCollection=appComponentCollection,new Set);let fastBuildLogger=null;exports.fastBuildLogger=fastBuildLogger;const checkerResult={count:0},warnCheckerResult=(exports.checkerResult=checkerResult,{count:0});exports.warnCheckerResult=warnCheckerResult;let languageService=null;function serviceChecker(e,t=null,r=null){var o=this;exports.fastBuildLogger=fastBuildLogger=t;let s=null;_main.projectConfig.xtsMode||"true"===process.env.watchMode?(_main.projectConfig.hotReload&&e.forEach(function(e){_newArrowCheck(this,o),hotReloadSupportFiles.add(e)}.bind(this)),exports.languageService=languageService=createLanguageService(e,r)):(s=_path.default.resolve(_main.projectConfig.cachePath,"../.ts_checker_cache"),(t=_fs.default.existsSync(s)?JSON.parse(_fs.default.readFileSync(s).toString()):{runtimeOS:_main.projectConfig.runtimeOS,sdkInfo:_main.projectConfig.sdkInfo,fileList:{}}).runtimeOS===_main.projectConfig.runtimeOS&&t.sdkInfo===_main.projectConfig.sdkInfo?exports.cache=cache=t.fileList:exports.cache=cache={},t=filterInput(e),exports.languageService=languageService=createLanguageService(t,r)),_main.globalProgram.program=languageService.getProgram(),runArkTSLinter(),collectSourceFilesMap(_main.globalProgram.program),"true"!==process.env.watchMode&&processBuildHap(s,e)}function processBuildHap(e,t){var r=this;_main.globalProgram.program.getSyntacticDiagnostics().concat(_main.globalProgram.program.getSemanticDiagnostics()).concat(_main.globalProgram.program.getDeclarationDiagnostics()).forEach(function(e){_newArrowCheck(this,r),printDiagnostic(e)}.bind(this)),_main.projectConfig.xtsMode||(fse.ensureDirSync(_main.projectConfig.cachePath),_fs.default.writeFileSync(e,JSON.stringify({runtimeOS:_main.projectConfig.runtimeOS,sdkInfo:_main.projectConfig.sdkInfo,fileList:cache},null,2))),(_main.projectConfig.compileHar||_main.projectConfig.compileShared)&&[...allResolvedModules,...t].forEach(function(e){if(_newArrowCheck(this,r),!e.match(new RegExp(_main.projectConfig.packageDir))||!_main.projectConfig.compileHar)try{var t;/\.d\.e?ts$/.test(e)?(0,_utils.generateSourceFilesInHar)(e,_fs.default.readFileSync(e,"utf-8"),_path.default.extname(e),_main.projectConfig):(t=languageService.getEmitOutput(e,!0,!0)).outputFiles[0]?(0,_utils.generateSourceFilesInHar)(e,t.outputFiles[0].text,".d"+_path.default.extname(e),_main.projectConfig):console.warn(this.yellow,"ArkTS:WARN doesn't generate .d"+_path.default.extname(e)+" for "+e,this.reset)}catch(e){}}.bind(this))}function isArkuiDependence(e){return/compiler\/declarations/.test(e)||/ets-loader\/declarations/.test(e)}function isCardFile(e){for(const t in _main.projectConfig.cardEntryObj)if(_path.default.normalize(_main.projectConfig.cardEntryObj[t])===_path.default.normalize(e))return!0;return!1}function containFormError(e){return!!/can't support form application./.test(e)}function printDiagnostic(t){var r=ts.flattenDiagnosticMessageText(t.messageText,"\n");if(validateError(r)&&("true"===process.env.watchMode||_main.projectConfig.xtsMode||updateErrorFileCache(t),!containFormError(r)||isCardFile(t.file.fileName))){var o,s,i=t.category===ts.DiagnosticCategory.Error?"ERROR":"WARN",n=fastBuildLogger||_compile_info.logger;let e;"ERROR"==i?checkerResult.count+=1:warnCheckerResult.count+=1,e=t.file?({line:o,character:s}=t.file.getLineAndCharacterOfPosition(t.start),`ArkTS:${i} File: ${t.file.fileName}:${o+1}:${s+1}
 ${r}
`):`ArkTS:${i}: `+r,t.category===ts.DiagnosticCategory.Error?n.error("[31m"+e):n.warn("[33m"+e)}}function validateError(e){return!matchMessage(e,_compile_info.props,/Cannot find name\s*'(\$?\$?[_a-zA-Z0-9]+)'/)&&!matchMessage(e,_compile_info.props,/Property\s*'(\$?[_a-zA-Z0-9]+)' does not exist on type/)}function matchMessage(e,t,r){if(r.test(e)){e=e.match(r);if(e[1]&&t.includes(e[1]))return!0}return!1}function updateErrorFileCache(e){e.file&&cache[_path.default.resolve(e.file.fileName)]&&(cache[_path.default.resolve(e.file.fileName)].error=!0)}function filterInput(e){var o=this;return e.filter(function(e){_newArrowCheck(this,o);var t={flag:!1},r=new Set;return checkNeedUpdateFiles(_path.default.resolve(e),t,r),t.flag||_utils.storedFileInfo.changeFiles.push(_path.default.resolve(e)),t.flag}.bind(this))}function checkNeedUpdateFiles(e,t,r){if(!r.has(e)&&(r.add(e),!t.flag)){var o=cache[e],s=_fs.default.statSync(e).mtimeMs;if(o)if(o.error||o.mtimeMs!==s)t.flag=!0;else for(let e=0;e<o.children.length;++e)_fs.default.existsSync(o.children[e])?checkNeedUpdateFiles(o.children[e],t,r):t.flag=!0;else cache[e]={mtimeMs:s,children:[],parent:[],error:!1},t.flag=!0}}exports.languageService=languageService;const moduleResolutionHost={fileExists(e){return ts.sys.fileExists(e)},readFile(e){return ts.sys.readFile(e)},realpath(e){return ts.sys.realpath(e)},trace(e){console.info(e)}};function resolveTypeReferenceDirectives(e){if(0===e.length)return[];var t,r=[],o=new Map,s=_path.default.join(_main.projectConfig.modulePath,"build-profile.json5");for(const i of e)o.has(i)||((t=ts.resolveTypeReferenceDirective(i,s,compilerOptions,moduleResolutionHost))&&t.resolvedTypeReferenceDirective||_compile_info.logger.error("[31m",`ArkTS:Cannot find type definition file for: ${i}
`),t=t.resolvedTypeReferenceDirective,o.set(i,t),r.push(t));return r}const resolvedModulesCache=new Map;function resolveModuleNames(e,t){var s=[];if([...shouldResolvedFiles].length&&!shouldResolvedFiles.has(_path.default.resolve(t))&&resolvedModulesCache[_path.default.resolve(t)]&&resolvedModulesCache[_path.default.resolve(t)].length===e.length)return resolvedModulesCache[_path.default.resolve(t)];for(const d of e){var r,o,i,n,a,l=ts.resolveModuleName(d,t,compilerOptions,moduleResolutionHost);if(l.resolvedModule)l.resolvedModule.resolvedFileName&&_path.default.extname(l.resolvedModule.resolvedFileName)===_pre_define.EXTNAME_JS&&(r=l.resolvedModule.resolvedFileName.replace(_pre_define.EXTNAME_JS,_pre_define.EXTNAME_D_ETS),ts.sys.fileExists(r))?s.push(getResolveModule(r,_pre_define.EXTNAME_D_ETS)):s.push(l.resolvedModule);else if(new RegExp(`^@(${_main.sdkConfigPrefix})\\.`,"i").test(d.trim())){let o=!1;for(let r=0;r<_main.sdkConfigs.length;r++){var c=_main.sdkConfigs[r];let e=_path.default.resolve(c.apiPath,d+".d.ts"),t=!1;if(_fs.default.existsSync(e)||(e=_path.default.resolve(c.apiPath,d+".d.ets"),t=!0),_main.systemModules.includes(d+(t?".d.ets":".d.ts"))&&ts.sys.fileExists(e)){s.push(getResolveModule(e,t?".d.ets":".d.ts")),o=!0;break}}o||s.push(null)}else/\.ets$/.test(d)&&!/\.d\.ets$/.test(d)?(r=_path.default.resolve(_path.default.dirname(t),d),ts.sys.fileExists(r)?s.push(getResolveModule(r,".ets")):s.push(null)):/\.ts$/.test(d)?(l=_path.default.resolve(_path.default.dirname(t),d),ts.sys.fileExists(l)?s.push(getResolveModule(l,".ts")):s.push(null)):(l=_path.default.resolve(__dirname,"../../../api",d+".d.ts"),a=_path.default.resolve(__dirname,"../../../api",d+".d.ets"),o=/\.js$/.test(d)?"":".js",o=_path.default.resolve(__dirname,"../node_modules",d+o),i=_path.default.resolve(__dirname,"../node_modules",d+"/index.js"),n=_path.default.resolve(_path.default.dirname(t),/\.d\.ets$/.test(d)?d:d+_pre_define.EXTNAME_D_ETS),ts.sys.fileExists(l)?s.push(getResolveModule(l,".d.ts")):ts.sys.fileExists(a)?s.push(getResolveModule(a,".d.ets")):ts.sys.fileExists(o)?s.push(getResolveModule(o,".js")):ts.sys.fileExists(i)?s.push(getResolveModule(i,".js")):ts.sys.fileExists(n)?s.push(getResolveModule(n,".d.ets")):0<(l=_main.projectConfig.projectPath.indexOf("src"+_path.default.sep+"main"))&&(a=_path.default.resolve(_main.projectConfig.projectPath.substring(0,l),d+_path.default.sep+"index"+_pre_define.EXTNAME_D_ETS))&&ts.sys.fileExists(a)?s.push(getResolveModule(a,".d.ets")):s.push(null));_main.projectConfig.hotReload&&s.length&&s[s.length-1]&&hotReloadSupportFiles.add(_path.default.resolve(s[s.length-1].resolvedFileName)),collectShouldPackedFiles(s)&&allResolvedModules.add(s[s.length-1].resolvedFileName)}return _main.projectConfig.xtsMode||createOrUpdateCache(s,_path.default.resolve(t)),resolvedModulesCache[_path.default.resolve(t)]=s}function collectShouldPackedFiles(e){return(_main.projectConfig.compileHar||_main.projectConfig.compileShared)&&e[e.length-1]&&e[e.length-1].resolvedFileName&&(_path.default.resolve(e[e.length-1].resolvedFileName).match(/(\.[^d]|[^\.]d|[^\.][^d])\.e?ts$/)||_path.default.resolve(e[e.length-1].resolvedFileName).match(/\.d\.e?ts$/)&&_path.default.resolve(e[e.length-1].resolvedFileName).match(new RegExp("\\"+_path.default.sep+"src\\"+_path.default.sep+"main\\"+_path.default.sep)))}function createOrUpdateCache(e,o){var s=this;const i=[];e.forEach(function(e){var t,r;_newArrowCheck(this,s),e&&e.resolvedFileName&&/(?<!\.d)\.(ets|ts)$/.test(e.resolvedFileName)&&(e=_path.default.resolve(e.resolvedFileName),t=_fs.default.statSync(e).mtimeMs,i.push(e),(r=cache[e])?(r.mtimeMs=t,r.error=!1,r.parent=r.parent||[],r.parent.push(_path.default.resolve(o)),r.parent=[...new Set(r.parent)]):cache[e]={mtimeMs:t,children:[],parent:[o],error:!1})}.bind(this)),cache[_path.default.resolve(o)]={mtimeMs:_fs.default.statSync(o).mtimeMs,children:i,parent:cache[_path.default.resolve(o)]&&cache[_path.default.resolve(o)].parent?cache[_path.default.resolve(o)].parent:[],error:!1}}function createWatchCompilerHost(e,t,r,o,s=!1,i=null){var n=this,i=(_main.projectConfig.hotReload&&e.forEach(function(e){_newArrowCheck(this,n),hotReloadSupportFiles.add(e)}.bind(this)),setCompilerOptions(i),ts.createSemanticDiagnosticsBuilderProgram),e=ts.createWatchCompilerHost([...e,...readDeaclareFiles()],compilerOptions,ts.sys,i,t,function(e){_newArrowCheck(this,n),[6031,6032].includes(e.code)&&!s&&(process.env.watchTs="start",o()),[6193,6194].includes(e.code)&&(s||(process.env.watchTs="end",fastBuildLogger&&(fastBuildLogger.debug(_pre_define.TS_WATCH_END_MSG),_rollupPluginEtsChecker.tsWatchEmitter.emit(_pre_define.TS_WATCH_END_MSG))),r())}.bind(this));return e.readFile=function(e){if(_newArrowCheck(this,n),_fs.default.existsSync(e))return/(?<!\.d)\.(ets|ts)$/.test(e)?instanceInsteadThis(processContent(_fs.default.readFileSync(e).toString(),e),e,[]):_fs.default.readFileSync(e).toString()}.bind(this),e.resolveModuleNames=resolveModuleNames,e.resolveTypeReferenceDirectives=resolveTypeReferenceDirectives,e}function watchChecker(e,t=null,r=null){var o=this;exports.fastBuildLogger=fastBuildLogger=t,_main.globalProgram.watchProgram=ts.createWatchProgram(createWatchCompilerHost(e,printDiagnostic,function(){_newArrowCheck(this,o)}.bind(this),function(){_newArrowCheck(this,o)}.bind(this),!1,r))}function instanceInsteadThis(t,e,r){var i=this;return checkUISyntax(t,e,r),r.reverse().forEach(function(o){var s=this;_newArrowCheck(this,i);var e=t.substring(o.start,o.end).replace(/(\s)\$(\.)/g,function(e,t,r){return _newArrowCheck(this,s),t+o.compName+"Instance"+r}.bind(this));t=t.slice(0,o.start)+e+t.slice(o.end)}.bind(this)),t}function getResolveModule(e,t){return{resolvedFileName:e,isExternalLibraryImport:!1,extension:t}}const dollarCollection=new Set,decoratorParamsCollection=(exports.dollarCollection=dollarCollection,new Set),extendCollection=(exports.decoratorParamsCollection=decoratorParamsCollection,new Set),importModuleCollection=(exports.extendCollection=extendCollection,new Set);function checkUISyntax(e,t,r){!/\.ets$/.test(t)||"moduleJson"!==process.env.compileMode&&_path.default.resolve(t)===_path.default.resolve(_main.projectConfig.projectPath,"app.ets")||(collectComponents(t=ts.createSourceFile(t,e,ts.ScriptTarget.Latest,!0,ts.ScriptKind.ETS)),parseAllNode(t,t,r),_compile_info.props.push(...dollarCollection,...decoratorParamsCollection,...extendCollection))}function collectComponents(e){if("true"!==process.env.watchMode&&e.identifiers&&e.identifiers.size)for(const t of e.identifiers.keys())_component_map.JS_BIND_COMPONENTS.has(t)&&appComponentCollection.get(_path.default.join(e.fileName)).add(t)}function parseAllNode(e,t,r){var s=this;ts.isStructDeclaration(e)&&e.members&&e.members.forEach(function(t){if(_newArrowCheck(this,s),ts.isPropertyDeclaration(t)&&ts.isIdentifier(t.name)){var r=t.name.getText();if(t.decorators&&t.decorators.length)for(let e=0;e<t.decorators.length;e++){var o=t.decorators[e].getText().replace(/\(.*\)$/,"").trim();_pre_define.INNER_COMPONENT_MEMBER_DECORATORS.has(o)&&dollarCollection.add("$"+r),isDecoratorCollection(t.decorators[e],o)&&decoratorParamsCollection.add(t.decorators[e].expression.arguments[0].getText())}}}.bind(this)),"true"!==process.env.watchMode&&ts.isIfStatement(e)&&appComponentCollection.get(_path.default.join(t.fileName)).add(_pre_define.COMPONENT_IF),(ts.isMethodDeclaration(e)&&e.name.getText()===_pre_define.COMPONENT_BUILD_FUNCTION||(ts.isMethodDeclaration(e)||ts.isFunctionDeclaration(e))&&(0,_utils.hasDecorator)(e,_pre_define.COMPONENT_BUILDER_DECORATOR))&&e.body&&e.body.statements&&e.body.statements.length&&e.body.statements.forEach(function(e,t){_newArrowCheck(this,s),traverseBuild(e,t)}.bind(this)),ts.isFunctionDeclaration(e)&&(0,_utils.hasDecorator)(e,_pre_define.COMPONENT_EXTEND_DECORATOR)&&e.body&&e.body.statements&&e.body.statements.length&&!(0,_process_ui_syntax.isOriginalExtend)(e.body)&&r.push({start:e.pos,end:e.end,compName:(0,_process_ui_syntax.isExtendFunction)(e,{decoratorName:"",componentName:""})}),e.getChildren().forEach(function(e){return _newArrowCheck(this,s),parseAllNode(e,t,r)}.bind(this))}function isForeachAndLzayForEach(e){return ts.isCallExpression(e)&&e.expression&&ts.isIdentifier(e.expression)&&_pre_define.FOREACH_LAZYFOREACH.has(e.expression.escapedText.toString())&&e.arguments&&e.arguments[1]&&ts.isArrowFunction(e.arguments[1])&&e.arguments[1].body&&ts.isBlock(e.arguments[1].body)}function traverseBuild(t,r){var o=this;if(ts.isExpressionStatement(t)){let e=(0,_process_component_build.getName)(t);!_component_map.INNER_COMPONENT_NAMES.has(e)&&t.parent&&t.parent.statements&&1<=r&&t.parent.statements[r-1].expression&&t.parent.statements[r-1].expression.expression&&(e=t.parent.statements[r-1].expression.expression.escapedText),t=t.expression,ts.isEtsComponentExpression(t)&&t.body&&ts.isBlock(t.body)&&ts.isIdentifier(t.expression)&&!_pre_define.$$_BLOCK_INTERFACE.has(t.expression.escapedText.toString())?t.body.statements.forEach(function(e,t){_newArrowCheck(this,o),traverseBuild(e,t)}.bind(this)):isForeachAndLzayForEach(t)?t.arguments[1].body.statements.forEach(function(e,t){_newArrowCheck(this,o),traverseBuild(e,t)}.bind(this)):(loopNodeFindDoubleDollar(t,e),ts.isEtsComponentExpression(t)&&t.body&&ts.isBlock(t.body)&&ts.isIdentifier(t.expression)&&t.body.statements.forEach(function(e,t){_newArrowCheck(this,o),traverseBuild(e,t)}.bind(this)))}else ts.isIfStatement(t)&&(t.thenStatement&&ts.isBlock(t.thenStatement)&&t.thenStatement.statements&&t.thenStatement.statements.forEach(function(e,t){_newArrowCheck(this,o),traverseBuild(e,t)}.bind(this)),t.elseStatement)&&ts.isBlock(t.elseStatement)&&t.elseStatement.statements&&t.elseStatement.statements.forEach(function(e,t){_newArrowCheck(this,o),traverseBuild(e,t)}.bind(this))}function isPropertiesAddDoubleDollar(e){return!!(ts.isCallExpression(e)&&ts.isIdentifier(e.expression)&&e.arguments&&e.arguments.length)||!!(ts.isEtsComponentExpression(e)&&e.body&&ts.isBlock(e.body)&&ts.isIdentifier(e.expression)&&_pre_define.$$_BLOCK_INTERFACE.has(e.expression.escapedText.toString()))}function loopNodeFindDoubleDollar(r,o){for(var e,s=this;r;)ts.isCallExpression(r)&&ts.isPropertyAccessExpression(r.expression)?(e=r.arguments,isCanAddDoubleDollar(r.expression.name.getText(),o)&&e.forEach(function(e){_newArrowCheck(this,s),doubleDollarCollection(e)}.bind(this))):isPropertiesAddDoubleDollar(r)&&r.arguments.forEach(function(e){var t=this;_newArrowCheck(this,s),ts.isObjectLiteralExpression(e)&&e.properties&&e.properties.length&&e.properties.forEach(function(e){_newArrowCheck(this,t),isObjectPram(e,o)&&doubleDollarCollection(e.initializer)}.bind(this)),_pre_define.STYLE_ADD_DOUBLE_DOLLAR.has(r.expression.getText())&&ts.isPropertyAccessExpression(e)&&doubleDollarCollection(e)}.bind(this)),r=r.expression}function doubleDollarCollection(e){if(e.getText().startsWith(_pre_define.$$)){for(;e.expression;)e=e.expression;dollarCollection.add(e.getText())}}function isObjectPram(e,t){return ts.isPropertyAssignment(e)&&e.name&&ts.isIdentifier(e.name)&&e.initializer&&_pre_define.PROPERTIES_ADD_DOUBLE_DOLLAR.has(t)&&_pre_define.PROPERTIES_ADD_DOUBLE_DOLLAR.get(t).has(e.name.getText())}function isCanAddDoubleDollar(e,t){return _pre_define.PROPERTIES_ADD_DOUBLE_DOLLAR.has(t)&&_pre_define.PROPERTIES_ADD_DOUBLE_DOLLAR.get(t).has(e)||_pre_define.STYLE_ADD_DOUBLE_DOLLAR.has(e)}function isDecoratorCollection(e,t){return _pre_define.COMPONENT_DECORATORS_PARAMS.has(t)&&e.expression.arguments&&e.expression.arguments.length&&ts.isIdentifier(e.expression.arguments[0])}function processContent(e,t){return fastBuildLogger&&(e=(0,_process_visual.visualTransform)(e,t,fastBuildLogger)),e=(0,_validate_ui_syntax.preprocessExtend)(e,extendCollection),e=(0,_validate_ui_syntax.preprocessNewExtend)(e,extendCollection)}function judgeFileShouldResolved(e,t){var r=this;t.has(e)||(t.add(e),cache&&cache[e]&&cache[e].parent&&(cache[e].parent.forEach(function(e){_newArrowCheck(this,r),judgeFileShouldResolved(e,t)}.bind(this)),cache[e].parent=[]),cache&&cache[e]&&cache[e].children&&(cache[e].children.forEach(function(e){_newArrowCheck(this,r),judgeFileShouldResolved(e,t)}.bind(this)),cache[e].children=[]))}function incrementWatchFile(e,t){var r=this,e=[...e,...t];e.length&&shouldResolvedFiles.clear(),e.forEach(function(e){_newArrowCheck(this,r),judgeFileShouldResolved(e,shouldResolvedFiles)}.bind(this))}function runArkTSLinter(){var t=this,e=(0,_do_arkTS_linter.doArkTSLinter)(_main.globalProgram.program,getArkTSLinterMode(),printArkTSLinterDiagnostic,!_main.projectConfig.xtsMode);"true"===process.env.watchMode||_main.projectConfig.xtsMode||e.forEach(function(e){_newArrowCheck(this,t),updateErrorFileCache(e)}.bind(this))}function printArkTSLinterDiagnostic(e){var t;e.category===ts.DiagnosticCategory.Error&&(isInOhModuleFile(e)||isInSDK(e))?(t=e.category,e.category=ts.DiagnosticCategory.Warning,printDiagnostic(e),e.category=t):printDiagnostic(e)}function isInOhModuleFile(e){return void 0!==e.file&&(-1!==e.file.fileName.indexOf("/oh_modules/")||-1!==e.file.fileName.indexOf("\\oh_modules\\"))}function isInSDK(e){var t,e=e.file?.fileName;return void 0!==_main.projectConfig.etsLoaderPath&&void 0!==e&&(t=_path.default.resolve(_main.projectConfig.etsLoaderPath,"../../../"),_path.default.resolve(e).startsWith(t))}function getArkTSLinterMode(){return _main.partialUpdateConfig.executeArkTSLinter?_main.partialUpdateConfig.standardArkTSLinter&&isStandardMode()?_do_arkTS_linter.ArkTSLinterMode.STANDARD_MODE:_do_arkTS_linter.ArkTSLinterMode.COMPATIBLE_MODE:_do_arkTS_linter.ArkTSLinterMode.NOT_USE}function isStandardMode(){return!!(_main.projectConfig&&_main.projectConfig.compatibleSdkVersion&&10<=_main.projectConfig.compatibleSdkVersion)}function initEtsStandaloneCheckerConfig(e,t){exports.fastBuildLogger=fastBuildLogger=e,"ohpm"===t.packageManagerType?(t.packageDir="oh_modules",t.packageJson="oh-package.json5"):(t.packageDir="node_modules",t.packageJson="package.json"),t.aceModuleJsonPath&&_fs.default.existsSync(t.aceModuleJsonPath)&&(process.env.compileMode="moduleJson"),Object.assign(_main.projectConfig,t)}function etsStandaloneChecker(e,t,r){var o=this;initEtsStandaloneCheckerConfig(t,r);const s=[];t=[],Object.values(e).forEach(function(e){_newArrowCheck(this,o),s.push(_path.default.resolve(e))}.bind(this)),r.resolveModulePaths&&Array.isArray(r.resolveModulePaths)&&t.push(...r.resolveModulePaths),e=filterInput(s);exports.languageService=languageService=createLanguageService(e,t),_main.globalProgram.program=languageService.getProgram(),runArkTSLinter(),_main.globalProgram.program.getSyntacticDiagnostics().concat(_main.globalProgram.program.getSemanticDiagnostics()).concat(_main.globalProgram.program.getDeclarationDiagnostics()).forEach(function(e){_newArrowCheck(this,o),printDiagnostic(e)}.bind(this))}exports.importModuleCollection=importModuleCollection;