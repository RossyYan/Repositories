"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TEMPORARYS=exports.SRC_MAIN=exports.LogType=exports.IGNORE_ERROR_CODE=exports.FileLog=exports.BUILD=void 0,exports.addLog=addLog,exports.circularFile=circularFile,exports.componentInfo=void 0,exports.differenceResourcesRawfile=differenceResourcesRawfile,exports.emitLogInfo=emitLogInfo,exports.genTemporaryPath=genTemporaryPath,exports.generateSourceFilesInHar=generateSourceFilesInHar,exports.getAllComponentsOrModules=getAllComponentsOrModules,exports.getExtensionIfUnfullySpecifiedFilepath=getExtensionIfUnfullySpecifiedFilepath,exports.getHotReloadFiles=getHotReloadFiles,exports.getMessage=getMessage,exports.getPossibleBuilderTypeParameter=getPossibleBuilderTypeParameter,exports.getResolveModules=getResolveModules,exports.getTransformLog=getTransformLog,exports.hasDecorator=hasDecorator,exports.hotReloadIncrementalTime=void 0,exports.isLinux=isLinux,exports.isMac=isMac,exports.isPackageModulesFile=isPackageModulesFile,exports.isWindows=isWindows,exports.maxFilePathLength=maxFilePathLength,exports.mkDir=mkDir,exports.mkdirsSync=mkdirsSync,exports.nodeLargeOrEqualTargetVersion=nodeLargeOrEqualTargetVersion,exports.parseErrorMessage=parseErrorMessage,exports.readFile=readFile,exports.removeDir=removeDir,exports.repeatLog=void 0,exports.resourcesRawfile=resourcesRawfile,exports.setChecker=setChecker,exports.shouldWriteChangedList=shouldWriteChangedList,exports.storedFileInfo=void 0,exports.toHashData=toHashData,exports.toUnixPath=toUnixPath,exports.unlinkSync=unlinkSync,exports.validateFilePathLength=validateFilePathLength,exports.validateFilePathLengths=validateFilePathLengths,exports.writeCollectionFile=writeCollectionFile,exports.writeFileSync=writeFileSync,exports.writeUseOSFiles=writeUseOSFiles;var _path=_interopRequireDefault(require("path")),_typescript=_interopRequireDefault(require("typescript")),_fs=_interopRequireDefault(require("fs")),_os=_interopRequireDefault(require("os")),_uglifyJs=_interopRequireDefault(require("uglify-js")),_main=require("../main"),_crypto=require("crypto"),_pre_define=require("./pre_define");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}function _defineProperty(e,t,r){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==typeof e?e:String(e)}function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);r=r.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}let LogType=function(e){return e.ERROR="ERROR",e.WARN="WARN",e.NOTE="NOTE",e}({});exports.LogType=LogType;const TEMPORARYS="temporarys",BUILD=(exports.TEMPORARYS=TEMPORARYS,"build"),SRC_MAIN=(exports.BUILD=BUILD,"src/main"),red=(exports.SRC_MAIN=SRC_MAIN,"[31m"),reset="[39m",WINDOWS="Windows_NT",LINUX="Linux",MAC="Darwin",repeatLog=new Map;exports.repeatLog=repeatLog;class FileLog{constructor(){_defineProperty(this,"_sourceFile",void 0),_defineProperty(this,"_errors",[])}get sourceFile(){return this._sourceFile}set sourceFile(e){this._sourceFile=e}get errors(){return this._errors}set errors(e){this._errors=e}}function emitLogInfo(t,e,r=!1,i=null){var o=this;e&&e.length&&e.forEach(function(e){switch(_newArrowCheck(this,o),e.type){case LogType.ERROR:r?t.error("[31m"+getMessage(e.fileName||i,e,!0)):t.emitError(getMessage(e.fileName||t.resourcePath,e));break;case LogType.WARN:r?t.warn("[33m"+getMessage(e.fileName||i,e,!0)):t.emitWarning(getMessage(e.fileName||t.resourcePath,e));break;case LogType.NOTE:r?t.info("[34m"+getMessage(e.fileName||i,e,!0)):t.emitWarning(getMessage(t.resourcePath,e))}}.bind(this))}function addLog(e,t,r,i,o){r=o.getLineAndCharacterOfPosition(r);i.push({type:e,message:t,line:r.line+1,column:r.character+1,fileName:o.fileName})}function getMessage(e,t,r=!1){let i;return i=t.line&&t.column?`BUILD${t.type} File: ${e}:${t.line}:${t.column}
 `+t.message:`BUILD${t.type} File: ${e}
 `+t.message,i=r?i.replace(/^BUILD/,"ArkTS:"):i}function getTransformLog(e){var r=this;const i=e.sourceFile;return e.errors.map(function(e){var t;return _newArrowCheck(this,r),e.pos?e.column&&e.line||(t=i.getLineAndCharacterOfPosition(e.pos),e.line=t.line+1,e.column=t.character+1):(e.line=e.line||void 0,e.column=e.column||void 0),e.fileName||(e.fileName=i.fileName),e}.bind(this))}exports.FileLog=FileLog;class ComponentInfo{constructor(){_defineProperty(this,"_id",0),_defineProperty(this,"_componentNames",new Set(["ForEach"]))}set id(e){this._id=e}get id(){return this._id}set componentNames(e){this._componentNames=e}get componentNames(){return this._componentNames}}const componentInfo=new ComponentInfo;function hasDecorator(t,r,i=null,o=null){if(t.decorators&&t.decorators.length){var s={Extend:!1,AnimatableExtend:!1};for(let e=0;e<t.decorators.length;e++){var n=t.decorators[e].getText().replace(/\(.*\)$/,"").trim();if(o&&_pre_define.EXTEND_DECORATORS.includes(r))n===_pre_define.COMPONENT_EXTEND_DECORATOR&&(s.Extend=!0),n===_pre_define.COMPONENT_ANIMATABLE_EXTEND_DECORATOR&&(s.AnimatableExtend=!0);else if(n===r)return i&&i.push(...t.decorators.slice(e+1),...t.decorators.slice(0,e)),!0}return o&&s.Extend&&s.AnimatableExtend&&o.push({type:LogType.ERROR,message:"The function can not be decorated by '@Extend' and '@AnimatableExtend' at the same time.",pos:t.getStart()}),r===_pre_define.COMPONENT_EXTEND_DECORATOR&&s.Extend||r===_pre_define.COMPONENT_ANIMATABLE_EXTEND_DECORATOR&&s.AnimatableExtend}return!1}exports.componentInfo=componentInfo;const STATEMENT_EXPECT=1128,SEMICOLON_EXPECT=1005,STATESTYLES_EXPECT=1003,IGNORE_ERROR_CODE=[STATEMENT_EXPECT,SEMICOLON_EXPECT,STATESTYLES_EXPECT];function readFile(t,r){var i=this;try{_fs.default.readdirSync(t).forEach(function(e){_newArrowCheck(this,i);e=_path.default.join(t,e);_fs.default.statSync(e).isDirectory()?readFile(e,r):r.push(e)}.bind(this))}catch(e){console.error(red,"ArkTS ERROR: "+e,reset)}}function circularFile(i,o){i&&o&&_fs.default.readdir(i,function(e,t){var r=this;t&&t.forEach(function(e){_newArrowCheck(this,r);var t=_path.default.resolve(i,e),e=_path.default.resolve(o,e);(_fs.default.statSync(t).isFile()?copyFile:circularFile)(t,e)}.bind(this))})}function copyFile(e,t){try{var r=_path.default.join(t,"..");if(_fs.default.existsSync(r)&&_fs.default.statSync(r).isDirectory()||mkDir(r),!_fs.default.existsSync(t)){var i=_fs.default.createReadStream(e);const o=_fs.default.createWriteStream(t);i.pipe(o),i.on("close",function(){o.end()})}}catch(e){throw e.message}}function mkDir(e){var t=_path.default.join(e,"..");_fs.default.existsSync(t)&&!_fs.default.statSync(t).isFile()||mkDir(t),_fs.default.mkdirSync(e)}function toUnixPath(e){var t;return/^win/.test(require("os").platform())?(t=e.split(_path.default.sep),_path.default.posix.join(...t)):e}function toHashData(e){var e=_fs.default.readFileSync(e).toString(),t=(0,_crypto.createHash)("sha256");return t.update(e),t.digest("hex")}function writeFileSync(e,t){var r;_fs.default.existsSync(e)||(r=_path.default.join(e,".."),_fs.default.existsSync(r)&&!_fs.default.statSync(r).isFile())||mkDir(r),_fs.default.writeFileSync(e,t)}function genTemporaryPath(t,e,r,i,o=!1){if(t=toUnixPath(t).replace(/\.[cm]js$/,_pre_define.EXTNAME_JS),e=toUnixPath(e),"rollup"===process.env.compileTool)return s=toUnixPath(o?e:i.projectRootPath),s=t.replace(s,""),_path.default.join(r,s);if(isPackageModulesFile(t,i)){var s=i.packageDir,n=toUnixPath(_path.default.join(i.projectRootPath,s));let e="";return e=-1===t.indexOf(n)?(i=toUnixPath(i.projectRootPath),i=(i=t.replace(i,"")).substring(i.indexOf(s)+s.length+1),_path.default.join(r,o?"":_pre_define.TEMPORARY,s,_pre_define.MAIN,i)):t.replace(n,_path.default.join(r,o?"":_pre_define.TEMPORARY,s,_pre_define.AUXILIARY))}return-1!==t.indexOf(e)?(i=t.replace(e,""),_path.default.join(r,o?"":_pre_define.TEMPORARY,i)):""}function isPackageModulesFile(e,t){e=toUnixPath(e);var r=toUnixPath(t.projectRootPath),r=e.replace(r,""),i=t.packageDir;if(-1!==r.indexOf(i)){r=toUnixPath(_path.default.resolve(t.projectRootPath,i));if(-1!==e.indexOf(r))return!0;if(t.modulePathMap)for(const s in t.modulePathMap){var o=t.modulePathMap[s],o=toUnixPath(_path.default.resolve(o,i));if(-1!==e.indexOf(o))return!0}}return!1}function generateSourceFilesInHar(e,t,r,i){let o=genTemporaryPath(e,i.compileShared?i.projectRootPath:i.moduleRootPath,i.compileShared?_path.default.resolve(i.aceModuleBuild,"../etsFortgz"):i.cachePath,i,i.compileShared);o.match(new RegExp(i.packageDir))||(o=o.replace(/\.ets$/,r).replace(/\.ts$/,r),mkdirsSync(_path.default.dirname(o)),"uglify"===i.obfuscateHarType&&".js"===r&&(t=_uglifyJs.default.minify(t).code),_fs.default.writeFileSync(o,t))}function mkdirsSync(e){return!!_fs.default.existsSync(e)||!!mkdirsSync(_path.default.dirname(e))&&(_fs.default.mkdirSync(e),!0)}function nodeLargeOrEqualTargetVersion(e){return e<=parseInt(process.versions.node.split(".")[0])}function removeDir(e){_fs.default.existsSync(e)&&(nodeLargeOrEqualTargetVersion(16)?_fs.default.rmSync(e,{recursive:!0}):_fs.default.rmdirSync(e,{recursive:!0}))}function parseErrorMessage(e){var t=this,e=e.split("\n");let r="";return e.forEach(function(e){_newArrowCheck(this,t),/^at/.test(e.trim())||(r=r+e+"\n")}.bind(this)),r}function isWindows(){return _os.default.type()===WINDOWS}function isLinux(){return _os.default.type()===LINUX}function isMac(){return _os.default.type()===MAC}function maxFilePathLength(){return isWindows()?32766:isLinux()?4095:isMac()?1016:-1}function validateFilePathLength(e,t){return maxFilePathLength()<0?(t.error(red,"Unknown OS platform",reset),process.exitCode=_pre_define.FAIL,!1):0<e.length&&e.length<=maxFilePathLength()||(e.length>maxFilePathLength()?t.error(red,`The length of ${e} exceeds the limitation of current platform, which is `+maxFilePathLength()+". Please try moving the project folder to avoid deeply nested file path and try again",reset):t.error(red,"Validate file path failed",reset),process.exitCode=_pre_define.FAIL,!1)}function validateFilePathLengths(e,t){var r=this;return e.forEach(function(e){if(_newArrowCheck(this,r),!validateFilePathLength(e,t))return!1}.bind(this)),!0}function unlinkSync(e){_fs.default.existsSync(e)&&_fs.default.unlinkSync(e)}function getExtensionIfUnfullySpecifiedFilepath(e){if(_fs.default.existsSync(e)&&_fs.default.statSync(e).isFile())return"";let t=_pre_define.EXTNAME_ETS;return _fs.default.existsSync(e+".ts")&&_fs.default.statSync(e+".ts").isFile()?t=".ts":_fs.default.existsSync(e+".d.ts")&&_fs.default.statSync(e+".d.ts").isFile()?t=".d.ts":_fs.default.existsSync(e+".d.ets")&&_fs.default.statSync(e+".d.ets").isFile()?t=".d.ets":_fs.default.existsSync(e+".js")&&_fs.default.statSync(e+".js").isFile()?t=".js":_fs.default.existsSync(e+".json")&&_fs.default.statSync(e+".json").isFile()&&(t=".json"),t}function shouldWriteChangedList(e,t){return!(!(_main.projectConfig.compileMode===_pre_define.ESMODULE&&"true"===process.env.watchMode&&!_main.projectConfig.isPreview&&_main.projectConfig.changedFileList&&t.length+e.length)||"rollup"!==process.env.compileTool&&1===e.length&&e[0]===_main.projectConfig.projectPath&&!t.length)}exports.IGNORE_ERROR_CODE=IGNORE_ERROR_CODE;const hotReloadIncrementalTime={hotReloadIncrementalStartTime:"",hotReloadIncrementalEndTime:""};exports.hotReloadIncrementalTime=hotReloadIncrementalTime;let allModifiedFiles=new Set;function getHotReloadFiles(e,t,r){var i=this;return hotReloadIncrementalTime.hotReloadIncrementalStartTime=(new Date).getTime().toString(),t=t.map(function(e){return _newArrowCheck(this,i),_path.default.relative(_main.projectConfig.projectPath,e)}.bind(this)),{modifiedFiles:[...allModifiedFiles=new Set([...allModifiedFiles,...e.filter(function(e){return _newArrowCheck(this,i),_fs.default.statSync(e).isFile()&&(r.has(e)||![".ets",".ts",".js"].includes(_path.default.extname(e)))}.bind(this)).map(function(e){return _newArrowCheck(this,i),_path.default.relative(_main.projectConfig.projectPath,e)}.bind(this))].filter(function(e){return _newArrowCheck(this,i),!t.includes(e)}.bind(this)))],removedFiles:[...t]}}function getResolveModules(e,t){return t?[_path.default.resolve(e,"../../../../../"),_path.default.resolve(e,"../../../../"+_main.projectConfig.packageDir),_path.default.resolve(e,"../../../../../"+_main.projectConfig.packageDir),_path.default.resolve(e,"../../")]:[_path.default.resolve(e,"../../../../"),_path.default.resolve(e,"../../../"+_main.projectConfig.packageDir),_path.default.resolve(e,"../../../../"+_main.projectConfig.packageDir),_path.default.resolve(e,"../")]}function writeUseOSFiles(e){let t="";var r;_fs.default.existsSync(_main.projectConfig.aceSoPath)?t=_fs.default.readFileSync(_main.projectConfig.aceSoPath,"utf-8")+"\n":(r=_path.default.resolve(_main.projectConfig.aceSoPath,".."),_fs.default.existsSync(r)&&!_fs.default.statSync(r).isFile()||mkDir(r)),_fs.default.writeFileSync(_main.projectConfig.aceSoPath,t+Array.from(e).join("\n"))}function writeCollectionFile(e,t,r,i,o=null){for(var s of t.keys())0===t.get(s).size?r.delete(s):o&&!o.has(s)||r.set(s,Array.from(t.get(s)));var n=JSON.stringify(Object.fromEntries(r),null,2);writeFileSync(_path.default.resolve(e,i),n)}function getAllComponentsOrModules(e,t){var t=_path.default.resolve(_main.projectConfig.cachePath,t),r=new Map;if(_fs.default.existsSync(t)){var i,o=require(t);for(i in o)e.has(i)&&r.set(i,o[i])}return r}function getPossibleBuilderTypeParameter(e){var t=this;const r=[];return _main.partialUpdateConfig.builderCheck||(is$$Parameter(e)?e[0].type.members.forEach(function(e){_newArrowCheck(this,t),e.name&&_typescript.default.isIdentifier(e.name)&&r.push(e.name.escapedText.toString())}.bind(this)):e.forEach(function(e){_newArrowCheck(this,t),e.name&&_typescript.default.isIdentifier(e.name)&&r.push(e.name.escapedText.toString())}.bind(this))),r}function is$$Parameter(e){return 1===e.length&&e[0].name&&_typescript.default.isIdentifier(e[0].name)&&e[0].name.escapedText.toString()===_pre_define.$$&&e[0].type&&_typescript.default.isTypeLiteralNode(e[0].type)&&e[0].type.members&&0<e[0].type.members.length}class ProcessFileInfo{constructor(){_defineProperty(this,"buildStart",!0),_defineProperty(this,"wholeFileInfo",{}),_defineProperty(this,"transformedFiles",new Set),_defineProperty(this,"cachedFiles",[]),_defineProperty(this,"shouldHaveEntry",[]),_defineProperty(this,"resourceToFile",{}),_defineProperty(this,"lastResourceList",new Set),_defineProperty(this,"resourceList",new Set),_defineProperty(this,"shouldInvalidFiles",new Set),_defineProperty(this,"resourceTableChanged",!1),_defineProperty(this,"currentArkTsFile",void 0),_defineProperty(this,"reUseProgram",!1),_defineProperty(this,"resourcesArr",new Set),_defineProperty(this,"lastResourcesSet",new Set),_defineProperty(this,"transformCacheFiles",{}),_defineProperty(this,"newTsProgram",void 0),_defineProperty(this,"changeFiles",[]),_defineProperty(this,"isFirstBuild",!0)}addGlobalCacheInfo(e,t){if(this.buildStart){for(const r in t)this.resourceToFile[r]=new Set(t[r]);this.lastResourceList=new Set(e)}this.resourceTableChanged&&this.compareResourceDiff()}addFileCacheInfo(e,t){t&&"moduleJson"===process.env.compileMode&&(Array.isArray(t.fileToResourceList)?t.fileToResourceList=new Set(t.fileToResourceList):t.fileToResourceList=new Set),e.match(/(?<!\.d)\.(ets)$/)?this.wholeFileInfo[e]=new SpecialArkTSFileInfo(t):e.match(/(?<!\.d)\.(ts)$/)&&"moduleJson"===process.env.compileMode&&(this.wholeFileInfo[e]=new TSFileInfo(t))}collectTransformedFiles(e){e.match("moduleJson"===process.env.compileMode?/(?<!\.d)\.(ets|ts)$/:/(?<!\.d)\.(ets)$/)&&this.transformedFiles.add(e)}collectCachedFiles(e){e.match("moduleJson"===process.env.compileMode?/(?<!\.d)\.(ets|ts)$/:/(?<!\.d)\.(ets)$/)&&this.cachedFiles.push(e)}judgeShouldHaveEntryFiles(t){var r=this;this.shouldHaveEntry=Object.values(_main.projectConfig.entryObj).filter(function(e){return _newArrowCheck(this,r),!t.includes(e.toLowerCase())&&e.match(/(?<!\.d)\.(ets)$/)}.bind(this))}saveCacheFileInfo(e){if("moduleJson"===process.env.compileMode){var t=e.get("fileCacheInfo")||{},r=e.get("resourceToFileCacheInfo")||{};for(const s in r)r[s]=new Set(r[s]);var i=Object.assign(r,this.resourceToFile);for(const n of this.transformedFiles){t[n]=this.wholeFileInfo[n].fileInfo;for(const a of this.wholeFileInfo[n].newFileToResourceList)t[n].fileToResourceList.has(a)||(i[a]||(i[a]=new Set),i[a].add(n));for(const l of t[n].fileToResourceList)this.wholeFileInfo[n].newFileToResourceList.has(l)||i[l].delete(n);t[n].fileToResourceList=[...this.wholeFileInfo[n].newFileToResourceList]}for(const c of this.cachedFiles)t[c].fileToResourceList=[...t[c].fileToResourceList];for(const f in this.resourceToFile=i)i[f]=[...i[f]];e.set("fileCacheInfo",t),e.set("resourceListCacheInfo",[...this.resourceList]),e.set("resourceToFileCacheInfo",i)}else{var o=e.get("fileCacheInfo")||{};for(const u of this.transformedFiles)o[u]=this.wholeFileInfo[u].fileInfo;e.set("fileCacheInfo",o)}}updateResourceList(e){this.resourceList.add(e)}compareResourceDiff(){var t=this;for(const e of this.lastResourceList)!this.resourceList.has(e)&&this.resourceToFile[e]&&this.resourceToFile[e].forEach(function(e){_newArrowCheck(this,t),this.shouldInvalidFiles.add(e)}.bind(this));for(const r of this.resourceList)this.resourceToFile[r]||(this.resourceToFile[r]=new Set),this.lastResourceList.has(r)||this.resourceToFile[r].forEach(function(e){_newArrowCheck(this,t),this.shouldInvalidFiles.add(e)}.bind(this))}collectResourceInFile(e,t){this.wholeFileInfo[t].newFileToResourceList.add(e)}clearCollectedInfo(e){this.buildStart=!1,this.resourceTableChanged=!1,this.saveCacheFileInfo(e),this.transformedFiles=new Set,this.cachedFiles=[],this.lastResourceList=new Set([...this.resourceList]),this.shouldInvalidFiles.clear(),this.resourcesArr.clear()}setCurrentArkTsFile(){this.currentArkTsFile=new SpecialArkTSFileInfo}getCurrentArkTsFile(){return this.currentArkTsFile}}const storedFileInfo=new ProcessFileInfo;exports.storedFileInfo=storedFileInfo;class TSFileInfo{constructor(e,t){_defineProperty(this,"fileInfo",{fileToResourceList:new Set}),_defineProperty(this,"newFileToResourceList",new Set),t||(this.fileInfo=e||this.fileInfo)}}class SpecialArkTSFileInfo extends TSFileInfo{constructor(e){super(e,!0),_defineProperty(this,"fileInfo",{hasEntry:!1,fileToResourceList:new Set}),_defineProperty(this,"recycleComponents",new Set([])),_defineProperty(this,"compFromDETS",new Set),_defineProperty(this,"animatableExtendAttribute",new Map),this.fileInfo=e||this.fileInfo}get hasEntry(){return this.fileInfo.hasEntry}set hasEntry(e){this.fileInfo.hasEntry=e}}function setChecker(){_main.globalProgram.program?_main.globalProgram.checker=_main.globalProgram.program.getTypeChecker():_main.globalProgram.watchProgram&&(_main.globalProgram.checker=_main.globalProgram.watchProgram.getCurrentProgram().getProgram().getTypeChecker())}function resourcesRawfile(t,r,i=""){var o=this;_fs.default.existsSync(process.env.rawFileResource)&&_fs.default.statSync(t).isDirectory()&&_fs.default.readdirSync(t).forEach(function(e){_newArrowCheck(this,o),_fs.default.statSync(_path.default.join(t,e)).isDirectory()?resourcesRawfile(_path.default.join(t,e),r,i?i+"/"+e:e):i?r.add(i+"/"+e):r.add(e)}.bind(this))}function differenceResourcesRawfile(e,t){if(0===e.size||e.size!==t.size)return 0!==e.size||e.size!==t.size;for(const r of e.values())if(!t.has(r))return!0;return!1}