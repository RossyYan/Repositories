"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.props=exports.logger=exports.ResultStates=void 0;var ts=_interopRequireWildcard(require("typescript")),_Compilation=_interopRequireDefault(require("webpack/lib/Compilation")),_JavascriptModulesPlugin=_interopRequireDefault(require("webpack/lib/javascript/JavascriptModulesPlugin")),_log4js=require("log4js"),_path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),_CachedSource=_interopRequireDefault(require("webpack-sources/lib/CachedSource")),_ConcatSource=_interopRequireDefault(require("webpack-sources/lib/ConcatSource")),_process_ui_syntax=require("./process_ui_syntax"),_validate_ui_syntax=require("./validate_ui_syntax"),_utils=require("./utils"),_pre_define=require("./pre_define"),_ets_checker=require("./ets_checker"),_main=require("../main"),_cluster=_interopRequireDefault(require("cluster"));function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){var t,r;return"function"!=typeof WeakMap?null:(t=new WeakMap,r=new WeakMap,(_getRequireWildcardCache=function(e){return e?r:t})(e))}function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};t=_getRequireWildcardCache(t);if(t&&t.has(e))return t.get(e);var r,o,i={},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&((o=s?Object.getOwnPropertyDescriptor(e,r):null)&&(o.get||o.set)?Object.defineProperty(i,r,o):i[r]=e[r]);return i.default=e,t&&t.set(e,i),i}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}function _defineProperty(e,t,r){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==typeof e?e:String(e)}function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var r=e[Symbol.toPrimitive];if(void 0===r)return("string"===t?String:Number)(e);r=r.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}(0,_log4js.configure)({appenders:{ETS:{type:"stderr",layout:{type:"messagePassThrough"}}},categories:{default:{appenders:["ETS"],level:"info"}}});const logger=(0,_log4js.getLogger)("ETS"),props=(exports.logger=logger,[]),checkErrorMessage=(exports.props=props,new Set([]));class ResultStates{constructor(){_defineProperty(this,"mStats",void 0),_defineProperty(this,"mErrorCount",0),_defineProperty(this,"mPreErrorCount",0),_defineProperty(this,"mWarningCount",0),_defineProperty(this,"warningCount",0),_defineProperty(this,"noteCount",0),_defineProperty(this,"red","[31m"),_defineProperty(this,"yellow","[33m"),_defineProperty(this,"blue","[34m"),_defineProperty(this,"reset","[39m"),_defineProperty(this,"moduleSharePaths",new Set([])),_defineProperty(this,"removedFiles",[]),_defineProperty(this,"hotReloadIncrementalTime",{hotReloadIncrementalStartTime:"",hotReloadIncrementalEndTime:""}),_defineProperty(this,"incrementalFileInHar",new Map)}apply(e){var o=this;e.hooks.compilation.tap("SourcemapFixer",function(e){var s=this;_newArrowCheck(this,o),e.hooks.processAssets.tap("RemoveHar",function(t){var r=this;_newArrowCheck(this,s),_main.projectConfig.compileHar&&Object.keys(e.assets).forEach(function(e){_newArrowCheck(this,r),_path.default.extname(e)!==_pre_define.EXTNAME_JS&&_path.default.extname(e)!==_pre_define.EXTNAME_JS_MAP||delete t[e]}.bind(this))}.bind(this)),e.hooks.afterProcessAssets.tap("SourcemapFixer",function(o){var i=this;_newArrowCheck(this,s),Reflect.ownKeys(o).forEach(function(e){var t,r;_newArrowCheck(this,i),/\.map$/.test(e.toString())&&o[e]._value&&(o[e]._value=o[e]._value.toString().replace(".ets?entry",".ets"),o[e]._value=o[e]._value.toString().replace(".ts?entry",".ts"),t=_path.default.resolve(_main.projectConfig.projectPath,e.toString().replace(".js.map",".js")),_validate_ui_syntax.sourcemapNamesCollection)&&t&&(t=_validate_ui_syntax.sourcemapNamesCollection.get(t))&&0!=t.size&&(t=Array.from(t).flat(),(r=JSON.parse(o[e]._value)).nameMap=t,o[e]._value=JSON.stringify(r))}.bind(this))}.bind(this)),e.hooks.succeedModule.tap("findModule",function(e){var t;_newArrowCheck(this,s),e&&e.error&&(t=e.error.toString(),e.resourceResolveData)&&e.resourceResolveData.path&&/Module parse failed/.test(t)&&/Invalid regular expression:/.test(t)&&(this.mErrorCount++,t=t.split("\n>")[1].split(";"))&&0<t.length&&t[0]&&(t=`ERROR in ${e.resourceResolveData.path}
 The following syntax is incorrect.
 > `+t[0],this.printErrorMessage((0,_utils.parseErrorMessage)(t),!1,e.error))}.bind(this)),e.hooks.buildModule.tap("findModule",function(e){var t;_newArrowCheck(this,s),!e.context||0<=e.context.indexOf(_main.projectConfig.projectPath)||(t=(e=_path.default.join(e.context)).lastIndexOf(_pre_define.MODULE_ETS_PATH))<0||(e=_path.default.resolve(e.substring(0,t),_pre_define.MODULE_SHARE_PATH),_fs.default.existsSync(e)&&this.moduleSharePaths.add(e))}.bind(this)),e.hooks.finishModules.tap("finishModules",handleFinishModules.bind(this))}.bind(this)),e.hooks.afterCompile.tap("copyFindModule",function(){var t=this;_newArrowCheck(this,o),this.moduleSharePaths.forEach(function(e){_newArrowCheck(this,t),(0,_utils.circularFile)(e,_path.default.resolve(_main.projectConfig.buildPath,_pre_define.BUILD_SHARE_PATH))}.bind(this))}.bind(this)),e.hooks.compilation.tap("CommonAsset",function(e){var r=this;_newArrowCheck(this,o),e.hooks.processAssets.tap({name:"GLOBAL_COMMON_MODULE_CACHE",stage:_Compilation.default.PROCESS_ASSETS_STAGE_ADDITIONS},function(e){_newArrowCheck(this,r);var t=`
          globalThis["__common_module_cache__${_main.projectConfig.hashProjectPath}"] =`+` globalThis["__common_module_cache__${_main.projectConfig.hashProjectPath}"] || {};`;e["commons.js"]?e["commons.js"]=new _CachedSource.default(new _ConcatSource.default(e["commons.js"],t)):e["vendors.js"]&&(e["vendors.js"]=new _CachedSource.default(new _ConcatSource.default(e["vendors.js"],t)))}.bind(this))}.bind(this)),e.hooks.compilation.tap("Require",function(e){var t=this;_newArrowCheck(this,o),_JavascriptModulesPlugin.default.getCompilationHooks(e).renderRequire.tap("renderRequire",function(e){return _newArrowCheck(this,t),"var commonCachedModule = globalThis"+`["__common_module_cache__${_main.projectConfig.hashProjectPath}"] ? `+`globalThis["__common_module_cache__${_main.projectConfig.hashProjectPath}"]`+`[moduleId]: null;
`+`if (commonCachedModule) { return commonCachedModule.exports; }
`+e.replace("// Execute the module function",`function isCommonModue(moduleId) {
                if (globalThis["webpackChunk${_main.projectConfig.hashProjectPath}"]) {
                  const length = globalThis["webpackChunk${_main.projectConfig.hashProjectPath}"].length;
                  switch (length) {
                    case 1:
                      return globalThis["webpackChunk${_main.projectConfig.hashProjectPath}"][0][1][moduleId];
                    case 2:
                      return globalThis["webpackChunk${_main.projectConfig.hashProjectPath}"][0][1][moduleId] ||
                      globalThis["webpackChunk${_main.projectConfig.hashProjectPath}"][1][1][moduleId];
                  }
                }
                return undefined;
              }
`+`if (globalThis["__common_module_cache__${_main.projectConfig.hashProjectPath}"]`+` && String(moduleId).indexOf("?name=") < 0 && isCommonModue(moduleId)) {
`+`  globalThis["__common_module_cache__${_main.projectConfig.hashProjectPath}"]`+`[moduleId] = module;
}`)}.bind(this))}.bind(this)),e.hooks.entryOption.tap("beforeRun",function(){var t=this;_newArrowCheck(this,o);const r=[];Object.values(_main.projectConfig.entryObj).forEach(function(e){_newArrowCheck(this,t),r.push(e.replace("?entry",""))}.bind(this)),"true"===process.env.watchMode?_main.globalProgram.watchProgram=ts.createWatchProgram((0,_ets_checker.createWatchCompilerHost)(r,_ets_checker.printDiagnostic,this.delayPrintLogCount.bind(this),this.resetTsErrorCount)):(0,_ets_checker.serviceChecker)(r),(0,_utils.setChecker)()}.bind(this)),e.hooks.watchRun.tap("WatchRun",function(e){var t=this,r=(_newArrowCheck(this,o),process.env.watchEts="start",checkErrorMessage.clear(),this.clearCount(),e.modifiedFiles=e.modifiedFiles||[],e.removedFiles=e.removedFiles||[],[...e.modifiedFiles]),e=[...e.removedFiles];e.length&&(this.removedFiles=e),r.length&&r.some(function(e){if(_newArrowCheck(this,t),_fs.default.statSync(e).isFile()&&!/.(ts|ets)$/.test(e))return process.env.watchTs="end",!0}.bind(this)),(0,_utils.shouldWriteChangedList)(r,e)&&(0,_utils.writeFileSync)(_main.projectConfig.changedFileList,JSON.stringify((0,_utils.getHotReloadFiles)(r,e,_ets_checker.hotReloadSupportFiles))),(0,_ets_checker.incrementWatchFile)(r,e)}.bind(this)),e.hooks.done.tap("Result States",function(e){var r=this;_newArrowCheck(this,o),_main.projectConfig.isPreview&&_main.projectConfig.aceSoPath&&_validate_ui_syntax.useOSFiles&&0<_validate_ui_syntax.useOSFiles.size&&(0,_utils.writeUseOSFiles)(_validate_ui_syntax.useOSFiles),_main.projectConfig.compileHar&&this.incrementalFileInHar.forEach(function(e,t){_newArrowCheck(this,r);t=_fs.default.readFileSync(t,"utf-8");(0,_utils.writeFileSync)(e,t)}.bind(this)),this.mStats=e,this.warningCount=0,this.noteCount=0,this.mStats.compilation.warnings&&(this.mWarningCount=this.mStats.compilation.warnings.length),this.printResult()}.bind(this))}resetTsErrorCount(){_ets_checker.checkerResult.count=0,_ets_checker.warnCheckerResult.count=0}printResult(){this.printWarning(),this.printError(),"true"===process.env.watchMode?(process.env.watchEts="end",this.delayPrintLogCount(!0)):this.printLogCount()}delayPrintLogCount(e=!1){"end"===process.env.watchEts&&"end"===process.env.watchTs?(this.printLogCount(),process.env.watchTs="start",this.removedFiles=[]):e&&this.removedFiles.length&&0===this.mErrorCount&&0<this.mPreErrorCount&&this.printLogCount(),this.mPreErrorCount=this.mErrorCount}printLogCount(){var r=this.mErrorCount+_ets_checker.checkerResult.count,o=this.warningCount+_ets_checker.warnCheckerResult.count;if(0<r+o+this.noteCount||"false"===process.env.abcCompileSuccess){let e,t="";0<r?(t+="ERROR:"+r,e="FAIL ",process.exitCode=1):e="SUCCESS ","false"===process.env.abcCompileSuccess&&(e="FAIL "),0<o&&(t+=" WARN:"+o),0<this.noteCount&&(t+=" NOTE:"+this.noteCount),"SUCCESS "===e&&"true"===process.env.watchMode?this.printPreviewResult(t):logger.info(this.blue,"COMPILE RESULT:"+e+`{${t}}`,this.reset)}else"true"===process.env.watchMode?this.printPreviewResult():console.info(this.blue,"COMPILE RESULT:SUCCESS ",this.reset)}clearCount(){this.mErrorCount=0,this.warningCount=0,this.noteCount=0,process.env.abcCompileSuccess="true"}printPreviewResult(e=""){var t=Object.keys(_cluster.default.workers).length,r=this.blue,o=this.reset;0===t&&this.printSuccessInfo(r,o,e)}printSuccessInfo(e,t,r){_main.projectConfig.hotReload&&(this.hotReloadIncrementalTime.hotReloadIncrementalEndTime=(new Date).getTime().toString(),console.info(e,"Incremental build start: "+this.hotReloadIncrementalTime.hotReloadIncrementalStartTime+"\nIncremental build end: "+this.hotReloadIncrementalTime.hotReloadIncrementalEndTime,t)),0===r.length?console.info(e,"COMPILE RESULT:SUCCESS ",t):console.info(e,"COMPILE RESULT:SUCCESS "+`{${r}}`,t)}printWarning(){if(0<this.mWarningCount){var t=this.mStats.compilation.warnings,r=t.length;for(let e=0;e<r;e++){var o=t[e].message.replace(/^Module Warning\s*.*:\n/,"").replace(/\(Emitted value instead of an instance of Error\) BUILD/,"");/^NOTE/.test(o)?checkErrorMessage.has(o)||(this.noteCount++,logger.info(this.blue,o.replace(/^NOTE/,"ArkTS:NOTE"),this.reset,"\n"),checkErrorMessage.add(o)):checkErrorMessage.has(o)||(this.warningCount++,logger.warn(this.yellow,o.replace(/^WARN/,"ArkTS:WARN"),this.reset,"\n"),checkErrorMessage.add(o))}this.mWarningCount>r&&(this.warningCount=this.warningCount+this.mWarningCount-r)}}printError(){if(0<this.mStats.compilation.errors.length){var t,r,o=[...this.mStats.compilation.errors];for(let e=0;e<o.length;e++)o[e].issue?checkErrorMessage.has(o[e].issue)||(this.mErrorCount++,t=o[e].issue.location?`:${o[e].issue.location.start.line}:`+o[e].issue.location.start.column:"",t=o[e].issue.file.replace(/\\/g,"/")+t,r=o[e].issue.message,logger.error(this.red,"ArkTS:ERROR File: "+t,this.reset),logger.error(this.red,r,this.reset,"\n"),checkErrorMessage.add(o[e].issue)):/BUILDERROR/.test(o[e].message)?checkErrorMessage.has(o[e].message)||(this.mErrorCount++,t=o[e].message.replace(/^Module Error\s*.*:\n/,"").replace(/\(Emitted value instead of an instance of Error\) BUILD/,"").replace(/^ERROR/,"ArkTS:ERROR"),this.printErrorMessage(t,!0,o[e]),checkErrorMessage.add(o[e].message)):/TS[0-9]+:/.test(o[e].message.toString())||/Module parse failed/.test(o[e].message.toString())||(this.mErrorCount++,r=o[e].message.replace(/\[tsl\]\s*/,"").replace(/\u001b\[.*?m/g,"").replace(/\.ets\.ts/g,".ets").trim()+`
`,r=this.filterModuleError(r).replace(/^ERROR in /,"ArkTS:ERROR File: ").replace(/\s{6}TS/g," TS").replace(/\(([0-9]+),([0-9]+)\)/,":$1:$2"),this.printErrorMessage((0,_utils.parseErrorMessage)(r),!1,o[e]))}}printErrorMessage(e,t,r){e=e.replace(/\\/g,"/");t?logger.error(this.red,e+"\n",this.reset):logger.error(this.red,e,this.reset)}filterModuleError(e){var t,r;return e=/You may need an additional loader/.test(e)&&_process_ui_syntax.transformLog&&_process_ui_syntax.transformLog.sourceFile&&(t=_process_ui_syntax.transformLog.sourceFile.fileName,r=e.split("You may need an additional loader to handle the result of these loaders."))&&1<r.length&&r[1]?`ERROR in ${t}
 The following syntax is incorrect.`+r[1]:e}}function handleFinishModules(e,t){var o=this;_main.projectConfig.compileHar&&e.forEach(function(e){var t,r;_newArrowCheck(this,o),void 0===e||void 0===e.resourceResolveData||(e=e.resourceResolveData.path).match(/node_modules/)||(t=(0,_utils.genTemporaryPath)(e,_main.projectConfig.moduleRootPath,process.env.cachePath,_main.projectConfig),r=(0,_utils.genTemporaryPath)(e,_main.projectConfig.moduleRootPath,_main.projectConfig.buildPath,_main.projectConfig,!0),e.match(/\.e?ts$/)?(this.incrementalFileInHar.set(t.replace(/\.ets$/,".d.ets").replace(/\.ts$/,".d.ts"),r.replace(/\.ets$/,".d.ets").replace(/\.ts$/,".d.ts")),this.incrementalFileInHar.set(t.replace(/\.e?ts$/,".js"),r.replace(/\.e?ts$/,".js"))):this.incrementalFileInHar.set(t,r))}.bind(this))}exports.ResultStates=ResultStates;