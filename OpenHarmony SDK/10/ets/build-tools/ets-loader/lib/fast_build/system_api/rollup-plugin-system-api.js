"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.apiTransform=apiTransform,exports.appImportModuleCollection=void 0;var _magicString=_interopRequireDefault(require("magic-string")),_pluginutils=require("@rollup/pluginutils"),_path=_interopRequireDefault(require("path")),_pre_define=require("../../pre_define"),_main=require("../../../main"),_utils=require("../../utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,i){if(e!==i)throw new TypeError("Cannot instantiate an arrow function")}const filter=(0,_pluginutils.createFilter)(/(?<!\.d)\.(ets|ts|js)$/),allFiles=new Set,appImportModuleCollection=new Map;function apiTransform(){const r=new Set;return{name:"apiTransform",load(e){allFiles.add(_path.default.join(e))},transform(e,i){var o=new _magicString.default(e);return{code:e=filter(i)?"esmodule"===_main.projectConfig.compileMode?processSystemApiAndLibso(e,i,r):processLibso(e=processSystemApi(e,i),i,r):e,map:o.generateMap({hires:!0})}},beforeBuildEnd(){this.share.allComponents=(0,_utils.getAllComponentsOrModules)(allFiles,"component_collection.json"),this.share.allFiles=allFiles},buildEnd(){var e;_main.projectConfig.isPreview&&_main.projectConfig.aceSoPath&&r&&0<r.size&&(0,_utils.writeUseOSFiles)(r),"true"===process.env.watchMode||_main.projectConfig.xtsMode||(e=(0,_utils.getAllComponentsOrModules)(allFiles,"module_collection.json"),(0,_utils.writeCollectionFile)(_main.projectConfig.cachePath,appImportModuleCollection,e,"module_collection.json"))}}}function processSystemApi(e,l){var a=this,i=new RegExp(`import\\s+(.+)\\s+from\\s+['"]@(${_main.sdkConfigPrefix})\\.(\\S+)['"]|import\\s+(.+)\\s*=\\s*require\\(\\s*['"]@(${_main.sdkConfigPrefix})\\.(\\S+)['"]\\s*\\)`,"g");return appImportModuleCollection.set(_path.default.join(l),new Set),e.replace(i,function(e,i,o,r,t,n,s){_newArrowCheck(this,a);o=o||n,n=r||s,r=i||t,s=o+"."+n,appImportModuleCollection.get(_path.default.join(l)).add(s),checkModuleExist(s,l),i=isExtendModuleType(o)&&o!==_pre_define.ARKUI_X_PLUGIN?`, false, '', '${o}'`:"";return _pre_define.NATIVE_MODULE.has(s)?e=`var ${r} = ${_pre_define.GLOBAL_THIS_REQUIRE_NATIVE_MODULE}('${o}.${n}')`:checkModuleType(o)&&(e=`var ${r} = ${_pre_define.GLOBAL_THIS_REQUIRE_NAPI}('${n}'${i})`),e}.bind(this))}function isExtendModuleType(i){for(let e=0;e<_main.extendSdkConfigs.length;e++)if(_main.extendSdkConfigs[e].prefix==="@"+i)return!0;return!1}function checkModuleType(i){for(let e=0;e<_main.sdkConfigs.length;e++)if(_main.sdkConfigs[e].prefix==="@"+i)return!0;return!1}function checkModuleExist(e,i){e=`@${e.trim()}.d.ts`;/\.js$/.test(i)&&!_main.systemModules.includes(e)&&console.error(`BUILDERROR File: ${i}
 `+`Cannot find module '${e}' or its corresponding type declarations.`)}function processLibso(e,n,s){var l=this;return e.replace(/import\s+(.+)\s+from\s+['"]lib(\S+)\.so['"]|import\s+(.+)\s*=\s*require\(\s*['"]lib(\S+)\.so['"]\s*\)/g,function(e,i,o,r,t){_newArrowCheck(this,l),s.add(n);i=i||r,r=o||t;return _main.projectConfig.bundleName&&_main.projectConfig.moduleName?`var ${i} = globalThis.requireNapi("${r}", true, "${_main.projectConfig.bundleName}/${_main.projectConfig.moduleName}");`:`var ${i} = globalThis.requireNapi("${r}", true);`}.bind(this))}function processSystemApiAndLibso(e,l,n){var a=this,i=new RegExp(`import\\s+(.+)\\s*=\\s*require\\(\\s*['"]@(${_main.sdkConfigPrefix})\\.(\\S+)['"]\\s*\\)`,"g"),o=new RegExp(`import\\s+(.+)\\s+from\\s+['"]@(${_main.sdkConfigPrefix})\\.(\\S+)['"]`,"g");return appImportModuleCollection.set(_path.default.join(l),new Set),e.replace(o,function(e,i,o,r,t,n,s){_newArrowCheck(this,a);o=(o||n)+"."+(r||s);return appImportModuleCollection.get(_path.default.join(l)).add(o),e}.bind(this)),e.replace(i,function(e,i,o,r,t,n,s){_newArrowCheck(this,a);o=o||n,n=r||s,r=i||t,s=o+"."+n;return appImportModuleCollection.get(_path.default.join(l)).add(s),checkModuleExist(s,l),`import ${r} from '@${o}.${n}'`}.bind(this)).replace(/import\s+(.+)\s+from\s+['"]lib(\S+)\.so['"]|import\s+(.+)\s*=\s*require\(\s*['"]lib(\S+)\.so['"]\s*\)/g,function(e,i,o,r,t){return _newArrowCheck(this,a),n.add(l),`import ${i||r} from 'lib${o||t}.so'`}.bind(this))}exports.appImportModuleCollection=appImportModuleCollection;