"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.visualTransform=visualTransform;var _fs=_interopRequireDefault(require("fs")),_pluginutils=require("@rollup/pluginutils"),_process_visual=require("../../process_visual"),_magicString=_interopRequireDefault(require("magic-string")),_main=require("../../../main");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}const filter=(0,_pluginutils.createFilter)(/(?<!\.d)\.ets$/);function visualTransform(){return{name:"visualTransform",transform(e,s){var i;return!filter(s)||"true"!==process.env.watchMode&&"esmodule"===_main.projectConfig.compileMode?null:(i=this.share.getLogger("visualTransform"),{code:e=(0,_process_visual.visualTransform)(e,s,i),map:new _magicString.default(e).generateMap({hires:!0})})},shouldInvalidCache(e){var s,i;return(0,_process_visual.getHasSearchedVisualFiles)()||(0,_process_visual.findIfVisualFileExists)(),!(void 0!==_main.projectConfig.modulePathMap&&!(0,_process_visual.getHasVisual)()||(e=e.id,!filter(e))||!e||((e=(0,_process_visual.findVisualFile)(e))&&_fs.default.existsSync(e)?(s=_fs.default.statSync(e).mtime.getTime(),this.cache.has(e)?(i=this.cache.get(e),this.cache.set(e,s),s===i):(this.cache.set(e,s),"true"!==process.env.watchMode&&"esmodule"===_main.projectConfig.compileMode)):(this.cache.has(e)&&this.cache.delete(e),1)))}}}