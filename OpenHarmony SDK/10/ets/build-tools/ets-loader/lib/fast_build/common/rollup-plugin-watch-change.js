"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.watchChangeFiles=watchChangeFiles;var _path=_interopRequireDefault(require("path")),_utils=require("../../utils"),_main=require("../../../main"),_ets_checker=require("../../ets_checker");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function watchChangeFiles(){function t(e,s){let t=[];(this.cache&&this.cache.has(e)?t=this.cache.get(e):t).push(s),this.cache.set(e,t)}return{name:"watchChangedFiles",watchChange(e,s){"update"===s.event&&t.call(this,"watchModifiedFiles",e),["create","delete"].includes(s.event)&&t.call(this,"watchRemovedFiles",e),_ets_checker.files[_path.default.resolve(e)]?_ets_checker.files[_path.default.resolve(e)].version++:_ets_checker.files[_path.default.resolve(e)]={version:1},_path.default.resolve(e)===_path.default.resolve(process.env.appResource)&&"moduleJson"===process.env.compileMode&&(_utils.storedFileInfo.resourceTableChanged=!0,_utils.storedFileInfo.resourceList.clear(),(0,_main.readAppResource)(process.env.appResource),process.env.rawFileResource)&&((0,_utils.resourcesRawfile)(process.env.rawFileResource,_utils.storedFileInfo.resourcesArr),this.share.rawfilechanged=(0,_utils.differenceResourcesRawfile)(_utils.storedFileInfo.lastResourcesSet,_utils.storedFileInfo.resourcesArr))},beforeBuild(){this.cache.set("watchChangedFilesCache","watchChangedFiles");var e=this.cache.get("watchModifiedFiles")||[],s=this.cache.get("watchRemovedFiles")||[];(0,_utils.shouldWriteChangedList)(e,s)&&(0,_utils.writeFileSync)(_main.projectConfig.changedFileList,JSON.stringify((0,_utils.getHotReloadFiles)(e,s,_ets_checker.hotReloadSupportFiles))),(0,_ets_checker.incrementWatchFile)(e,s),this.cache.get("lastWatchResourcesArr")&&(_utils.storedFileInfo.lastResourcesSet=new Set([...this.cache.get("lastWatchResourcesArr")]))}}}