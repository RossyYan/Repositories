"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.etsTransform=etsTransform;var _typescript=_interopRequireDefault(require("typescript")),_path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),_pluginutils=require("@rollup/pluginutils"),_magicString=_interopRequireDefault(require("magic-string")),_utils=require("../../utils"),_validate_ui_syntax=require("../../validate_ui_syntax"),_process_ui_syntax=require("../../process_ui_syntax"),_main=require("../../../main"),_ets_checker=require("../../ets_checker"),_component_map=require("../../component_map"),_this2=void 0;function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}const filter=(0,_pluginutils.createFilter)(/(?<!\.d)\.(ets|ts)$/);let shouldDisableCache=!1;const disableCacheOptions={bundleName:"default",entryModuleName:"default",runtimeOS:"default",resourceTableHash:"default",etsLoaderVersion:"default"};function etsTransform(){const o=new Map;let r;return{name:"etsTransform",transform:transform,buildStart(){judgeCacheShouldDisabled.call(this),"moduleJson"===process.env.compileMode&&(r=this.cache.get("transformCacheFiles"),_utils.storedFileInfo.addGlobalCacheInfo(this.cache.get("resourceListCacheInfo"),this.cache.get("resourceToFileCacheInfo")),this.cache.get("lastResourcesArr")&&(_utils.storedFileInfo.lastResourcesSet=new Set([...this.cache.get("lastResourcesArr")])),process.env.rawFileResource)&&((0,_utils.resourcesRawfile)(process.env.rawFileResource,_utils.storedFileInfo.resourcesArr),this.share.rawfilechanged=(0,_utils.differenceResourcesRawfile)(_utils.storedFileInfo.lastResourcesSet,_utils.storedFileInfo.resourcesArr))},load(e){let t;this.cache.get("fileCacheInfo")&&(t=this.cache.get("fileCacheInfo")[_path.default.resolve(e)]),_main.projectConfig.isPreview&&!_main.projectConfig.checkEntry&&e.match(/(?<!\.d)\.(ets)$/)&&(_main.abilityPagesFullPath.push(_path.default.resolve(e).toLowerCase()),_utils.storedFileInfo.judgeShouldHaveEntryFiles(_main.abilityPagesFullPath)),_utils.storedFileInfo.addFileCacheInfo(_path.default.resolve(e),t),_utils.storedFileInfo.setCurrentArkTsFile()},shouldInvalidCache(e){e=_path.default.resolve(e.id);let t=shouldDisableCache||disableNonEntryFileCache(e);if("moduleJson"===process.env.compileMode&&(t=t||_utils.storedFileInfo.shouldInvalidFiles.has(e)||this.share.rawfilechanged,r)&&r[e]&&r[e].children.length)for(var s of r[e].children)if((_fs.default.existsSync(s.fileName)?_fs.default.statSync(s.fileName).mtimeMs:-1)!==s.mtimeMs){t=!0;break}return t||_utils.storedFileInfo.collectCachedFiles(e),t},moduleParsed(e){var t,s;_main.projectConfig.compileHar&&e.id&&!e.id.match(new RegExp(_main.projectConfig.packageDir))&&!e.id.startsWith("\0")&&_path.default.resolve(e.id).startsWith(_main.projectConfig.moduleRootPath+_path.default.sep)&&(e=e.id,t=(0,_utils.genTemporaryPath)(e,_main.projectConfig.moduleRootPath,process.env.cachePath,_main.projectConfig),s=(0,_utils.genTemporaryPath)(e,_main.projectConfig.moduleRootPath,_main.projectConfig.buildPath,_main.projectConfig,!0),e.match(/\.e?ts$/)?(o.set(t.replace(/\.ets$/,".d.ets").replace(/\.ts$/,".d.ts"),s.replace(/\.ets$/,".d.ets").replace(/\.ts$/,".d.ts")),o.set(t.replace(/\.e?ts$/,".js"),s.replace(/\.e?ts$/,".js"))):o.set(t,s))},afterBuildEnd(){var s=this;_main.projectConfig.compileHar&&o.forEach(function(e,t){_newArrowCheck(this,s),_fs.default.existsSync(t)&&(t=_fs.default.readFileSync(t,"utf-8"),(0,_utils.writeFileSync)(e,t))}.bind(this)),"true"===process.env.watchMode||_main.projectConfig.xtsMode||(0,_utils.writeCollectionFile)(_main.projectConfig.cachePath,_ets_checker.appComponentCollection,this.share.allComponents,"component_collection.json",this.share.allFiles),shouldDisableCache=!1,this.cache.set("disableCacheOptions",disableCacheOptions),this.cache.set("lastResourcesArr",[..._utils.storedFileInfo.resourcesArr]),_utils.storedFileInfo.clearCollectedInfo(this.cache),this.cache.set("transformCacheFiles",_utils.storedFileInfo.transformCacheFiles)}}}function disableNonEntryFileCache(e){return _utils.storedFileInfo.buildStart&&e.match(/(?<!\.d)\.(ets)$/)&&!_utils.storedFileInfo.wholeFileInfo[e].hasEntry&&_utils.storedFileInfo.shouldHaveEntry.includes(e)}function judgeCacheShouldDisabled(){for(const e in disableCacheOptions)this.cache.get("disableCacheOptions")&&this.share&&this.share.projectConfig&&this.share.projectConfig[e]&&this.cache.get("disableCacheOptions")[e]!==this.share.projectConfig[e]&&("resourceTableHash"===e&&"moduleJson"===process.env.compileMode?_utils.storedFileInfo.resourceTableChanged=!0:shouldDisableCache=shouldDisableCache||!0),this.share&&this.share.projectConfig&&this.share.projectConfig[e]&&(disableCacheOptions[e]=this.share.projectConfig[e]),_utils.storedFileInfo.judgeShouldHaveEntryFiles(_main.abilityPagesFullPath)}const compilerHost=_typescript.default.createCompilerHost(_ets_checker.compilerOptions);async function transform(e,t){var s=this;if(!filter(t))return null;_utils.storedFileInfo.collectTransformedFiles(_path.default.resolve(t));var o,r=this.share.getLogger("etsTransform");if("esmodule"!==_main.projectConfig.compileMode)return(n=_typescript.default.readConfigFile(_path.default.resolve(__dirname,"../../../tsconfig.json"),_typescript.default.sys.readFile).config.compilerOptions).moduleResolution="nodenext",n.module="es2020",o=jsBundlePreProcess(e,t,this.getModuleInfo(t).isEntry,r),o=_typescript.default.transpileModule(o,{compilerOptions:n,fileName:t,transformers:{before:[(0,_process_ui_syntax.processUISyntax)(null)]}}),resetCollection(),_process_ui_syntax.transformLog&&_process_ui_syntax.transformLog.errors.length&&!_main.projectConfig.ignoreWarning&&((0,_utils.emitLogInfo)(r,(0,_utils.getTransformLog)(_process_ui_syntax.transformLog),!0,t),(0,_process_ui_syntax.resetLog)()),{code:o.outputText,map:o.sourceMapText?JSON.parse(o.sourceMapText):new _magicString.default(e).generateMap()};let i=_main.globalProgram.program,a=i.getSourceFile(t);a?(_utils.storedFileInfo.reUseProgram||(_main.globalProgram.checker=_main.globalProgram.program.getTypeChecker()),_utils.storedFileInfo.reUseProgram=!0):(_utils.storedFileInfo.isFirstBuild&&_utils.storedFileInfo.changeFiles&&(_utils.storedFileInfo.newTsProgram=_typescript.default.createProgram(_utils.storedFileInfo.changeFiles,_ets_checker.compilerOptions,compilerHost),_utils.storedFileInfo.isFirstBuild=!1),i=_utils.storedFileInfo.newTsProgram&&_utils.storedFileInfo.newTsProgram.getSourceFile(t)?_utils.storedFileInfo.newTsProgram:_typescript.default.createProgram([t],_ets_checker.compilerOptions,compilerHost),_main.globalProgram.checker=i.getTypeChecker(),a=i.getSourceFile(t),_utils.storedFileInfo.reUseProgram=!1),validateEts(e,a.fileName=t,this.getModuleInfo(t).isEntry,r,a);const l={outputText:"",sourceMapText:""};var n=function(e,t){_newArrowCheck(this,s),/.map$/.test(e)?l.sourceMapText=t:l.outputText=t}.bind(this);i.getCompilerOptions().noEmit=!1;try{i.emit(a,n,void 0,void 0,{before:[(0,_process_ui_syntax.processUISyntax)(null)]})}finally{i.getCompilerOptions().noEmit=!0}return resetCollection(),_process_ui_syntax.transformLog&&_process_ui_syntax.transformLog.errors.length&&!_main.projectConfig.ignoreWarning&&((0,_utils.emitLogInfo)(r,(0,_utils.getTransformLog)(_process_ui_syntax.transformLog),!0,t),(0,_process_ui_syntax.resetLog)()),{code:l.outputText,map:l.sourceMapText?JSON.parse(l.sourceMapText):new _magicString.default(e).generateMap()}}function validateEts(e,t,s,o,r){/\.ets$/.test(t)&&(clearCollection(),s=s&&!_main.abilityPagesFullPath.includes(_path.default.resolve(t).toLowerCase())?"?entry":"",(e=(0,_validate_ui_syntax.validateUISyntax)(e,e,t,s,r)).length)&&!_main.projectConfig.ignoreWarning&&(0,_utils.emitLogInfo)(o,e,!0,t)}function jsBundlePreProcess(e,t,s,o){var r;return/\.ets$/.test(t)?(clearCollection(),r=(0,_validate_ui_syntax.preprocessExtend)(e),r=(0,_validate_ui_syntax.preprocessNewExtend)(r),s=s&&!_main.abilityPagesFullPath.includes(_path.default.resolve(t).toLowerCase())?"?entry":"",(s=(0,_validate_ui_syntax.validateUISyntax)(e,r,t,s)).length&&!_main.projectConfig.ignoreWarning&&(0,_utils.emitLogInfo)(o,s,!0,t),r):e}function clearCollection(){_validate_ui_syntax.componentCollection.customComponents.clear(),_component_map.CUSTOM_BUILDER_METHOD.clear(),_component_map.GLOBAL_CUSTOM_BUILDER_METHOD.clear(),_component_map.INNER_CUSTOM_BUILDER_METHOD.clear(),_utils.storedFileInfo.getCurrentArkTsFile().compFromDETS.clear()}function resetCollection(){_utils.componentInfo.id=0,_validate_ui_syntax.propertyCollection.clear(),_validate_ui_syntax.linkCollection.clear(),(0,_validate_ui_syntax.resetComponentCollection)()}compilerHost.writeFile=function(){_newArrowCheck(this,_this2)}.bind(void 0),compilerHost.resolveModuleNames=_ets_checker.resolveModuleNames,compilerHost.getCurrentDirectory=function(){return _newArrowCheck(this,_this2),process.cwd()}.bind(void 0),compilerHost.getDefaultLibFileName=function(e){return _newArrowCheck(this,_this2),_typescript.default.getDefaultLibFilePath(e)}.bind(void 0),compilerHost.resolveTypeReferenceDirectives=_ets_checker.resolveTypeReferenceDirectives;