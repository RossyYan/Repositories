"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.etsChecker=etsChecker,exports.tsWatchEndPromise=exports.tsWatchEmitter=void 0;var _path=_interopRequireDefault(require("path")),_events=require("events"),_main=require("../../../main"),_ets_checker=require("../../ets_checker"),_pre_define=require("../../pre_define"),_utils=require("../../utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}let tsWatchEmitter=void 0;exports.tsWatchEmitter=tsWatchEmitter;let tsWatchEndPromise;function etsChecker(){let s=!1;return{name:"etsChecker",buildStart(){var r=this,e=("true"===process.env.watchMode&&"true"===process.env.triggerTsWatch&&(exports.tsWatchEmitter=tsWatchEmitter=new _events.EventEmitter,exports.tsWatchEndPromise=tsWatchEndPromise=new Promise(function(e){var t=this;_newArrowCheck(this,r),tsWatchEmitter.on(_pre_define.TS_WATCH_END_MSG,function(){_newArrowCheck(this,t),e()}.bind(this))}.bind(this))),Object.assign(_main.projectConfig,this.share.projectConfig),Object.assign(this.share.projectConfig,{compileHar:_main.projectConfig.compileHar,compileShared:_main.projectConfig.compileShared,moduleRootPath:_main.projectConfig.moduleRootPath,buildPath:_main.projectConfig.buildPath,isCrossplatform:_main.projectConfig.isCrossplatform}),this.share.getLogger("etsChecker"));const t=[];var i=[];Object.values(_main.projectConfig.entryObj).forEach(function(e){_newArrowCheck(this,r),t.push(_path.default.resolve(e))}.bind(this)),this.share&&this.share.projectConfig&&this.share.projectConfig.resolveModulePaths&&Array.isArray(this.share.projectConfig.resolveModulePaths)&&i.push(...this.share.projectConfig.resolveModulePaths),"true"===process.env.watchMode?(s||(0,_ets_checker.serviceChecker)(t,e,i),s=!0,_main.globalProgram.program=_ets_checker.languageService.getProgram(),_main.globalProgram.program.getSyntacticDiagnostics().concat(_main.globalProgram.program.getSemanticDiagnostics()).concat(_main.globalProgram.program.getDeclarationDiagnostics()).forEach(function(e){_newArrowCheck(this,r),(0,_ets_checker.printDiagnostic)(e)}.bind(this)),_ets_checker.fastBuildLogger.debug(_pre_define.TS_WATCH_END_MSG),tsWatchEmitter.emit(_pre_define.TS_WATCH_END_MSG)):(0,_ets_checker.serviceChecker)(t,e,i),(0,_utils.setChecker)()}}}exports.tsWatchEndPromise=tsWatchEndPromise;