"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.BundleMode=void 0;var _path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),_cluster=_interopRequireDefault(require("cluster")),_child_process=_interopRequireDefault(require("child_process")),_common_mode=require("../common/common_mode"),_utils=require("../utils"),_ark_define=require("../common/ark_define"),_utils2=require("../../../utils"),_ark_utils=require("../../../ark_utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}function _defineProperty(e,t,i){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==typeof e?e:String(e)}function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0===i)return("string"===t?String:Number)(e);i=i.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}class BundleMode extends _common_mode.CommonMode{constructor(e,t){super(e),_defineProperty(this,"intermediateJsBundle",void 0),_defineProperty(this,"filterIntermediateJsBundle",void 0),_defineProperty(this,"hashJsonObject",void 0),_defineProperty(this,"filesInfoPath",void 0),this.intermediateJsBundle=new Map,this.filterIntermediateJsBundle=[],this.hashJsonObject={},this.filesInfoPath="",this.prepareForCompilation(e,t)}prepareForCompilation(e,t){this.collectBundleFileList(t),this.removeCacheInfo(e),this.filterBundleFileListWithHashJson()}collectBundleFileList(s){var e=this;Object.keys(s).forEach(function(t){if(_newArrowCheck(this,e),this.projectConfig.aceModuleBuild&&(0,_utils.isSpecifiedExt)(t,_ark_define.EXTNAME_JS)){var i=(0,_utils.changeFileExtension)(t,_ark_define.TEMP_JS),r=_path.default.resolve(this.projectConfig.aceModuleBuild,i),i=this.genCacheBundleFilePath(r,i);let e="";"asset"===s[t].type?e=s[t].source:"chunk"===s[t].type?e=s[t].code:this.throwArkTsCompilerError("ArkTS:ERROR failed to get rollup bundle file source code"),_fs.default.writeFileSync(i,e,"utf-8"),_fs.default.existsSync(i)||this.throwArkTsCompilerError("ArkTS:ERROR failed to generate cached source file"),this.collectIntermediateJsBundle(r,i)}}.bind(this))}filterBundleFileListWithHashJson(){var t=this;if(0!==this.intermediateJsBundle.size)if(_fs.default.existsSync(this.hashJsonFilePath)&&0!==this.hashJsonFilePath.length){var e={},i=_fs.default.readFileSync(this.hashJsonFilePath).toString(),r=JSON.parse(i);this.filterIntermediateJsBundle=[];for(const l of this.intermediateJsBundle.values()){var s=l.cacheFilePath,n=(0,_utils.changeFileExtension)(s,_ark_define.EXTNAME_ABC);if(_fs.default.existsSync(s)||this.throwArkTsCompilerError(`ArkTS:ERROR ${s} is lost`),_fs.default.existsSync(n)){var o=(0,_utils2.toHashData)(s),a=(0,_utils2.toHashData)(n);if(r[s]===o&&r[n]===a){e[s]=o,e[n]=a;continue}}this.filterIntermediateJsBundle.push(l)}this.hashJsonObject=e}else this.intermediateJsBundle.forEach(function(e){_newArrowCheck(this,t),this.filterIntermediateJsBundle.push(e)}.bind(this))}executeArkCompiler(){var e;(0,_ark_utils.isEs2Abc)(this.projectConfig)?(this.filesInfoPath=this.generateFileInfoOfBundle(),this.generateEs2AbcCmd(this.filesInfoPath),this.executeEs2AbcCmd()):(0,_ark_utils.isTs2Abc)(this.projectConfig)?(e=this.getSplittedBundles(),this.invokeTs2AbcWorkersToGenAbc(e)):this.throwArkTsCompilerError(`Invalid projectConfig.pandaMode for bundle build, should be either
        "${_ark_define.TS2ABC}" or "${_ark_define.ES2ABC}"`)}afterCompilationProcess(){this.writeHashJson(),this.copyFileFromCachePathToOutputPath(),this.cleanTempCacheFiles()}generateEs2AbcCmd(e){var t=(0,_utils.getEs2abcFileThreadNumber)();this.cmdArgs.push(`"@${e}"`,"--file-threads",`"${t}"`)}generateFileInfoOfBundle(){var r=this,e=(0,_utils.genCachePath)(_ark_define.FILESINFO_TXT,this.projectConfig,this.logger);let s="";return this.filterIntermediateJsBundle.forEach(function(e){_newArrowCheck(this,r);var t=e.cacheFilePath,e=e.sourceFile,i=(0,_utils.changeFileExtension)(t,_ark_define.EXTNAME_ABC);s+=t+`;null_recordName;script;${e};${i}
`}.bind(this)),_fs.default.writeFileSync(e,s,"utf-8"),e}executeEs2AbcCmd(){var t=this;let i="";const e=this.cmdArgs.join(" ");try{var r=this.triggerAsync(function(){return _newArrowCheck(this,t),_child_process.default.exec(e,{windowsHide:!0})}.bind(this));r.on("exit",function(e){_newArrowCheck(this,t),e===_ark_define.FAIL&&this.throwArkTsCompilerError("ArkTS:ERROR failed to execute es2abc"),this.afterCompilationProcess(),this.triggerEndSignal()}.bind(this)),r.on("error",function(e){_newArrowCheck(this,t),this.throwArkTsCompilerError(e.toString())}.bind(this)),r.stderr.on("data",function(e){_newArrowCheck(this,t),i+=e.toString()}.bind(this)),r.stderr.on("end",function(){_newArrowCheck(this,t),void 0!==i&&0<i.length&&this.logger.error(_ark_define.red,i,_ark_define.reset)}.bind(this))}catch(e){this.throwArkTsCompilerError("ArkTS:ERROR failed to execute es2abc with async handler: "+e.toString())}}genCacheBundleFilePath(e,t){let i="";i=this.projectConfig.cachePath?_path.default.join((0,_utils.genTemporaryModuleCacheDirectoryForBundle)(this.projectConfig),t):e,(0,_utils2.validateFilePathLength)(i,this.logger);t=_path.default.join(i,"..");return _fs.default.existsSync(t)&&_fs.default.statSync(t).isDirectory()||(0,_utils2.mkDir)(t),i}collectIntermediateJsBundle(e,t){var i=_fs.default.statSync(t).size;let r=(0,_utils.changeFileExtension)(e,"_.js",_ark_define.TEMP_JS);!this.arkConfig.isDebug&&this.projectConfig.projectRootPath&&(r=r.replace(this.projectConfig.projectRootPath+_path.default.sep,""));t={filePath:e=(0,_utils2.toUnixPath)(e),cacheFilePath:t=(0,_utils2.toUnixPath)(t),sourceFile:r=(0,_utils2.toUnixPath)(r),size:i};this.intermediateJsBundle.set(e,t)}getSplittedBundles(){return this.splitJsBundlesBySize(this.filterIntermediateJsBundle,_ark_define.MAX_WORKER_NUMBER)}invokeTs2AbcWorkersToGenAbc(t){var s=this;if((0,_utils.isMasterOrPrimary)()){this.setupCluster(_cluster.default);const n=t.length<_ark_define.MAX_WORKER_NUMBER?t.length:_ark_define.MAX_WORKER_NUMBER;for(let e=0;e<n;++e){const i={inputs:JSON.stringify(t[e]),cmd:this.cmdArgs.join(" "),mode:_ark_define.JSBUNDLE};this.triggerAsync(function(){var t=this;_newArrowCheck(this,s),_cluster.default.fork(i).on("message",function(e){_newArrowCheck(this,t),this.logger.error(_ark_define.red,e.data.toString(),_ark_define.reset),this.throwArkTsCompilerError("ArkTS:ERROR failed to execute ts2abc, received error message.")}.bind(this))}.bind(this))}let r=0;_cluster.default.on("exit",function(e,t,i){_newArrowCheck(this,s),t===_ark_define.FAIL&&this.throwArkTsCompilerError("ArkTS:ERROR failed to execute ts2abc, exit code non-zero"),++r===n&&this.afterCompilationProcess(),this.triggerEndSignal()}.bind(this))}}getSmallestSizeGroup(e){e=Array.from(e);return e.sort(function(e,t){return e[1]-t[1]}),e[0][0]}splitJsBundlesBySize(t,i){var r=[];if(t.length<i)for(const e of t)r.push([e]);else{t.sort(function(e,t){return t.size-e.size});var s=new Map;for(let e=0;e<i;++e)r.push([]),s.set(e,0);let e=0;for(;e<t.length;){var n=this.getSmallestSizeGroup(s),o=(r[n].push(t[e]),s.get(n)+t[e].size);s.set(n,o),e++}}return r}writeHashJson(){if(0!==this.hashJsonFilePath.length){for(let e=0;e<this.filterIntermediateJsBundle.length;++e){var t=this.filterIntermediateJsBundle[e].cacheFilePath,i=(0,_utils.changeFileExtension)(t,_ark_define.EXTNAME_ABC),r=(_fs.default.existsSync(t)&&_fs.default.existsSync(i)||this.throwArkTsCompilerError(`ArkTS:ERROR ${t} or ${i} is lost`),(0,_utils2.toHashData)(t)),s=(0,_utils2.toHashData)(i);this.hashJsonObject[t]=r,this.hashJsonObject[i]=s}_fs.default.writeFileSync(this.hashJsonFilePath,JSON.stringify(this.hashJsonObject),"utf-8")}}copyFileFromCachePathToOutputPath(){for(const r of this.intermediateJsBundle.values()){var e=(0,_utils.changeFileExtension)(r.filePath,_ark_define.EXTNAME_ABC,_ark_define.TEMP_JS),t=(0,_utils.changeFileExtension)(r.cacheFilePath,_ark_define.EXTNAME_ABC),i=(_fs.default.existsSync(t)||this.throwArkTsCompilerError(`ArkTS:ERROR ${t} is lost`),_path.default.join(e,".."));_fs.default.existsSync(i)&&_fs.default.statSync(i).isDirectory()||(0,_utils2.mkDir)(i),void 0!==this.projectConfig.cachePath&&_fs.default.copyFileSync(t,e)}}cleanTempCacheFiles(){if(void 0===this.projectConfig.cachePath){for(const e of this.intermediateJsBundle.values())_fs.default.existsSync(e.cacheFilePath)&&_fs.default.unlinkSync(e.cacheFilePath);(0,_ark_utils.isEs2Abc)(this.projectConfig)&&_fs.default.existsSync(this.filesInfoPath)&&(0,_utils2.unlinkSync)(this.filesInfoPath)}}removeCompilationCache(){_fs.default.existsSync(this.hashJsonFilePath)&&_fs.default.unlinkSync(this.hashJsonFilePath)}}exports.BundleMode=BundleMode;