"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackageEntryInfo=exports.ModuleMode=exports.ModuleInfo=void 0;var _child_process=_interopRequireDefault(require("child_process")),_fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),_cluster=_interopRequireDefault(require("cluster")),_ark_define=require("../common/ark_define"),_utils=require("../utils"),_common_mode=require("../common/common_mode"),_transform=require("../transform"),_utils2=require("../../../utils"),_ark_utils=require("../../../ark_utils"),_gen_aot=require("../../../gen_aot");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}function _defineProperty(e,t,i){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==typeof e?e:String(e)}function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0===i)return("string"===t?String:Number)(e);i=i.call(e,t||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}class ModuleInfo{constructor(e,t,i,r,s,o){_defineProperty(this,"filePath",void 0),_defineProperty(this,"cacheFilePath",void 0),_defineProperty(this,"recordName",void 0),_defineProperty(this,"isCommonJs",void 0),_defineProperty(this,"sourceFile",void 0),_defineProperty(this,"packageName",void 0),this.filePath=e,this.cacheFilePath=t,this.recordName=r,this.isCommonJs=i,this.sourceFile=s,this.packageName=o}}exports.ModuleInfo=ModuleInfo;class PackageEntryInfo{constructor(e,t){_defineProperty(this,"pkgEntryPath",void 0),_defineProperty(this,"pkgBuildPath",void 0),this.pkgEntryPath=e,this.pkgBuildPath=t}}exports.PackageEntryInfo=PackageEntryInfo;class ModuleMode extends _common_mode.CommonMode{constructor(e){super(e),_defineProperty(this,"moduleInfos",void 0),_defineProperty(this,"pkgEntryInfos",void 0),_defineProperty(this,"hashJsonObject",void 0),_defineProperty(this,"cacheSourceMapObject",void 0),_defineProperty(this,"filesInfoPath",void 0),_defineProperty(this,"npmEntriesInfoPath",void 0),_defineProperty(this,"moduleAbcPath",void 0),_defineProperty(this,"sourceMapPath",void 0),_defineProperty(this,"cacheFilePath",void 0),_defineProperty(this,"cacheSourceMapPath",void 0),_defineProperty(this,"workerNumber",void 0),_defineProperty(this,"npmEntriesProtoFilePath",void 0),_defineProperty(this,"protoFilePath",void 0),_defineProperty(this,"filterModuleInfos",void 0),_defineProperty(this,"symlinkMap",void 0),this.moduleInfos=new Map,this.pkgEntryInfos=new Map,this.hashJsonObject={},this.cacheSourceMapObject={},this.filesInfoPath=_path.default.join(this.projectConfig.cachePath,_ark_define.FILESINFO_TXT),this.npmEntriesInfoPath=_path.default.join(this.projectConfig.cachePath,_ark_define.NPMENTRIES_TXT);var t=this.projectConfig.widgetCompile?_ark_define.WIDGETS_ABC:_ark_define.MODULES_ABC;this.moduleAbcPath=_path.default.join(this.projectConfig.aceModuleBuild,t),this.sourceMapPath=this.arkConfig.isDebug?_path.default.join(this.projectConfig.aceModuleBuild,_ark_define.SOURCEMAPS):_path.default.join(this.projectConfig.cachePath,_ark_define.SOURCEMAPS),this.cacheFilePath=_path.default.join(this.projectConfig.cachePath,_ark_define.MODULES_CACHE),this.cacheSourceMapPath=_path.default.join(this.projectConfig.cachePath,_ark_define.SOURCEMAPS_JSON),this.workerNumber=_ark_define.MAX_WORKER_NUMBER,this.npmEntriesProtoFilePath=_path.default.join(this.projectConfig.cachePath,_ark_define.PROTOS,_ark_define.NPM_ENTRIES_PROTO_BIN),this.protoFilePath=_path.default.join(this.projectConfig.cachePath,_ark_define.PROTOS,_ark_define.PROTO_FILESINFO_TXT),this.hashJsonObject={},this.filterModuleInfos=new Map,this.symlinkMap=e.share.symlinkMap}prepareForCompilation(e){this.collectModuleFileList(e,e.getModuleIds()),this.removeCacheInfo(e)}collectModuleFileList(e,t){var i,r=new Map,s=new Map;for(const o of t)!(0,_utils.isCommonJsPluginVirtualFile)(o)&&(0,_utils.isCurrentProjectFiles)(o,this.projectConfig)&&((i=e.getModuleInfo(o)).meta.isNodeEntryFile&&this.getPackageEntryInfo(o,i.meta,s),this.processModuleInfos(o,r,i.meta));this.moduleInfos=r,this.pkgEntryInfos=s}getPackageEntryInfo(i,r,s){var o=this;if(r.isLocalDependency){var e=r.hostModulesInfo;const c=(0,_ark_utils.getOhmUrlByFilepath)(i,this.projectConfig,this.logger,r.moduleName);void e.forEach(function(e){_newArrowCheck(this,o);var t=e.hostDependencyName,e=e.hostModuleName,e=(0,_utils2.toUnixPath)(_path.default.join(_ark_define.PACKAGES+"@"+e,t));s.has(e)||s.set(e,new PackageEntryInfo(e,c))}.bind(this))}else if(r.pkgPath){var a,n,h=r.pkgPath;let e=(0,_utils2.toUnixPath)(i.replace(h,""));e.startsWith("/")&&(e=e.slice(1,e.length));const l=(0,_utils2.toUnixPath)(this.getPkgModulesFilePkgName(h));let t=_path.default.join(l,e);if(t=(0,_utils2.toUnixPath)(t.substring(0,t.lastIndexOf("."))),s.has(l)||s.set(l,new PackageEntryInfo(l,t)),this.projectConfig.packageDir==_ark_define.OH_MODULES&&this.symlinkMap)for([a,n]of Object.entries(this.symlinkMap))if(a===h){n.forEach(function(e){_newArrowCheck(this,o);e=(0,_utils2.toUnixPath)(this.getPkgModulesFilePkgName(e));s.has(e)||s.set(e,new PackageEntryInfo(e,l))}.bind(this));break}}else this.logger.debug("Failed to get 'pkgPath' from metaInfo. File: ",i)}processModuleInfos(e,t,i){switch(_path.default.extname(e)){case _ark_define.EXTNAME_ETS:var r=(0,_utils.shouldETSOrTSFileTransformToJS)(e,this.projectConfig)?_ark_define.EXTNAME_JS:_ark_define.EXTNAME_TS;this.addModuleInfoItem(e,!1,r,i,t);break;case _ark_define.EXTNAME_TS:r=(0,_utils.shouldETSOrTSFileTransformToJS)(e,this.projectConfig)?_ark_define.EXTNAME_JS:"";this.addModuleInfoItem(e,!1,r,i,t);break;case _ark_define.EXTNAME_JS:case _ark_define.EXTNAME_MJS:case _ark_define.EXTNAME_CJS:var r=e.endsWith(_ark_define.EXTNAME_MJS)||e.endsWith(_ark_define.EXTNAME_CJS)?_ark_define.EXTNAME_JS:"",s=i&&i.commonjs&&i.commonjs.isCommonJS;this.addModuleInfoItem(e,s,r,i,t);break;case _ark_define.EXTNAME_JSON:this.addModuleInfoItem(e,!1,"",i,t)}}addModuleInfoItem(e,t,i,r,s){var o=r.moduleName,a=(0,_ark_utils.getOhmUrlByFilepath)(e,this.projectConfig,this.logger,o),n=e.replace(this.projectConfig.projectRootPath+_path.default.sep,"");let h=this.genFileCachePath(e,this.projectConfig.projectRootPath,this.projectConfig.cachePath),c="";c=(0,_utils2.isPackageModulesFile)(e,this.projectConfig)?this.getPkgModulesFilePkgName(r.pkgPath):r.isLocalDependency?o:(0,_ark_utils.getPackageInfo)(this.projectConfig.aceModuleJsonPath)[1],0!==i.length&&(h=(0,_utils.changeFileExtension)(h,i)),h=(0,_utils2.toUnixPath)(h),a=(0,_utils2.toUnixPath)(a),n=(0,_utils2.toUnixPath)(n),c=(0,_utils2.toUnixPath)(c),s.set(e,new ModuleInfo(e,h,t,a,n,c))}updateCachedSourceMaps(){var s=this;if(_fs.default.existsSync(this.cacheSourceMapPath)){this.cacheSourceMapObject=JSON.parse(_fs.default.readFileSync(this.cacheSourceMapPath).toString());let i=[],r=new Set;this.moduleInfos.forEach(function(e,t){_newArrowCheck(this,s),r.add((0,_utils2.toUnixPath)(t))}.bind(this)),Object.keys(this.cacheSourceMapObject).forEach(function(e){_newArrowCheck(this,s);var t=(0,_utils2.toUnixPath)(_path.default.join(this.projectConfig.projectRootPath,e));r.has(t)||i.push(e)}.bind(this)),i.forEach(function(e){_newArrowCheck(this,s),delete this.cacheSourceMapObject[e]}.bind(this)),Object.keys(_transform.newSourceMaps).forEach(function(e){_newArrowCheck(this,s),this.cacheSourceMapObject[e]=_transform.newSourceMaps[e]}.bind(this))}else this.cacheSourceMapObject=_transform.newSourceMaps}buildModuleSourceMapInfo(){var e=this;this.projectConfig.widgetCompile||(this.updateCachedSourceMaps(),this.triggerAsync(function(){var t=this;_newArrowCheck(this,e),_fs.default.writeFile(this.sourceMapPath,JSON.stringify(this.cacheSourceMapObject,null,2),"utf-8",function(e){_newArrowCheck(this,t),e&&this.throwArkTsCompilerError("ArkTS:ERROR failed to write sourceMaps"),_fs.default.copyFileSync(this.sourceMapPath,this.cacheSourceMapPath),this.triggerEndSignal()}.bind(this))}.bind(this)))}generateEs2AbcCmd(){var e=(0,_utils.getEs2abcFileThreadNumber)();this.cmdArgs.push(`"@${this.filesInfoPath}"`),this.cmdArgs.push("--npm-module-entry-list"),this.cmdArgs.push(`"${this.npmEntriesInfoPath}"`),this.cmdArgs.push("--output"),this.cmdArgs.push(`"${this.moduleAbcPath}"`),this.cmdArgs.push("--file-threads"),this.cmdArgs.push(`"${e}"`),this.cmdArgs.push("--merge-abc"),(0,_utils.isAotMode)(this.projectConfig)&&(0,_ark_utils.isEs2Abc)(this.projectConfig)&&this.cmdArgs.push("--type-extractor")}addCacheFileArgs(){this.cmdArgs.push("--cache-file"),this.cmdArgs.push(`"@${this.cacheFilePath}"`)}generateCompileFilesInfo(){var i=this;let r="";this.moduleInfos.forEach(function(e){_newArrowCheck(this,i);var t=e.isCommonJs?_ark_define.COMMONJS:_ark_define.ESM;r+=`${e.cacheFilePath};${e.recordName};${t};${e.sourceFile};${e.packageName}\n`}.bind(this)),_fs.default.writeFileSync(this.filesInfoPath,r,"utf-8")}generateNpmEntriesInfo(){let e="";for(const t of this.pkgEntryInfos.values())e+=`${t.pkgEntryPath}:${t.pkgBuildPath}\n`;_fs.default.writeFileSync(this.npmEntriesInfoPath,e,"utf-8")}generateAbcCacheFilesInfo(){var i=this;let r="";this.moduleInfos.forEach(function(e){_newArrowCheck(this,i);var t=(0,_utils.changeFileExtension)(e.cacheFilePath,_ark_define.EXTNAME_PROTO_BIN);r+=e.cacheFilePath+`;${t}
`}.bind(this));var e=(0,_utils.changeFileExtension)(this.npmEntriesInfoPath,_ark_define.EXTNAME_PROTO_BIN);r+=this.npmEntriesInfoPath+`;${e}
`,_fs.default.writeFileSync(this.cacheFilePath,r,"utf-8")}genDescriptionsForMergedEs2abc(){this.generateCompileFilesInfo(),this.generateNpmEntriesInfo(),this.generateAbcCacheFilesInfo()}generateMergedAbcOfEs2Abc(){var t=this;let i="";this.genDescriptionsForMergedEs2abc();const e=this.cmdArgs.join(" ");try{var r=this.triggerAsync(function(){return _newArrowCheck(this,t),_child_process.default.exec(e,{windowsHide:!0})}.bind(this));r.on("exit",function(e){_newArrowCheck(this,t),e===_ark_define.FAIL&&this.throwArkTsCompilerError("ArkTS:ERROR failed to execute es2abc"),this.triggerEndSignal(),this.processAotIfNeeded()}.bind(this)),r.on("error",function(e){_newArrowCheck(this,t),this.throwArkTsCompilerError(e.toString())}.bind(this)),r.stderr.on("data",function(e){_newArrowCheck(this,t),i+=e.toString()}.bind(this)),r.stderr.on("end",function(e){_newArrowCheck(this,t),void 0!==i&&0<i.length&&this.logger.error(_ark_define.red,i,_ark_define.reset)}.bind(this))}catch(e){this.throwArkTsCompilerError("ArkTS:ERROR failed to execute es2abc. Error message: "+e.toString())}}filterModulesByHashJson(){if(0!==this.hashJsonFilePath.length&&_fs.default.existsSync(this.hashJsonFilePath)){var e,t,i={};if(_fs.default.existsSync(this.hashJsonFilePath)){t=_fs.default.readFileSync(this.hashJsonFilePath).toString(),e=JSON.parse(t),this.filterModuleInfos=new Map;for(var[r,s]of this.moduleInfos){var o=s.cacheFilePath,a=(0,_utils.changeFileExtension)(o,_ark_define.EXTNAME_PROTO_BIN);if(_fs.default.existsSync(o)||this.throwArkTsCompilerError(`ArkTS:ERROR ${o} is lost`),_fs.default.existsSync(a)){var n=(0,_utils2.toHashData)(o),h=(0,_utils2.toHashData)(a);if(e[o]===n&&e[a]===h){i[o]=o,i[a]=a;continue}}this.filterModuleInfos.set(r,s)}}this.hashJsonObject=i}else for(const c of this.moduleInfos.keys())this.filterModuleInfos.set(c,this.moduleInfos.get(c))}getSplittedModulesByNumber(){var t=[];if(this.filterModuleInfos.size<this.workerNumber)for(const e of this.filterModuleInfos.values())t.push([e]);else{for(let e=0;e<this.workerNumber;++e)t.push([]);let e=0;for(const i of this.filterModuleInfos.values())t[e%this.workerNumber].push(i),e++}return t}invokeTs2AbcWorkersToGenProto(t){var i=this,r=this.cmdArgs.slice(0);if(r.push("--output-proto"),r.push("--merge-abc"),r.push("--input-file"),(0,_utils.isMasterOrPrimary)()){this.setupCluster(_cluster.default),this.workerNumber=t.length;for(let e=0;e<this.workerNumber;++e){var s=e+1,s=_ark_define.FILESINFO+"_"+s+_ark_define.EXTNAME_TXT;const o={inputs:JSON.stringify(t[e]),cmd:r.join(" "),workerFileName:s,mode:_ark_define.ESMODULE,cachePath:this.projectConfig.cachePath};this.triggerAsync(function(){var t=this;_newArrowCheck(this,i),_cluster.default.fork(o).on("message",function(e){_newArrowCheck(this,t),this.logger.error(_ark_define.red,e.data.toString(),_ark_define.reset),this.throwArkTsCompilerError("ArkTS:ERROR failed to execute ts2abc")}.bind(this))}.bind(this))}}}processTs2abcWorkersToGenAbc(){var r=this;this.generateNpmEntriesInfo();let s=0;(0,_utils.isMasterOrPrimary)()&&(_cluster.default.on("exit",function(e,t,i){_newArrowCheck(this,r),t===_ark_define.FAIL&&this.throwArkTsCompilerError("ArkTS:ERROR failed to execute ts2abc"),++s===this.workerNumber&&(this.generateNpmEntryToGenProto(),this.generateProtoFilesInfo(),this.mergeProtoToAbc(),this.processAotIfNeeded(),this.afterCompilationProcess()),this.triggerEndSignal()}.bind(this)),0==this.workerNumber)&&this.processAotIfNeeded()}processAotIfNeeded(){var e,t,i=this;(0,_utils.needAotCompiler)(this.projectConfig)&&(e=function(e){_newArrowCheck(this,i),this.throwArkTsCompilerError(e)}.bind(this),t=(0,_gen_aot.generateBuiltinAbc)(this.arkConfig.arkRootPath,this.initCmdEnv(),this.projectConfig.cachePath,this.logger,e,this.projectConfig.pandaMode),(0,_gen_aot.generateAot)(this.arkConfig.arkRootPath,t,this.moduleAbcPath,this.projectConfig,this.logger,e))}genFileCachePath(e,t,i){e=(0,_utils2.toUnixPath)(e).replace((0,_utils2.toUnixPath)(t),"");return _path.default.join(i,e)}getPkgModulesFilePkgName(e){e=(0,_utils2.toUnixPath)(e);var t=this.projectConfig.packageDir,i=(0,_utils2.toUnixPath)(this.projectConfig.projectRootPath),r=(0,_utils2.toUnixPath)(_path.default.join(i,t));let s="";if(e.includes(r))s=_path.default.join(_ark_define.PACKAGES,e.replace(r,""));else for(const a in this.projectConfig.modulePathMap){var o=this.projectConfig.modulePathMap[a],o=(0,_utils2.toUnixPath)(_path.default.resolve(o,t));if(-1!==e.indexOf(o)){o=e.replace(i,"");s=_path.default.join(_ark_define.PACKAGES+"@"+a,o.substring(o.indexOf(t)+t.length+1));break}}return s.replace(new RegExp(t,"g"),_ark_define.PACKAGES)}generateProtoFilesInfo(){(0,_utils2.validateFilePathLength)(this.protoFilePath,this.logger),(0,_utils2.mkdirsSync)(_path.default.dirname(this.protoFilePath));let e="";for(const i of new Map([...this.moduleInfos].sort()).values()){var t=(0,_utils.changeFileExtension)(i.cacheFilePath,_ark_define.EXTNAME_PROTO_BIN);e+=(0,_utils2.toUnixPath)(t)+`
`}0<this.pkgEntryInfos.size&&(e+=(0,_utils2.toUnixPath)(this.npmEntriesProtoFilePath)+`
`),_fs.default.writeFileSync(this.protoFilePath,e,"utf-8")}mergeProtoToAbc(){(0,_utils2.mkdirsSync)(this.projectConfig.aceModuleBuild);var e=`"${this.arkConfig.mergeAbcPath}" --input "@${this.protoFilePath}" --outputFilePath "${this.projectConfig.aceModuleBuild}" --output ${_ark_define.MODULES_ABC} --suffix protoBin`;try{_child_process.default.execSync(e,{windowsHide:!0})}catch(e){this.throwArkTsCompilerError("ArkTS:ERROR failed to merge proto file to abc, error message:"+e.toString())}}afterCompilationProcess(){this.writeHashJson()}writeHashJson(){if(0!==this.hashJsonFilePath.length){for(const s of this.filterModuleInfos.values()){var e=s.cacheFilePath,t=(0,_utils.changeFileExtension)(e,_ark_define.EXTNAME_PROTO_BIN),i=(_fs.default.existsSync(e)&&_fs.default.existsSync(t)||this.throwArkTsCompilerError(`ArkTS:ERROR ${e} or  ${t} is lost`),(0,_utils2.toHashData)(e)),r=(0,_utils2.toHashData)(t);this.hashJsonObject[e]=i,this.hashJsonObject[t]=r}_fs.default.writeFileSync(this.hashJsonFilePath,JSON.stringify(this.hashJsonObject))}}generateNpmEntryToGenProto(){if(!(this.pkgEntryInfos.size<=0)){(0,_utils2.mkdirsSync)(_path.default.dirname(this.npmEntriesProtoFilePath));var e=`"${this.arkConfig.js2abcPath}" --compile-npm-entries "${this.npmEntriesInfoPath}" "${this.npmEntriesProtoFilePath}"`;try{_child_process.default.execSync(e,{windowsHide:!0})}catch(e){this.throwArkTsCompilerError("ArkTS:ERROR failed to generate npm proto file to abc. Error message: "+e.toString())}}}removeCompilationCache(){(0,_ark_utils.isEs2Abc)(this.projectConfig)?this.removeEs2abcCompilationCache():(0,_ark_utils.isTs2Abc)(this.projectConfig)?this.removeTs2abcCompilationCache():this.throwArkTsCompilerError(`Invalid projectConfig.pandaMode for module build, should be either
      "${_ark_define.TS2ABC}" or "${_ark_define.ES2ABC}"`)}removeEs2abcCompilationCache(){var t=this;_fs.default.existsSync(this.cacheFilePath)&&(_fs.default.readFileSync(this.cacheFilePath,"utf-8").split(/\r?\n/).forEach(function(e){_newArrowCheck(this,t);var[,e]=e.split(";");_fs.default.existsSync(e)&&_fs.default.unlinkSync(e)}.bind(this)),_fs.default.unlinkSync(this.cacheFilePath))}removeTs2abcCompilationCache(){var t=this;_fs.default.existsSync(this.hashJsonFilePath)&&_fs.default.unlinkSync(this.hashJsonFilePath),_fs.default.existsSync(this.protoFilePath)&&(_fs.default.readFileSync(this.protoFilePath,"utf-8").split(/\r?\n/).forEach(function(e){_newArrowCheck(this,t);_fs.default.existsSync(e)&&_fs.default.unlinkSync(e)}.bind(this)),_fs.default.unlinkSync(this.protoFilePath))}}exports.ModuleMode=ModuleMode;