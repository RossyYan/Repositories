"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.initArkConfig=initArkConfig,exports.initArkProjectConfig=initArkProjectConfig;var _path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),_arkguard=require("arkguard"),_ark_define=require("./ark_define"),_utils=require("../utils"),_utils2=require("../../../utils"),_ark_utils=require("../../../ark_utils"),_gen_aot=require("../../../gen_aot"),_main=require("../../../../main"),_ob_config_resolver=require("./ob_config_resolver");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,o){if(e!==o)throw new TypeError("Cannot instantiate an arrow function")}let arkConfig={};function initArkConfig(e){let o=_path.default.join(__dirname,"..","..","..","..","bin","ark");return e.arkFrontendDir&&(o=e.arkFrontendDir),arkConfig.nodePath="node",e.nodeJs&&(arkConfig.nodePath=e.nodePath),processPlatformInfo(o),processCompatibleVersion(e,o),arkConfig.isDebug=(0,_utils.isDebug)(e),arkConfig.arkRootPath=o,arkConfig}function initArkProjectConfig(o){var e,a=this,i=o.projectConfig,n={};return i.aceBuildJson&&_fs.default.existsSync(i.aceBuildJson)&&(e=JSON.parse(_fs.default.readFileSync(i.aceBuildJson).toString()),n.projectRootPath=e.projectRootPath,n.modulePathMap=e.modulePathMap,n.isOhosTest=e.isOhosTest,e.patchConfig&&(n.oldMapFilePath=e.patchConfig.oldMapFilePath),(0,_gen_aot.checkAotConfig)(i.compileMode,e,function(e){_newArrowCheck(this,a),o.throwArkTsCompilerError(e)}.bind(this))?(n.processTs=!0,n.pandaMode=_ark_define.TS2ABC,n.anBuildOutPut=e.anBuildOutPut,n.anBuildMode=e.anBuildMode,n.apPath=e.apPath):(n.processTs=!1,n.pandaMode=e.pandaMode),i.compileMode===_ark_define.ESMODULE)&&(n.nodeModulesPath=e.nodeModulesPath,n.harNameOhmMap=e.harNameOhmMap,i.packageDir="ohpm"===e.packageManagerType?_ark_define.OH_MODULES:_ark_define.NODE_MODULES),i.aceManifestPath&&_fs.default.existsSync(i.aceManifestPath)&&(e=JSON.parse(_fs.default.readFileSync(i.aceManifestPath).toString())).minPlatformVersion&&(n.minPlatformVersion=e.minPlatformVersion),i.aceModuleJsonPath&&_fs.default.existsSync(i.aceModuleJsonPath)&&((e=JSON.parse(_fs.default.readFileSync(i.aceModuleJsonPath).toString())).app.minAPIVersion&&(n.minPlatformVersion=e.app.minAPIVersion),e.module&&(n.moduleName=e.module.name),e.app)&&(n.bundleName=e.app.bundleName),n.hotReload=_main.projectConfig.hotReload,n.patchAbcPath=_main.projectConfig.patchAbcPath,n.changedFileList=_main.projectConfig.changedFileList,(_main.projectConfig.es2abcCompileTsInAotMode||_main.projectConfig.es2abcCompileTsInNonAotMode)&&(n.pandaMode=_main.projectConfig.pandaMode,n.processTs=_main.projectConfig.processTs),n.compileMode=i.compileMode,!i.compileHar&&(0,_utils.isDebug)(i)||initObfuscationConfig(i,n,o.getLogger(_ark_define.OBFUSCATION_TOOL)),n}function initObfuscationConfig(e,o,a){var i,n=new _ob_config_resolver.ObConfigResolver(e,a,!0).resolveObfuscationConfigs(),t=e.compileHar;n.options.disableObfuscation||(n.options.enablePropertyObfuscation&&(i=(0,_arkguard.readProjectProperties)([e.modulePath],{mNameObfuscation:{mReservedProperties:[],mKeepStringProperty:!n.options.enableStringPropertyObfuscation}},!0),n.reservedPropertyNames.push(...i)),o.obfuscationMergedObConfig=n,(0,_utils.isAotMode)(o)?o.arkObfuscator=initArkGuardConfig(e.obfuscationOptions?.obfuscationCacheDir,a,n):o.terserConfig=initTerserConfig(e,a,n,t))}function initTerserConfig(e,o,a,i){var i={format:{beautify:!(e.obfuscationOptions?a.options.compact:i),indent_level:2},compress:{join_vars:!1,sequences:0,directives:!1,drop_console:a.options.removeLog},mangle:{reserved:a.reservedNames,toplevel:a.options.enableToplevelObfuscation}},n=a.options.applyNameCache;return n&&0<n.length?_fs.default.existsSync(n)?i.nameCache=JSON.parse(_fs.default.readFileSync(n,"utf-8")):o.error(`ArkTS:ERROR Namecache file ${n} does not exist`):e.obfuscationOptions&&e.obfuscationOptions.obfuscationCacheDir&&(o=_path.default.join(e.obfuscationOptions.obfuscationCacheDir,"nameCache.json"),_fs.default.existsSync(o)?i.nameCache=JSON.parse(_fs.default.readFileSync(o,"utf-8")):i.nameCache={}),a.options.enablePropertyObfuscation&&(i.mangle.properties={reserved:a.reservedPropertyNames,keep_quoted:!a.options.enableStringPropertyObfuscation}),i}function initArkGuardConfig(e,o,a){var i={mCompact:a.options.compact,mDisableHilog:!1,mDisableConsole:a.options.removeLog,mSimplify:!1,mTopLevel:a.options.enableToplevelObfuscation,mNameObfuscation:{mEnable:!0,mNameGeneratorType:1,mReservedNames:a.reservedNames,mRenameProperties:a.options.enablePropertyObfuscation,mReservedProperties:a.reservedPropertyNames,mKeepStringProperty:!a.options.enableStringPropertyObfuscation},mEnableSourceMap:!0,mEnableNameCache:!0},n=new _arkguard.ArkObfuscator;return n.init(i),a.options.applyNameCache&&0<a.options.applyNameCache.length?(0,_ob_config_resolver.readNameCache)(a.options.applyNameCache,o):e&&(i=_path.default.join(e,"nameCache.json"),_fs.default.existsSync(i))&&(0,_ob_config_resolver.readNameCache)(i,o),n}function processPlatformInfo(e){e=(0,_ark_utils.getArkBuildDir)(e);(0,_utils2.isWindows)()?(arkConfig.es2abcPath=_path.default.join(e,"bin","es2abc.exe"),arkConfig.ts2abcPath=_path.default.join(e,"src","index.js"),arkConfig.mergeAbcPath=_path.default.join(e,"bin","merge_abc.exe"),arkConfig.js2abcPath=_path.default.join(e,"bin","js2abc.exe"),arkConfig.aotCompilerPath=_path.default.join(e,"bin","ark_aot_compiler.exe")):((0,_utils2.isLinux)()||(0,_utils2.isMac)())&&(arkConfig.es2abcPath=_path.default.join(e,"bin","es2abc"),arkConfig.ts2abcPath=_path.default.join(e,"src","index.js"),arkConfig.mergeAbcPath=_path.default.join(e,"bin","merge_abc"),arkConfig.js2abcPath=_path.default.join(e,"bin","js2abc"),arkConfig.aotCompilerPath=_path.default.join(e,"bin","ark_aot_compiler"))}function processCompatibleVersion(e,o){o=(0,_ark_utils.getArkBuildDir)(o);e.minPlatformVersion&&"8"===e.minPlatformVersion.toString()&&(arkConfig.ts2abcPath=_path.default.join(o,"legacy_api8","src","index.js"),e.pandaMode=_ark_define.TS2ABC)}