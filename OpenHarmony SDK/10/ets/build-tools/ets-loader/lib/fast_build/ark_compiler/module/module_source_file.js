"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ModuleSourceFile=void 0;var ts=_interopRequireWildcard(require("typescript")),_path=_interopRequireDefault(require("path")),_magicString=_interopRequireDefault(require("magic-string")),_ark_define=require("../common/ark_define"),_ark_utils=require("../../../ark_utils"),_process_module_files=require("../../../process_module_files"),_utils=require("../utils"),_utils2=require("../../../utils"),_transform=require("../transform"),_ob_config_resolver=require("../common/ob_config_resolver");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _getRequireWildcardCache(e){var r,t;return"function"!=typeof WeakMap?null:(r=new WeakMap,t=new WeakMap,(_getRequireWildcardCache=function(e){return e?t:r})(e))}function _interopRequireWildcard(e,r){if(!r&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};r=_getRequireWildcardCache(r);if(r&&r.has(e))return r.get(e);var t,o,i={},s=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(t in e)"default"!==t&&Object.prototype.hasOwnProperty.call(e,t)&&((o=s?Object.getOwnPropertyDescriptor(e,t):null)&&(o.get||o.set)?Object.defineProperty(i,t,o):i[t]=e[t]);return i.default=e,r&&r.set(e,i),i}function _newArrowCheck(e,r){if(e!==r)throw new TypeError("Cannot instantiate an arrow function")}function _defineProperty(e,r,t){return(r=_toPropertyKey(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==typeof e?e:String(e)}function _toPrimitive(e,r){if("object"!=typeof e||null===e)return e;var t=e[Symbol.toPrimitive];if(void 0===t)return("string"===r?String:Number)(e);t=t.call(e,r||"default");if("object"!=typeof t)return t;throw new TypeError("@@toPrimitive must return a primitive value.")}const ROLLUP_IMPORT_NODE="ImportDeclaration",ROLLUP_EXPORTNAME_NODE="ExportNamedDeclaration",ROLLUP_EXPORTALL_NODE="ExportAllDeclaration",ROLLUP_DYNAMICIMPORT_NODE="ImportExpression",ROLLUP_LITERAL_NODE="Literal";class ModuleSourceFile{constructor(e,r){_defineProperty(this,"moduleId",void 0),_defineProperty(this,"source",void 0),_defineProperty(this,"isSourceNode",!1),this.moduleId=e,this.source=r,"string"!=typeof this.source&&(this.isSourceNode=!0)}static newSourceFile(e,r){ModuleSourceFile.sourceFiles.push(new ModuleSourceFile(e,r))}static getSourceFiles(){return ModuleSourceFile.sourceFiles}static async processModuleSourceFiles(e){this.initPluginEnv(e);for(const r of ModuleSourceFile.sourceFiles)e.share.projectConfig.compileHar||await r.processModuleRequest(e),await r.writeSourceFile();(ModuleSourceFile.projectConfig.arkObfuscator||ModuleSourceFile.projectConfig.terserConfig)&&ModuleSourceFile.projectConfig.obfuscationOptions&&(0,_ob_config_resolver.writeObfuscationNameCache)(ModuleSourceFile.projectConfig,ModuleSourceFile.projectConfig.obfuscationOptions.obfuscationCacheDir,ModuleSourceFile.projectConfig.obfuscationMergedObConfig.options?.printNameCache),ModuleSourceFile.sourceFiles=[]}getModuleId(){return this.moduleId}async writeSourceFile(){this.isSourceNode&&!(0,_utils.isJsSourceFile)(this.moduleId)?await(0,_process_module_files.writeFileSyncByNode)(this.source,ModuleSourceFile.projectConfig,ModuleSourceFile.logger):await(0,_utils.writeFileContentToTempDir)(this.moduleId,this.source,ModuleSourceFile.projectConfig,ModuleSourceFile.logger)}getOhmUrl(e,r,t){var o=(0,_ark_utils.getOhmUrlBySystemApiOrLibRequest)(r);return null!=o||void 0!==(o=(0,_ark_utils.getOhmUrlByHarName)(r,ModuleSourceFile.projectConfig))?o:t?(r=e.getModuleInfo(t).meta.moduleName,(o=(0,_ark_utils.getOhmUrlByFilepath)(t,ModuleSourceFile.projectConfig,ModuleSourceFile.logger,r)).startsWith(_ark_define.PACKAGES)?"@package:"+o:"@bundle:"+o):void 0}processJsModuleRequest(s){var u=this;const n=s.getModuleInfo(this.moduleId).importedIdMaps;this.source=this.source.replace(/(?:import|from)(?:\s*)['"]([^'"]+)['"]|(?:import)(?:\s*)\(['"]([^'"]+)['"]\)/g,function(e,r,t){var o=this,r=(_newArrowCheck(this,u),r||t);const i=this.getOhmUrl(s,r,n[r]);return e=void 0!==i?e.replace(/(['"])(?:\S+)['"]/,function(e,r){return _newArrowCheck(this,o),r+i+r}.bind(this)):e}.bind(this))}async processTransformedJsModuleRequest(t){var o=this,e=t.getModuleInfo(this.moduleId);const i=e.importedIdMaps,s=new _magicString.default(this.source);var r,u,e=e.getNodeByType(ROLLUP_IMPORT_NODE,ROLLUP_EXPORTNAME_NODE,ROLLUP_EXPORTALL_NODE,ROLLUP_DYNAMICIMPORT_NODE);let n=!1;for(r of e.values())r.forEach(function(e){var r;_newArrowCheck(this,o),n||e.type!==ROLLUP_DYNAMICIMPORT_NODE||(n=!0),e.source&&(e.source.type===ROLLUP_LITERAL_NODE?void 0!==(r=this.getOhmUrl(t,e.source.value,i[e.source.value]))&&s.update(e.source.start,e.source.end,`'${r}'`):(e=`ArkTS:ERROR ArkTS:ERROR File: ${this.moduleId}
`+`DynamicImport only accept stringLiteral as argument currently.
`,ModuleSourceFile.logger.error("[31m"+e)))}.bind(this));n&&(e=(0,_utils2.toUnixPath)(this.moduleId.replace(ModuleSourceFile.projectConfig.projectRootPath+_path.default.sep,"")),u=s.generateMap({source:e,file:""+_path.default.basename(this.moduleId),includeContent:!1,hires:!0}),_transform.newSourceMaps[e]=await(0,_utils.updateSourceMap)(_transform.newSourceMaps[e],u)),this.source=s.toString()}processTransformedTsModuleRequest(u){var e=this;const n=u.getModuleInfo(this.moduleId).importedIdMaps;var r=function(o){var i=this;_newArrowCheck(this,e);const s=function(e){if(_newArrowCheck(this,i),e=ts.visitEachChild(e,s,o),ts.isImportDeclaration(e)||ts.isExportDeclaration(e)&&e.moduleSpecifier){var r=e.moduleSpecifier.getText().replace(/'|"/g,""),r=this.getOhmUrl(u,r,n[r]);if(void 0!==r)return ts.isImportDeclaration(e)?ts.factory.createImportDeclaration(e.decorators,e.modifiers,e.importClause,ts.factory.createStringLiteral(r)):ts.factory.createExportDeclaration(e.decorators,e.modifiers,e.isTypeOnly,e.exportClause,ts.factory.createStringLiteral(r))}if(ts.isCallExpression(e)&&e.expression.kind===ts.SyntaxKind.ImportKeyword){if(!ts.isStringLiteral(e.arguments[0]))return{line:r,character:t}=ts.getLineAndCharacterOfPosition(this.source,e.arguments[0].pos),r=`ArkTS:ERROR ArkTS:ERROR File: ${this.moduleId}:${r+1}:${t+1}
`+`DynamicImport only accept stringLiteral as argument currently.
`,ModuleSourceFile.logger.error("[31m"+r),e;var t=e.arguments[0].getText().replace(/'|"/g,""),r=this.getOhmUrl(u,t,n[t]);if(void 0!==r)return(t=[...e.arguments])[0]=ts.factory.createStringLiteral(r),ts.factory.createCallExpression(e.expression,e.typeArguments,t)}return e}.bind(this);return function(e){return _newArrowCheck(this,i),ts.visitNode(e,s)}.bind(this)}.bind(this),r=ts.transform(this.source,[r]);this.source=r.transformed[0]}async processModuleRequest(e){(0,_utils.isJsonSourceFile)(this.moduleId)||((0,_utils.isJsSourceFile)(this.moduleId)?this.processJsModuleRequest(e):this.isSourceNode?this.processTransformedTsModuleRequest(e):await this.processTransformedJsModuleRequest(e))}static initPluginEnv(e){this.projectConfig=Object.assign(e.share.arkProjectConfig,e.share.projectConfig),this.logger=e.share.getLogger(_ark_define.GEN_ABC_PLUGIN_NAME)}}_defineProperty(exports.ModuleSourceFile=ModuleSourceFile,"sourceFiles",[]),_defineProperty(ModuleSourceFile,"projectConfig",void 0),_defineProperty(ModuleSourceFile,"logger",void 0);