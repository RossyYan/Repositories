"use strict";var _child_process=_interopRequireDefault(require("child_process")),_cluster=_interopRequireDefault(require("cluster")),_fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),_process=_interopRequireDefault(require("process")),_ark_define=require("./ark_define"),_utils=require("../utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function genAbcByWorkersOfBundleMode(e,r){var t=JSON.parse(e);for(let e=0;e<t.length;++e){var s=t[e].cacheFilePath,s=r+` "${s}" -o "${(0,_utils.changeFileExtension)(s,_ark_define.EXTNAME_ABC)}" --source-file "${t[e].sourceFile}"`;try{_child_process.default.execSync(s,{windowsHide:!0})}catch(e){_process.default.send({data:e.toString()}),_process.default.exit(_ark_define.FAIL)}}}function genAbcByWorkersOfModuleMode(e,r,t,s){var a=JSON.parse(e),e=_path.default.join(s,t);let i="";for(let e=0;e<a.length;++e){var d=a[e],o=d.isCommonJs?_ark_define.COMMONJS:_ark_define.ESM;i+=`${d.cacheFilePath};${d.recordName};${o};${d.sourceFile};`+d.packageName,e<a.length-1&&(i+="\n")}_fs.default.writeFileSync(e,i,"utf-8");s=r+` "${e}"`;try{_child_process.default.execSync(s,{windowsHide:!0})}catch(e){_process.default.send({data:e.toString()}),_process.default.exit(_ark_define.FAIL)}}_process.default.stderr.write=function(e){e=e.toString();return 0!==e.length&&_process.default.send({data:e}),!0},_cluster.default.isWorker&&void 0!==_process.default.env.inputs&&void 0!==_process.default.env.cmd&&void 0!==_process.default.env.mode?_process.default.env.mode===_ark_define.JSBUNDLE?(genAbcByWorkersOfBundleMode(_process.default.env.inputs,_process.default.env.cmd),_process.default.exit(_ark_define.SUCCESS)):_process.default.env.mode===_ark_define.ESMODULE&&_process.default.env.workerFileName&&_process.default.env.cachePath?(genAbcByWorkersOfModuleMode(_process.default.env.inputs,_process.default.env.cmd,_process.default.env.workerFileName,_process.default.env.cachePath),_process.default.exit(_ark_define.SUCCESS)):_process.default.exit(_ark_define.FAIL):(_process.default.send({data:"Failed to invoke worker with uncomplete inputs"}),_process.default.exit(_ark_define.FAIL));