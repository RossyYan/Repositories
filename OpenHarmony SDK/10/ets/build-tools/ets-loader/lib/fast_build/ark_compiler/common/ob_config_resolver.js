"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ObConfigResolver=exports.MergedConfig=void 0,exports.generateConsumerObConfigFile=generateConsumerObConfigFile,exports.getArkguardNameCache=getArkguardNameCache,exports.readNameCache=readNameCache,exports.writeObfuscationNameCache=writeObfuscationNameCache;var _fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),_arkguard=require("arkguard"),_ark_utils=require("../../../ark_utils");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _defineProperty(e,r,t){return(r=_toPropertyKey(r))in e?Object.defineProperty(e,r,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[r]=t,e}function _toPropertyKey(e){e=_toPrimitive(e,"string");return"symbol"==typeof e?e:String(e)}function _toPrimitive(e,r){if("object"!=typeof e||null===e)return e;var t=e[Symbol.toPrimitive];if(void 0===t)return("string"===r?String:Number)(e);t=t.call(e,r||"default");if("object"!=typeof t)return t;throw new TypeError("@@toPrimitive must return a primitive value.")}function _newArrowCheck(e,r){if(e!==r)throw new TypeError("Cannot instantiate an arrow function")}var OptionType=function(e){return e[e.NONE=0]="NONE",e[e.KEEP_DTS=1]="KEEP_DTS",e[e.KEEP_GLOBAL_NAME=2]="KEEP_GLOBAL_NAME",e[e.KEEP_PROPERTY_NAME=3]="KEEP_PROPERTY_NAME",e[e.DISABLE_OBFUSCATION=4]="DISABLE_OBFUSCATION",e[e.ENABLE_PROPERTY_OBFUSCATION=5]="ENABLE_PROPERTY_OBFUSCATION",e[e.ENABLE_STRING_PROPERTY_OBFUSCATION=6]="ENABLE_STRING_PROPERTY_OBFUSCATION",e[e.ENABLE_TOPLEVEL_OBFUSCATION=7]="ENABLE_TOPLEVEL_OBFUSCATION",e[e.COMPACT=8]="COMPACT",e[e.REMOVE_LOG=9]="REMOVE_LOG",e[e.PRINT_NAMECACHE=10]="PRINT_NAMECACHE",e[e.APPLY_NAMECACHE=11]="APPLY_NAMECACHE",e}(OptionType||{});function isFileExist(e){let r=!1;try{_fs.default.accessSync(e,_fs.default.constants.F_OK)}catch(e){r=!e}return r}function sortAndDeduplicateStringArr(r){var t=this;if(0==r.length)return r;r.sort(function(e,r){return _newArrowCheck(this,t),e.localeCompare(r)}.bind(this));var o=[r[0]];for(let e=1;e<r.length;e++)r[e]!=r[e-1]&&o.push(r[e]);return o}class ObOptions{constructor(){_defineProperty(this,"disableObfuscation",!1),_defineProperty(this,"enablePropertyObfuscation",!1),_defineProperty(this,"enableStringPropertyObfuscation",!1),_defineProperty(this,"enableToplevelObfuscation",!1),_defineProperty(this,"compact",!1),_defineProperty(this,"removeLog",!1),_defineProperty(this,"printNameCache",""),_defineProperty(this,"applyNameCache","")}merge(e){this.disableObfuscation=this.disableObfuscation||e.disableObfuscation,this.enablePropertyObfuscation=this.enablePropertyObfuscation||e.enablePropertyObfuscation,this.enableToplevelObfuscation=this.enableToplevelObfuscation||e.enableToplevelObfuscation,this.enableStringPropertyObfuscation=this.enableStringPropertyObfuscation||e.enableStringPropertyObfuscation,this.compact=this.compact||e.compact,this.removeLog=this.removeLog||e.removeLog,0<e.printNameCache.length&&(this.printNameCache=e.printNameCache),0<e.applyNameCache.length&&(this.applyNameCache=e.applyNameCache)}}class MergedConfig{constructor(){_defineProperty(this,"options",new ObOptions),_defineProperty(this,"reservedPropertyNames",[]),_defineProperty(this,"reservedNames",[])}merge(e){this.options.merge(e.options),this.reservedPropertyNames.push(...e.reservedPropertyNames),this.reservedNames.push(...e.reservedNames)}sortAndDeduplicate(){this.reservedPropertyNames=sortAndDeduplicateStringArr(this.reservedPropertyNames),this.reservedNames=sortAndDeduplicateStringArr(this.reservedNames)}serializeMergedConfig(){var r=this;let t="";for(const e of Object.keys(this.options))!0===this.options[e]&&ObConfigResolver.optionsMap.has(String(e))&&(t+=ObConfigResolver.optionsMap.get(String(e))+"\n");return 0<this.reservedNames.length&&(t+=ObConfigResolver.KEEP_GLOBAL_NAME+"\n",this.reservedNames.forEach(function(e){_newArrowCheck(this,r),t+=e+"\n"}.bind(this))),0<this.reservedPropertyNames.length&&(t+=ObConfigResolver.KEEP_PROPERTY_NAME+"\n",this.reservedPropertyNames.forEach(function(e){_newArrowCheck(this,r),t+=e+"\n"}.bind(this))),t}}exports.MergedConfig=MergedConfig;class ObConfigResolver{constructor(e,r,t){_defineProperty(this,"sourceObConfig",void 0),_defineProperty(this,"logger",void 0),_defineProperty(this,"isHarCompiled",void 0),_defineProperty(this,"isTerser",void 0),this.sourceObConfig=e.obfuscationOptions,this.logger=r,this.isHarCompiled=e.compileHar,this.isTerser=t}resolveObfuscationConfigs(){var e=this.sourceObConfig;if(!e)return new MergedConfig;let r=e.selfConfig.ruleOptions.enable;var t=new MergedConfig,o=(r?(this.getSelfConfigs(t),r=!t.options.disableObfuscation):t.options.disableObfuscation=!0,this.isHarCompiled&&e.selfConfig.consumerRules&&0<e.selfConfig.consumerRules.length),i=r||o;let n=new MergedConfig;var s=Math.max(e.dependencies.libraries.length,e.dependencies.hars.length),i=(i&&0<s&&(n=new MergedConfig,this.getDependencyConfigs(e,n),r=r&&!n.options.disableObfuscation),this.getMergedConfigs(t,n));return r&&i.options.enablePropertyObfuscation&&(isFileExist(s=_path.default.join(e.obfuscationCacheDir,"systemApiCache.json"))?this.getSystemApiConfigsByCache(t,s):this.getSystemApiCache(t,s)),o&&(t=new MergedConfig,this.getSelfConsumerConfig(t),this.genConsumerConfigFiles(e,t,n)),i}getSelfConfigs(e){if(this.sourceObConfig.selfConfig.ruleOptions.rules)for(const r of this.sourceObConfig.selfConfig.ruleOptions.rules)this.getConfigByPath(r,e)}getConfigByPath(r,e){let t=void 0;try{t=_fs.default.readFileSync(r,"utf-8")}catch(e){throw this.logger.error(`Failed to open ${r}. Error message: `+e),e}this.handleConfigContent(t,e,r)}getTokenType(e){switch(e){case ObConfigResolver.KEEP_DTS:return OptionType.KEEP_DTS;case ObConfigResolver.KEEP_GLOBAL_NAME:return OptionType.KEEP_GLOBAL_NAME;case ObConfigResolver.KEEP_PROPERTY_NAME:return OptionType.KEEP_PROPERTY_NAME;case ObConfigResolver.DISABLE_OBFUSCATION:return OptionType.DISABLE_OBFUSCATION;case ObConfigResolver.ENABLE_PROPERTY_OBFUSCATION:return OptionType.ENABLE_PROPERTY_OBFUSCATION;case ObConfigResolver.ENABLE_STRING_PROPERTY_OBFUSCATION:return OptionType.ENABLE_STRING_PROPERTY_OBFUSCATION;case ObConfigResolver.ENABLE_TOPLEVEL_OBFUSCATION:return OptionType.ENABLE_TOPLEVEL_OBFUSCATION;case ObConfigResolver.COMPACT:return OptionType.COMPACT;case ObConfigResolver.REMOVE_LOG:return OptionType.REMOVE_LOG;case ObConfigResolver.PRINT_NAMECACHE:return OptionType.PRINT_NAMECACHE;case ObConfigResolver.APPLY_NAMECACHE:return OptionType.APPLY_NAMECACHE;default:return OptionType.NONE}}handleConfigContent(e,r,t){var o=this,i=(e=this.removeComments(e)).split(/[',', '\t', ' ', '\n', '\r\n']/).filter(function(e){if(_newArrowCheck(this,o),""!=e)return e}.bind(this));let n=OptionType.NONE;var s=[];for(let e=0;e<i.length;e++){var a,p=i[e];switch(a=this.getTokenType(p)){case OptionType.DISABLE_OBFUSCATION:r.options.disableObfuscation=!0;continue;case OptionType.ENABLE_PROPERTY_OBFUSCATION:r.options.enablePropertyObfuscation=!0;continue;case OptionType.ENABLE_STRING_PROPERTY_OBFUSCATION:r.options.enableStringPropertyObfuscation=!0;case OptionType.ENABLE_TOPLEVEL_OBFUSCATION:r.options.enableToplevelObfuscation=!0;continue;case OptionType.COMPACT:r.options.compact=!0;continue;case OptionType.REMOVE_LOG:r.options.removeLog=!0;continue;case OptionType.KEEP_DTS:case OptionType.KEEP_GLOBAL_NAME:case OptionType.KEEP_PROPERTY_NAME:case OptionType.PRINT_NAMECACHE:case OptionType.APPLY_NAMECACHE:n=a;continue}switch(n){case OptionType.KEEP_DTS:s.push(p);continue;case OptionType.KEEP_GLOBAL_NAME:r.reservedNames.push(p);continue;case OptionType.KEEP_PROPERTY_NAME:r.reservedPropertyNames.push(p);continue;case OptionType.PRINT_NAMECACHE:r.options.printNameCache=p,n=OptionType.NONE;continue;case OptionType.APPLY_NAMECACHE:r.options.applyNameCache=p,n=OptionType.NONE,this.determineNameCachePath(p,t);continue;default:continue}}this.resolveDts(s,r)}resolveDts(e,r){var t=this;_arkguard.ApiExtractor.mPropertySet.clear(),e.forEach(function(e){_newArrowCheck(this,t),_arkguard.ApiExtractor.traverseApiFiles(e,_arkguard.ApiExtractor.ApiType.PROJECT)}.bind(this)),r.reservedNames=r.reservedNames.concat([..._arkguard.ApiExtractor.mPropertySet]),r.reservedPropertyNames=r.reservedPropertyNames.concat([..._arkguard.ApiExtractor.mPropertySet]),_arkguard.ApiExtractor.mPropertySet.clear()}removeComments(r){var t="",o=!1;for(let e=0;e<r.length;e++)o?o="\n"!=r[e]:"#"!=r[e]?t+=r[e]:o=!0;return t}getSystemApiCache(e,r){var t;_arkguard.ApiExtractor.mPropertySet.clear();for(t of sortAndDeduplicateStringArr(this.sourceObConfig.sdkApis)){this.getSdkApiCache(t);var o=_path.default.join(t,"../build-tools/ets-loader/lib/pre_define.js");_fs.default.existsSync(o)&&this.getUIApiCache(o)}var i=sortAndDeduplicateStringArr([..._arkguard.ApiExtractor.mPropertySet]),n={ReservedNames:i,ReservedPropertyNames:i};e.reservedPropertyNames.push(...i),e.reservedNames.push(...i),_fs.default.existsSync(_path.default.dirname(r))||_fs.default.mkdirSync(_path.default.dirname(r),{recursive:!0}),_fs.default.writeFileSync(r,JSON.stringify(n,null,2)),_arkguard.ApiExtractor.mPropertySet.clear()}getSdkApiCache(e){_arkguard.ApiExtractor.traverseApiFiles(e,_arkguard.ApiExtractor.ApiType.API);e=_path.default.join(e,"../component");_fs.default.existsSync(e)&&_arkguard.ApiExtractor.traverseApiFiles(e,_arkguard.ApiExtractor.ApiType.COMPONENT)}getUIApiCache(e){_arkguard.ApiExtractor.extractStringsFromFile(e)}getDependencyConfigs(e,r){for(const i of e.dependencies.libraries||[])if(i.consumerRules&&0<i.consumerRules.length)for(const n of i.consumerRules){var t=new MergedConfig;this.getConfigByPath(n,r),r.merge(t)}if(e.dependencies&&e.dependencies.hars&&0<e.dependencies.hars.length)for(const s of e.dependencies.hars){var o=new MergedConfig;this.getConfigByPath(s,r),r.merge(o)}}getSystemApiConfigsByCache(e,r){r=JSON.parse(_fs.default.readFileSync(r,"utf-8"));r.ReservedPropertyNames&&(e.reservedPropertyNames=r.ReservedPropertyNames),r.ReservedNames&&(e.reservedNames=r.ReservedNames)}getSelfConsumerConfig(e){for(const r of this.sourceObConfig.selfConfig.consumerRules)this.getConfigByPath(r,e)}getMergedConfigs(e,r){return r&&e.merge(r),e.sortAndDeduplicate(),e}genConsumerConfigFiles(e,r,t){r.merge(t),r.sortAndDeduplicate(),this.writeConsumerConfigFile(r,e.exportRulePath)}writeConsumerConfigFile(e,r){e=e.serializeMergedConfig();_fs.default.writeFileSync(r,e)}determineNameCachePath(e,r){if(!_fs.default.existsSync(e))throw new Error(`The applied namecache file '${e}' configured by '${r}' does not exist.`)}}function readNameCache(r,t){try{var e=_fs.default.readFileSync(r,"utf-8"),o=JSON.parse(e);o.PropertyCache&&(_arkguard.renamePropertyModule.historyMangledTable=(0,_arkguard.getMapFromJson)(o.PropertyCache)),Object.assign(_ark_utils.identifierCaches,o.IdentifierCache)}catch(e){t.error(`Failed to open ${r}. Error message: `+e)}}function getArkguardNameCache(e){var r="",t={},o=(t.IdentifierCache=_ark_utils.identifierCaches,new Map);if(e){if(_arkguard.renamePropertyModule.historyMangledTable)for(var[i,n]of _arkguard.renamePropertyModule.historyMangledTable.entries())o.set(i,n);if(_arkguard.renamePropertyModule.globalMangledTable)for(var[s,a]of _arkguard.renamePropertyModule.globalMangledTable.entries())o.set(s,a);t.PropertyCache=Object.fromEntries(o)}return r+=JSON.stringify(t,null,2)}function writeObfuscationNameCache(e,r,t){let o="";if(e.arkObfuscator)o=getArkguardNameCache(e.obfuscationMergedObConfig.options.enablePropertyObfuscation);else{if(!e.terserConfig)return;o=JSON.stringify(e.terserConfig.nameCache,null,2)}r&&0<r.length&&(e=_path.default.join(r,"nameCache.json"),_fs.default.existsSync(_path.default.dirname(e))||_fs.default.mkdirSync(_path.default.dirname(e),{recursive:!0}),_fs.default.writeFileSync(e,o)),t&&0<t.length&&_fs.default.writeFileSync(t,o)}function generateConsumerObConfigFile(e,r){e={obfuscationOptions:e,compileHar:!0};new ObConfigResolver(e,r).resolveObfuscationConfigs()}_defineProperty(exports.ObConfigResolver=ObConfigResolver,"KEEP_DTS","-keep-dts"),_defineProperty(ObConfigResolver,"KEEP_GLOBAL_NAME","-keep-global-name"),_defineProperty(ObConfigResolver,"KEEP_PROPERTY_NAME","-keep-property-name"),_defineProperty(ObConfigResolver,"DISABLE_OBFUSCATION","-disable-obfuscation"),_defineProperty(ObConfigResolver,"ENABLE_PROPERTY_OBFUSCATION","-enable-property-obfuscation"),_defineProperty(ObConfigResolver,"ENABLE_STRING_PROPERTY_OBFUSCATION","-enable-string-property-obfuscation"),_defineProperty(ObConfigResolver,"ENABLE_TOPLEVEL_OBFUSCATION","-enable-toplevel-obfuscation"),_defineProperty(ObConfigResolver,"COMPACT","-compact"),_defineProperty(ObConfigResolver,"REMOVE_LOG","-remove-log"),_defineProperty(ObConfigResolver,"PRINT_NAMECACHE","-print-namecache"),_defineProperty(ObConfigResolver,"APPLY_NAMECACHE","-apply-namecache"),_defineProperty(ObConfigResolver,"optionsMap",new Map([["disableObfuscation",ObConfigResolver.KEEP_DTS],["enablePropertyObfuscation",ObConfigResolver.ENABLE_PROPERTY_OBFUSCATION],["enableStringPropertyObfuscation",ObConfigResolver.ENABLE_STRING_PROPERTY_OBFUSCATION],["enableToplevelObfuscation",ObConfigResolver.ENABLE_TOPLEVEL_OBFUSCATION],["compact",ObConfigResolver.COMPACT],["removeLog",ObConfigResolver.REMOVE_LOG]]));