"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.ArkTSLinterMode=void 0,exports.doArkTSLinter=doArkTSLinter;var _fs=_interopRequireDefault(require("fs")),_path=_interopRequireDefault(require("path")),ts=_interopRequireWildcard(require("typescript")),_main=require("../main"),_utils=require("./utils"),_ets_checker=require("./ets_checker");function _getRequireWildcardCache(e){var t,r;return"function"!=typeof WeakMap?null:(t=new WeakMap,r=new WeakMap,(_getRequireWildcardCache=function(e){return e?r:t})(e))}function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};t=_getRequireWildcardCache(t);if(t&&t.has(e))return t.get(e);var r,i,n={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&((i=o?Object.getOwnPropertyDescriptor(e,r):null)&&(i.get||i.set)?Object.defineProperty(n,r,i):n[r]=e[r]);return n.default=e,t&&t.set(e,n),n}function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}const arkTSDir="ArkTS",arkTSLinterOutputFileName="ArkTSLinter_output.json",spaceNumBeforeJsonLine=2;let ArkTSLinterMode=function(e){return e[e.NOT_USE=0]="NOT_USE",e[e.COMPATIBLE_MODE=1]="COMPATIBLE_MODE",e[e.STANDARD_MODE=2]="STANDARD_MODE",e}({});function doArkTSLinter(e,t,r,i=!0){var n,o=this;return t===ArkTSLinterMode.NOT_USE||((n=ts.createCompilerHost(e.getCompilerOptions())).resolveModuleNames=_ets_checker.resolveModuleNames,n.getCurrentDirectory=function(){return _newArrowCheck(this,o),process.cwd()}.bind(this),n.getDefaultLibFileName=function(e){return _newArrowCheck(this,o),ts.getDefaultLibFilePath(e)}.bind(this),n.resolveTypeReferenceDirectives=_ets_checker.resolveTypeReferenceDirectives,e=ts.runArkTSLinter(e,n),removeOutputFile(),0===e.length)?[]:(t===ArkTSLinterMode.COMPATIBLE_MODE?processArkTSLinterReportAsWarning(e,r,i):processArkTSLinterReportAsError(e,r),e)}function processArkTSLinterReportAsError(e,t){var r=this;e.forEach(function(e){_newArrowCheck(this,r),t(e)}.bind(this)),printArkTSLinterFAQ(e,t)}function processArkTSLinterReportAsWarning(e,r,t){var i=this,t=t?writeOutputFile(e):void 0;void 0===t?e.forEach(function(e){_newArrowCheck(this,i);var t=e.category;e.category=ts.DiagnosticCategory.Warning,r(e),e.category=t}.bind(this)):(t={file:void 0,start:void 0,length:void 0,messageText:`Has ${e.length} ArkTS Linter Error. You can get the output in `+t,category:ts.DiagnosticCategory.Warning,code:-1,reportsUnnecessary:void 0,reportsDeprecated:void 0},r(t)),printArkTSLinterFAQ(e,r)}function writeOutputFile(t){var i=this,r=(0,_utils.toUnixPath)(_main.projectConfig.cachePath);if(_fs.default.existsSync(r)){r=(0,_utils.toUnixPath)(_path.default.join(r,arkTSDir)),_fs.default.existsSync(r)||_fs.default.mkdirSync(r),r=(0,_utils.toUnixPath)(_path.default.join(r,arkTSLinterOutputFileName));const n=[];t.forEach(function(e){_newArrowCheck(this,i);var{line:t,character:r}=e.file.getLineAndCharacterOfPosition(e.start);n.push({categoryInfo:e.category===ts.DiagnosticCategory.Error?"Error":"Warning",fileName:e.file?.fileName,line:t+1,character:r+1,messageText:e.messageText})}.bind(this));let e=r;try{_fs.default.writeFileSync(r,JSON.stringify(n,void 0,spaceNumBeforeJsonLine))}catch{e=void 0}return e}}function removeOutputFile(){var e=(0,_utils.toUnixPath)(_main.projectConfig.cachePath);_fs.default.existsSync(e)&&(e=(0,_utils.toUnixPath)(_path.default.join(e,arkTSDir)),_fs.default.existsSync(e))&&(e=(0,_utils.toUnixPath)(_path.default.join(e,arkTSLinterOutputFileName)),_fs.default.existsSync(e))&&_fs.default.rmSync(e)}function printArkTSLinterFAQ(e,t){void 0===e||void 0===e.length||e.length<=0||t({file:void 0,start:void 0,length:void 0,messageText:"For details about ArkTS syntax errors, see FAQs",category:ts.DiagnosticCategory.Warning,code:-1,reportsUnnecessary:void 0,reportsDeprecated:void 0})}exports.ArkTSLinterMode=ArkTSLinterMode;