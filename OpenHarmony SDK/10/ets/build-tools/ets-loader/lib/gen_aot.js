"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.checkAotConfig=checkAotConfig,exports.generateAot=generateAot,exports.generateBuiltinAbc=generateBuiltinAbc;var childProcess=_interopRequireWildcard(require("child_process")),fs=_interopRequireWildcard(require("fs")),path=_interopRequireWildcard(require("path")),os=_interopRequireWildcard(require("os")),_pre_define=require("./pre_define"),_utils=require("./utils"),_ark_utils=require("./ark_utils");function _getRequireWildcardCache(e){var t,i;return"function"!=typeof WeakMap?null:(t=new WeakMap,i=new WeakMap,(_getRequireWildcardCache=function(e){return e?i:t})(e))}function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!=typeof e&&"function"!=typeof e)return{default:e};t=_getRequireWildcardCache(t);if(t&&t.has(e))return t.get(e);var i,r,n={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(i in e)"default"!==i&&Object.prototype.hasOwnProperty.call(e,i)&&((r=o?Object.getOwnPropertyDescriptor(e,i):null)&&(r.get||r.set)?Object.defineProperty(n,i,r):n[i]=e[i]);return n.default=e,t&&t.set(e,n),n}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}const hostToolKeyWords="[HostTool] ",logLevelIndex=4;function checkAotPartialConfig(e,t,i){return!(t.anBuildMode!==_pre_define.AOT_PARTIAL&&!t.apPath)}function checkAotFullConfig(e,t,i){return t.anBuildMode===_pre_define.AOT_FULL}function checkAotTypeConfig(e,t,i){return t.anBuildMode===_pre_define.AOT_TYPE}function checkAotConfig(e,t,i){return checkAotTypeConfig(e,t,i)||checkAotFullConfig(e,t,i)||checkAotPartialConfig(e,t,i)}function generateAot(e,t,i,r,n,o){var a=this,e=path.join((0,_ark_utils.getBuildBinDir)(e),(0,_utils.isWindows)()?"ark_aot_compiler.exe":"ark_aot_compiler"),l=path.join(r.anBuildOutPut,r.moduleName),e=((0,_utils.validateFilePathLengths)([e,i,t,l],n)||o("ArkTS:ERROR generateAot failed. Invalid file path."),fs.existsSync(i)||o(`ArkTS:ERROR generateAot failed. AppAbc not found in "${i}"`),`"${e}" --builtins-dts="${t}" `+`--aot-file="${l}" --compiler-target-triple=aarch64-unknown-linux-gnu `);let u="";r.anBuildMode===_pre_define.AOT_FULL?u=e+` "${i}"`:r.anBuildMode===_pre_define.AOT_PARTIAL?(t=r.apPath,(0,_utils.validateFilePathLength)(t,n)||o("ArkTS:ERROR generateAot failed. Invalid profile file path."),fs.existsSync(t)||o(`ArkTS:ERROR generateAot failed. Partial mode lost profile in "${t}"`),u=e+` --enable-pgo-profiler=true --compiler-pgo-profiler-path="${t}" "${i}"`):o("ArkTS:ERROR generateAot failed. unknown anBuildMode: "+r.anBuildMode);try{n.debug("generateAot cmd: "+u),(0,_utils.mkdirsSync)(r.anBuildOutPut),fs.closeSync(fs.openSync(l+".an","w")),fs.closeSync(fs.openSync(l+".ai","w"))}catch(e){e.stdout.toString().split(os.EOL).forEach(function(e){var t,i;_newArrowCheck(this,a),e.includes(hostToolKeyWords)&&(i=t="",[t,i]=e.split(hostToolKeyWords),!t&&!i||"F"!==(e=t.trim().split(/\s+/)[logLevelIndex])&&"E"!==e||n.warn("ArkTS:WARN "+i))}.bind(this)),n.warn("ArkTS:WARN "+e),n.warn("ArkTS:WARN Failed to generate aot file, the module may run with an interpreter")}}function generateBuiltinAbc(t,i,r,n,o,a){t=path.join((0,_ark_utils.getArkBuildDir)(t),"aot","src","lib_ark_builtins.d.ts"),r=path.join(r,_pre_define.TEMPORARY,"aot","lib_ark_builtins.d.abc");if(fs.existsSync(r))n.debug("builtin.d.abc already exists, no need to rebuild again");else{(0,_utils.mkdirsSync)(path.dirname(r)),(0,_utils.validateFilePathLengths)([t,r],n)||o("ArkTS:ERROR generateBuiltinAbc failed. Invalid file path.");i=i.slice(0);let e;e=a===_pre_define.TS2ABC?`${i.join(" ")} "${(0,_utils.toUnixPath)(t)}" -q -b -m --merge-abc -o "${r}"`:`${i.join(" ")} "${(0,_utils.toUnixPath)(t)}" --type-dts-builtin --type-extractor --module --merge-abc --output "${r}"`;try{n.debug("generateBuiltinAbc cmd: "+e),childProcess.execSync(e,{windowsHide:!0})}catch(e){o("ArkTS:ERROR Failed to generate builtin to abc. Error message: "+e)}}return r}