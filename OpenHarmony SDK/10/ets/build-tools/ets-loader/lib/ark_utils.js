"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.SRC_MAIN=void 0,exports.buildCachePath=buildCachePath,exports.genAbcFileName=genAbcFileName,exports.genBuildPath=genBuildPath,exports.genMergeProtoFileName=genMergeProtoFileName,exports.genProtoFileName=genProtoFileName,exports.genSourceMapFileName=genSourceMapFileName,exports.generateSourceFilesToTemporary=generateSourceFilesToTemporary,exports.getArkBuildDir=getArkBuildDir,exports.getBuildBinDir=getBuildBinDir,exports.getBuildModeInLowerCase=getBuildModeInLowerCase,exports.getOhmUrlByFilepath=getOhmUrlByFilepath,exports.getOhmUrlByHarName=getOhmUrlByHarName,exports.getOhmUrlBySystemApiOrLibRequest=getOhmUrlBySystemApiOrLibRequest,exports.getPackageInfo=getPackageInfo,exports.identifierCaches=void 0,exports.isEs2Abc=isEs2Abc,exports.isOhModules=isOhModules,exports.isTs2Abc=isTs2Abc,exports.packageCollection=exports.newSourceMaps=void 0,exports.removeDuplicateInfo=removeDuplicateInfo,exports.transformModuleSpecifier=transformModuleSpecifier,exports.writeArkguardObfuscatedSourceCode=writeArkguardObfuscatedSourceCode,exports.writeFileSyncByString=writeFileSyncByString,exports.writeMinimizedSourceCode=writeMinimizedSourceCode,exports.writeObfuscatedSourceCode=writeObfuscatedSourceCode,exports.writeTerserObfuscatedSourceCode=writeTerserObfuscatedSourceCode;var _path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),_terser=require("terser"),_arkguard=require("arkguard"),_ark_define=require("./fast_build/ark_compiler/common/ark_define"),_pre_define=require("./pre_define"),_utils=require("./utils"),_main=require("../main");function _interopRequireDefault(e){return e&&e.__esModule?e:{default:e}}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}const red="[31m",reset="[39m",SRC_MAIN="src/main";exports.SRC_MAIN=SRC_MAIN;var newSourceMaps={},identifierCaches=(exports.newSourceMaps=newSourceMaps,{});exports.identifierCaches=identifierCaches;const packageCollection=new Map;function getOhmUrlByFilepath(e,t,r,i){e.startsWith("\0")&&(e=e.replace("\0",""));let a=(0,_utils.toUnixPath)(e);a=a.substring(0,e.lastIndexOf("."));var n=getPackageInfo(t.aceModuleJsonPath),o=n[0];const s=n[1],c=(0,_utils.toUnixPath)(t.modulePathMap[s]);var u,n=(0,_utils.toUnixPath)(t.projectRootPath),l=a.replace(n,""),d=t.packageDir,p=l.match(/(\S+)\/src\/(?:main|ohosTest)\/(ets|js)\/(\S+)/);if(p&&-1===p[1].indexOf(d)){let e=p[2],t=p[3];var f=/src\/(?:main|ohosTest)\/(ets|js)\//,p=p[1].search(f);return-1!==p&&(t=l.substring(p).replace(f,""),e=l.replace(t,"").match(f)[1]),i&&s!==i?`${o}/${s}@${i}/${e}/`+t:`${o}/${s}/${e}/`+t}if(-1!==l.indexOf(d)){if("rollup"===process.env.compileTool){p=(0,_utils.toUnixPath)(_path.default.join(n,d));if(-1!==a.indexOf(p))return a.replace(p,""+d).replace(new RegExp(d,"g"),_pre_define.PACKAGES);for(const s in t.modulePathMap){var h=t.modulePathMap[s],h=(0,_utils.toUnixPath)(_path.default.resolve(h,d));if(-1!==a.indexOf(h))return a.replace(h,d+"@"+s).replace(new RegExp(d,"g"),_pre_define.PACKAGES)}return r.error(red,`ArkTS:ERROR Failed to get an resolved OhmUrl by filepath "${e}"`,reset),e}f=(0,_utils.toUnixPath)(_path.default.join(n,d));if(-1!==a.indexOf(f))return a.replace(f,d+"/"+_pre_define.ONE).replace(new RegExp(d,"g"),_pre_define.PACKAGES);l=(0,_utils.toUnixPath)(_path.default.join(c,d));if(-1!==a.indexOf(l))return a.replace(l,d+"/"+_pre_define.ZERO).replace(new RegExp(d,"g"),_pre_define.PACKAGES)}for(const _ in t.modulePathMap){const c=(0,_utils.toUnixPath)(t.modulePathMap[_]);if(-1!==a.indexOf(c+"/"))return u=a.replace(c+"/",""),i&&s!==i?`${o}/${s}@${i}/`+u:`${o}/${s}/`+u}return r.error(red,`ArkTS:ERROR Failed to get an resolved OhmUrl by filepath "${e}"`,reset),e}function getOhmUrlBySystemApiOrLibRequest(a){var n=this,e=new RegExp(`@(${_main.sdkConfigPrefix})\\.(\\S+)`),t=/lib(\S+)\.so/;return e.test(a.trim())?a.replace(e,function(e,t,r){_newArrowCheck(this,n);t=t+"."+r;if(_main.extendSdkConfigs)for(var i of _main.extendSdkConfigs.values())if("@arkui-x"!=i.prefix&&a.startsWith(i.prefix+"."))return i.prefix+":"+r;return _pre_define.NATIVE_MODULE.has(t)?"@native:"+t:"@ohos:"+r}.bind(this)):t.test(a.trim())?a.replace(t,function(e,t){return _newArrowCheck(this,n),`@app:${_main.projectConfig.bundleName}/${_main.projectConfig.moduleName}/`+t}.bind(this)):void 0}function genSourceMapFileName(e){let t=e;return t=e.endsWith(_pre_define.EXTNAME_TS)?e.replace(/\.ts$/,_pre_define.EXTNAME_TS_MAP):e.replace(/\.js$/,_pre_define.EXTNAME_JS_MAP)}function getBuildModeInLowerCase(e){return("rollup"===process.env.compileTool?e.buildMode:e.buildArkMode).toLowerCase()}function writeFileSyncByString(e,t,r,i){var a=(0,_utils.genTemporaryPath)(e,r.projectPath,process.env.cachePath,r);if(0!==a.length){if((0,_utils.mkdirsSync)(_path.default.dirname(a)),/\.js$/.test(e)){if(t=transformModuleSpecifier(e,t,r),"debug"===r.buildArkMode)return void _fs.default.writeFileSync(a,t);writeObfuscatedSourceCode(t,a,i,r)}/\.json$/.test(e)&&_fs.default.writeFileSync(a,t)}}function transformModuleSpecifier(r,e,i){var a=this;return e.replace(/(?:import|from)(?:\s*)['"]([^\.\/][^'"]+)['"]/g,function(e,t){return _newArrowCheck(this,a),replaceHarDependency(e,t,i)}.bind(this)).replace(/(?:import|from)(?:\s*)['"]((?:\.\/|\.\.\/)[^'"]+|(?:\.\/?|\.\.\/?))['"]/g,function(e,t){return _newArrowCheck(this,a),replaceRelativeDependency(e,t,(0,_utils.toUnixPath)(r),i)}.bind(this)).replace(/var (\S+) = globalThis.requireNativeModule\(['"](\S+)['"]\);/g,function(e,t,r){return _newArrowCheck(this,a),`import ${t} from '@native:${r}';`}.bind(this)).replace(/var (\S+) = globalThis.requireNapi\(['"](\S+)['"], true, ['"](\S+)['"]\);/g,function(e,t,r,i){return _newArrowCheck(this,a),`import ${t} from '@app:${i}/${r}';`}.bind(this)).replace(/var (\S+) = globalThis.requireNapi\(['"](\S+)['"]\);/g,function(e,t,r){return _newArrowCheck(this,a),`import ${t} from '@ohos:${r}';`}.bind(this))}function getOhmUrlByHarName(e,t){if(t.harNameOhmMap){if(t.harNameOhmMap.hasOwnProperty(e))return t.harNameOhmMap[e];for(const i in t.harNameOhmMap){var r;if(e.startsWith(i+"/"))return r=t.harNameOhmMap[i].split("/",2).join("/").length,r=t.harNameOhmMap[i].substring(0,r),0===e.indexOf(i+"/"+SRC_MAIN)?e.replace(i+"/"+SRC_MAIN,r):e.replace(i,r)}}}function replaceHarDependency(e,t,r){var i=this;const a=getOhmUrlByHarName(t,r);return void 0!==a?e.replace(/(['"])(?:\S+)['"]/,function(e,t){return _newArrowCheck(this,i),t+a+t}.bind(this)):e}function locateActualFilePathWithModuleRequest(e){var t;return!_fs.default.existsSync(e)||!_fs.default.statSync(e).isDirectory()||(t=e+(0,_utils.getExtensionIfUnfullySpecifiedFilepath)(e),_fs.default.existsSync(t)&&_fs.default.statSync(t).isFile())?e:_path.default.join(e,"index")}function replaceRelativeDependency(e,i,t,r){var a,n,o=this;return t&&r.compileMode===_pre_define.ESMODULE&&(i=i.replace(/\.(?:[cm]?js|[e]?ts|json)$/,""),e=e.replace(/(['"])(?:\S+)['"]/,function(e,t){_newArrowCheck(this,o);let r=(0,_utils.toUnixPath)(_path.default.normalize(i));return t+(r=i.startsWith("./")?"./"+r:r)+t}.bind(this)),t=locateActualFilePathWithModuleRequest(_path.default.resolve(_path.default.dirname(t),i)).match(/(\S+)(\/|\\)src(\/|\\)(?:main|ohosTest)(\/|\\)(ets|js)(\/|\\)(\S+)/))&&r.aceModuleJsonPath&&(a=t[1].search(/(\/|\\)node_modules(\/|\\)/),n=r.projectRootPath,-1!==a&&a!==n.search(/(\/|\\)node_modules(\/|\\)/)||(n=(a=getPackageInfo(r.aceModuleJsonPath))[0],r=a[1],i=`@bundle:${n}/${r}/${t[5]}/`+(0,_utils.toUnixPath)(t[7]),e=e.replace(/(['"])(?:\S+)['"]/,function(e,t){return _newArrowCheck(this,o),t+i+t}.bind(this)))),e}async function writeObfuscatedSourceCode(e,t,r,i,a="",n={}){i.arkObfuscator?await writeArkguardObfuscatedSourceCode(e,t,r,i.arkObfuscator,a,n,i.obfuscationMergedObConfig):i.terserConfig?await writeTerserObfuscatedSourceCode(e,t,r,i.terserConfig,a,n):"rollup"!==process.env.compileTool?await writeMinimizedSourceCode(e,t,r,i.compileHar):_fs.default.writeFileSync(t,e)}async function writeArkguardObfuscatedSourceCode(e,t,r,i,a="",n={},o){let s=void 0,c=(0<a.length&&(s=n[a]),void 0);identifierCaches&&identifierCaches[a]&&(c=(0,_arkguard.getMapFromJson)(identifierCaches[a]));let u;try{u=await i.obfuscate(e,t,s,c)}catch{r.error(red,"ArkTS:ERROR Failed to obfuscate file: "+a),process.exit(_pre_define.FAIL)}u.sourceMap&&(u.sourceMap.sources=[a],n[a]=u.sourceMap),u.nameCache&&(identifierCaches[a]=u.nameCache),_fs.default.writeFileSync(t,u.content??"")}async function writeTerserObfuscatedSourceCode(e,t,r,i,a="",n={}){let o;0<a.length&&(i.sourceMap={content:n[a],asObject:!0});try{o=await(0,_terser.minify)(e,i)}catch{r.error(red,"ArkTS:ERROR Failed to obfuscate file: "+a),process.exit(_pre_define.FAIL)}o.map&&(o.map.sourcesContent&&delete o.map.sourcesContent,o.map.sources=[a],n[a]=o.map),_fs.default.writeFileSync(t,o.code??"")}async function writeMinimizedSourceCode(e,t,r,i=!1){let a;try{var n={compress:{join_vars:!1,sequences:0,directives:!1}};i||(n.format={semicolons:!1,beautify:!0,indent_level:2}),a=await(0,_terser.minify)(e,n)}catch{r.error(red,"ArkTS:ERROR Failed to source code obfuscation.",reset),process.exit(_pre_define.FAIL)}_fs.default.writeFileSync(t,a.code)}function genBuildPath(t,e,r,i){if((t=(t=(0,_utils.toUnixPath)(t)).endsWith(_pre_define.EXTNAME_MJS)?t.replace(/\.mjs$/,_pre_define.EXTNAME_JS):t).endsWith(_pre_define.EXTNAME_CJS)&&(t=t.replace(/\.cjs$/,_pre_define.EXTNAME_JS)),e=(0,_utils.toUnixPath)(e),(0,_utils.isPackageModulesFile)(t,i)){var a,n=i.packageDir,o=(0,_utils.toUnixPath)(_path.default.join(i.projectRootPath,n));let e="";return e=-1===t.indexOf(o)?(a=(0,_utils.toUnixPath)(i.projectRootPath),a=(a=t.replace(a,"")).substring(a.indexOf(n)+n.length+1),_path.default.join(i.nodeModulesPath,_pre_define.ZERO,a)):t.replace(o,_path.default.join(i.nodeModulesPath,_pre_define.ONE))}return-1!==t.indexOf(e)?(n=t.replace(e,""),_path.default.join(r,n)):""}function getPackageInfo(e){var t,r;return packageCollection.has(e)?packageCollection.get(e):(t=(r=JSON.parse(_fs.default.readFileSync(e).toString())).app.bundleName,r=r.module.name,packageCollection.set(e,[t,r]),[t,r])}function generateSourceFilesToTemporary(e,t,r,i,a){let n=(0,_utils.genTemporaryPath)(e,i.projectPath,process.env.cachePath,i);var o;0!==n.length&&(0<genSourceMapFileName(n=n.endsWith(_pre_define.EXTNAME_ETS)?n.replace(/\.ets$/,_pre_define.EXTNAME_JS):n.replace(/\.ts$/,_pre_define.EXTNAME_JS)).length&&"debug"===i.buildArkMode&&(o=(0,_utils.toUnixPath)(e).replace((0,_utils.toUnixPath)(i.projectRootPath)+"/",""),r.sources=[o],r.file=_path.default.basename(r.file),delete r.sourcesContent,newSourceMaps[o]=r),t=transformModuleSpecifier(e,t,i),(0,_utils.mkdirsSync)(_path.default.dirname(n)),"debug"===i.buildArkMode?_fs.default.writeFileSync(n,t):writeObfuscatedSourceCode(t,n,a,i))}function genAbcFileName(e){let t=e;return t=e.endsWith(_pre_define.EXTNAME_TS)?e.replace(/\.ts$/,_pre_define.EXTNAME_ABC):e.replace(/\.js$/,_pre_define.EXTNAME_ABC)}function isOhModules(e){return e.packageDir===_ark_define.OH_MODULES}function isEs2Abc(e){return e.pandaMode===_pre_define.ES2ABC||"undefined"===e.pandaMode||void 0===e.pandaMode}function isTs2Abc(e){return e.pandaMode===_pre_define.TS2ABC}function genProtoFileName(e){return e.replace(/\.(?:[tj]s|json)$/,_pre_define.EXTNAME_PROTO_BIN)}function genMergeProtoFileName(e){e=e.split(_pre_define.TEMPORARY),e=e[e.length-1];return _path.default.join(process.env.cachePath,"protos",e)}function removeDuplicateInfo(e){var i=this;const a=Array();return e.forEach(function(t){var r=this,e=(_newArrowCheck(this,i),a.every(function(e){return _newArrowCheck(this,r),t.tempFilePath!==e.tempFilePath}.bind(this)));e&&a.push(t)}.bind(this)),e=a}function buildCachePath(e,t,r){t=void 0!==process.env.cachePath?_path.default.join(t.cachePath,e):_path.default.join(t.aceModuleBuild,e);return(0,_utils.validateFilePathLength)(t,r),t}function getArkBuildDir(e){return(0,_utils.isWindows)()?_path.default.join(e,"build-win"):(0,_utils.isMac)()?_path.default.join(e,"build-mac"):_path.default.join(e,"build")}function getBuildBinDir(e){return _path.default.join(getArkBuildDir(e),"bin")}exports.packageCollection=packageCollection;