"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof2=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.FUNC_START_REG=exports.FUNC_START=exports.FUNC_END_REG=exports.FUNC_END=void 0,exports.circularFile=circularFile,exports.consumeMap=consumeMap,exports.elements=void 0,exports.generateMap=generateMap,exports.getFileNameWithHash=getFileNameWithHash,exports.getFilenameByPath=getFilenameByPath,exports.getNameByPath=getNameByPath,exports.getRequireString=getRequireString,exports.jsonLoaders=jsonLoaders,exports.loadBabelModule=loadBabelModule,exports.logWarn=logWarn,exports.mkDir=mkDir,exports.parseRequireModule=parseRequireModule,exports.printSourceWithLine=printSourceWithLine,exports.splitSourceLine=splitSourceLine,exports.stringifyFunction=stringifyFunction,exports.stringifyLoaders=stringifyLoaders,exports.useOSFiles=void 0,_interopRequireDefault(require("@babel/runtime/helpers/typeof"))),_path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),_loaderUtils=_interopRequireDefault(require("loader-utils")),_sourceMap=require("source-map");function _createForOfIteratorHelper(e,r){var t,n,a,o,i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(i)return n=!(t=!0),{s:function(){i=i.call(e)},n:function(){var e=i.next();return t=e.done,e},e:function(e){n=!0,a=e},f:function(){try{t||null==i.return||i.return()}finally{if(n)throw a}}};if(Array.isArray(e)||(i=_unsupportedIterableToArray(e))||r&&e&&"number"==typeof e.length)return i&&(e=i),o=0,{s:r=function(){},n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:r};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,r){var t;if(e)return"string"==typeof e?_arrayLikeToArray(e,r):"Map"===(t="Object"===(t=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:t)||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_arrayLikeToArray(e,r):void 0}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var t=0,n=new Array(r);t<r;t++)n[t]=e[t];return n}var crypto=require("crypto"),_require=require("../main.product"),systemModules=_require.systemModules,_require2=require("./lite/lite-enum"),DEVICE_LEVEL=_require2.DEVICE_LEVEL,useOSFiles=new Set,elements=(exports.useOSFiles=useOSFiles,{});function getNameByPath(e){return _path.default.basename(e).replace(/\..*$/,"")}function getFileNameWithHash(e,r){var e=_path.default.relative(".",e),t=crypto.createHash("sha256"),r=(t.update((e+r).toString()),t.digest("hex"));return"./".concat(e,"?").concat(r)}function getFilenameByPath(e){return _path.default.relative(".",e)}exports.elements=elements;var FUNC_START="#####FUN_S#####",FUNC_START_REG=(exports.FUNC_START=FUNC_START,new RegExp("[\"']"+FUNC_START,"g")),FUNC_END=(exports.FUNC_START_REG=FUNC_START_REG,"#####FUN_E#####"),FUNC_END_REG=(exports.FUNC_END=FUNC_END,new RegExp(FUNC_END+"[\"']","g"));function stringifyFunction(e,r){return"function"==typeof r?FUNC_START+r.toString()+FUNC_END:r}function logWarn(r,e){var t=!1;return 0<process.env.logLevel&&e&&e.length&&e.forEach(function(e){e.reason.startsWith("NOTE")&&parseInt(process.env.logLevel)<=1?e.line&&e.column?r.emitWarning("noteStartNOTE File:"+r.resourcePath+":"+e.line+":"+e.column+"\n "+e.reason.replace("NOTE: ","")+"noteEnd"):r.emitWarning("noteStartNOTE File:"+r.resourcePath+"\n "+e.reason.replace("NOTE: ","")+"noteEnd"):e.reason.startsWith("WARN")&&parseInt(process.env.logLevel)<=2?e.line&&e.column?r.emitWarning("warnStartWARNING File:"+r.resourcePath+":"+e.line+":"+e.column+"\n "+e.reason.replace("WARNING: ","")+"warnEnd"):r.emitWarning("warnStartWARNING File:"+r.resourcePath+"\n "+e.reason.replace("WARNING: ","")+"warnEnd"):e.reason.startsWith("ERROR")&&parseInt(process.env.logLevel)<=3&&(t=!0,e.line&&e.column?r.emitError("errorStartERROR File:"+r.resourcePath+":"+e.line+":"+e.column+"\n "+e.reason.replace("ERROR: ","")+"errorEnd"):r.emitError("errorStartERROR File:"+r.resourcePath+"\n "+e.reason.replace("ERROR: ","")+"errorEnd"))}),t}function getRequireString(e,r,t){return"require("+_loaderUtils.default.stringifyRequest(e,(r?"!!".concat(r,"!"):"").concat(t))+")\n"}function stringifyLoaders(e){return e.map(function(e){if("string"==typeof e)return e;var r=e.name,t=[];if(e.query)for(var n in e.query){var a=e.query[n];null!=a&&(!0===a?t.push(n):a instanceof Array?t.push("".concat(n,"[]=").concat(a.join(","))):t.push("".concat(n,"=").concat(a)))}return"".concat(r).concat(t.length?"?"+t.join("&"):"")}).join("!")}function generateMap(e,r,t){var n,a=getFileNameWithHash(e.resourcePath),e=_path.default.resolve("."),o=new _sourceMap.SourceMapGenerator({sourceRoot:e,skipValidation:!0}),i=(o.setSourceContent(a,r),_createForOfIteratorHelper(t));try{for(i.s();!(n=i.n()).done;){var s=n.value,u=s.original,l=s.generated;o.addMapping({source:a,original:u,generated:l})}}catch(e){i.e(e)}finally{i.f()}return o}function consumeMap(e,r,t){var n,a=new _sourceMap.SourceMapConsumer(t),o=[],i=[],s={};return splitSourceLine(r).forEach(function(e,r){var t=a.originalPositionFor({line:r+=1,column:0});t.source&&(n=t.source,o.push({line:t.line,column:t.column}),i.push({line:r,column:0}),s["line-".concat(r,"-column-").concat(0)]={line:t.line,column:t.column})}),{source:n,original:o,generated:i,mapping:s,sourcesContent:a.sourcesContent}}exports.FUNC_END_REG=FUNC_END_REG;var LINE_REG=/\r?\n/g;function splitSourceLine(e){return e.split(LINE_REG)}function printSourceWithLine(e){console.log(">>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>"),e=splitSourceLine(e).map(function(e,r){console.log(r+1+":",e)}),console.log("<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<")}function loadBabelModule(r){try{var e=require.resolve(r);return e.slice(0,e.indexOf(r.replace(/\//g,_path.default.sep))+r.length)}catch(e){return r}}var methodForLite="\nfunction requireModule(moduleName) {\n  return requireNative(moduleName.slice(1));\n}\n",methodForOthers="\nfunction requireModule(moduleName) {\n  const systemList = ['system.router', 'system.app', 'system.prompt', 'system.configuration',\n  'system.image', 'system.device', 'system.mediaquery', 'ohos.animator', 'system.grid', 'system.resource']\n  var target = ''\n  if (systemList.includes(moduleName.replace('@', ''))) {\n    target = $app_require$('@app-module/' + moduleName.substring(1));\n    return target;\n  }\n  var shortName = moduleName.replace(/@[^.]+.([^.]+)/, '$1');\n  target = requireNapi(shortName);\n  if (typeof target !== 'undefined' && /@ohos/.test(moduleName)) {\n    return target;\n  }\n  if (typeof ohosplugin !== 'undefined' && /@ohos/.test(moduleName)) {\n    target = ohosplugin;\n    for (let key of shortName.split('.')) {\n      target = target[key];\n      if(!target) {\n        break;\n      }\n    }\n    if (typeof target !== 'undefined') {\n      return target;\n    }\n  }\n  if (typeof systemplugin !== 'undefined') {\n    target = systemplugin;\n    for (let key of shortName.split('.')) {\n      target = target[key];\n      if(!target) {\n        break;\n      }\n    }\n    if (typeof target !== 'undefined') {\n      return target;\n    }\n  }\n  return target;\n}\n";function parseRequireModule(e,t){var r=process.env.DEVICE_LEVEL===DEVICE_LEVEL.LITE?methodForLite:methodForOthers,r=(e="".concat(e,"\n").concat(r),/require\(['"]([^()]+)['"]\)/g),n=/^lib(.+)\.so$/,a=/@(system|ohos)\.(\S+)/g,o=e.match(r);if(o&&o.length){var i,s=_createForOfIteratorHelper(o);try{for(s.s();!(i=s.n()).done;){var u=i.value,l=/\((\"|\')(.+)(\"|\')\)/.exec(u);u.match(a)&&l&&3<l.length&&(0!=systemModules.length&&!systemModules.includes(l[2]+".d.ts")&&"lite"!==process.env.DEVICE_LEVEL||(e=e.replace(u,u.replace("require","requireModule"))))}}catch(e){s.e(e)}finally{s.f()}}return e=e.replace(r,function(e,r){return n.test(r)&&(e='requireNapi("'.concat(r.replace(n,"$1"),'", true)'),t)&&useOSFiles.add(t),e})}function jsonLoaders(e,r,t,n){var a=[];switch(e){case"template":a=[{name:_path.default.resolve(__dirname,"json.js")},{name:_path.default.resolve(__dirname,"template.js")}];break;case"style":a=[{name:_path.default.resolve(__dirname,"json.js")},{name:_path.default.resolve(__dirname,"style.js")}];break;case"json":a=[{name:_path.default.resolve(__dirname,"json.js")}]}return r&&a.push({name:_path.default.resolve(__dirname,"../node_modules/".concat(r))}),t&&a.push({name:_path.default.resolve(__dirname,"extgen.js"),query:{type:n}}),stringifyLoaders(a)}function circularFile(t,n){t&&n&&_fs.default.readdir(t,function(e,r){r&&r.forEach(function(e){var r=_path.default.resolve(t,e),e=_path.default.resolve(n,e);(_fs.default.statSync(r).isFile()?copyFile:circularFile)(r,e)})})}function copyFile(e,r){try{var t=_path.default.join(r,"..");_fs.default.existsSync(t)&&_fs.default.statSync(t).isDirectory()||mkDir(t),"i18n"===_path.default.parse(t).name&&".json"===_path.default.parse(e).ext&&_fs.default.existsSync(r)?copyJsonFile(e,r):_fs.default.existsSync(r)||_fs.default.writeFileSync(r,_fs.default.readFileSync(e))}catch(e){throw e}}function copyJsonFile(e,r){try{var t=JSON.parse(_fs.default.readFileSync(e,"utf-8")),n=JSON.parse(_fs.default.readFileSync(r,"utf-8"));Object.keys(t).forEach(function(e){var r=mergeJson(t[e],n[e]);n[e]=r}),_fs.default.writeFileSync(r,JSON.stringify(n,null,"\t"))}catch(e){throw e}}function mergeJson(t,n){var e;return null==n?t:((e=(0,_typeof2.default)(t))===(0,_typeof2.default)(n)&&"object"===e&&Object.keys(t).forEach(function(e){var r=mergeJson(t[e],n[e]);n[e]=r}),n)}function mkDir(e){var r=_path.default.join(e,"..");_fs.default.existsSync(r)&&!_fs.default.statSync(r).isFile()||mkDir(r),_fs.default.mkdirSync(e)}