"use strict";var output,webpackPath,_interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),fs=require("fs"),path=require("path"),process=require("child_process"),qjsc=path.join(__dirname,"..","bin","qjsc"),checkWorksFile=require("./genAbc-plugin").checkWorksFile,forward='(global.___mainEntry___ = function (globalObjects) {\n  const define = globalObjects.define;\n  const require = globalObjects.require;\n  const bootstrap = globalObjects.bootstrap;\n  const register = globalObjects.register;\n  const render = globalObjects.render;\n  const $app_define$ = globalObjects.$app_define$;\n  const $app_bootstrap$ = globalObjects.$app_bootstrap$;\n  const $app_require$ = globalObjects.$app_require$;\n  const history = globalObjects.history;\n  const Image = globalObjects.Image;\n  const OffscreenCanvas = globalObjects.OffscreenCanvas;\n  (function(global) {\n    "use strict";\n',last="\n})(this.__appProto__);\n})",firstFileEXT=".jtc",sencondFileEXT=".c",lastFileEXT=".bin",workerFile=null,GenBinPlugin=function(){function n(e,t,s){(0,_classCallCheck2.default)(this,n),output=e,webpackPath=t,workerFile=s}return(0,_createClass2.default)(n,[{key:"apply",value:function(e){(fs.existsSync(path.resolve(webpackPath,"qjsc.exe"))||fs.existsSync(path.resolve(webpackPath,"qjsc")))&&e.hooks.emit.tap("GenBinPlugin",function(e){var n=e.assets;Object.keys(n).forEach(function(e){var t,s;output&&webpackPath&&".js"===path.extname(e)&&(t=n[e].source(),checkWorksFile(e,workerFile)&&(t=forward+t+last),s=e.replace(/\.js$/,firstFileEXT),writeFileSync(t,path.resolve(output,s),e))})})}}]),n}();function writeFileSync(e,t,s){var n=path.join(t,"..");fs.existsSync(n)&&fs.statSync(n).isDirectory()||mkDir(n),fs.writeFileSync(t,e),fs.existsSync(t)?qjscFirst(t,t.replace(/\.jtc$/,sencondFileEXT)):console.error("[31m","Failed to convert file ".concat(s," to bin. ").concat(t," is lost"),"[39m")}function mkDir(e){var t=path.join(e,"..");fs.existsSync(t)&&!fs.statSync(t).isFile()||mkDir(t),fs.mkdirSync(e)}function qjscFirst(t,e){var s='"'.concat(qjsc,'" -o "').concat(e,'" -N buf -c "').concat(t,'"');try{process.execSync(s)}catch(e){console.error("[31m","Failed to convert file ".concat(t," to bin"),"[39m")}fs.existsSync(t)?(fs.unlinkSync(t),qjscSecond(e)):console.error("[31m","Failed to convert file ".concat(t," to bin. ").concat(t," is lost"),"[39m")}function qjscSecond(e){var t=(t=fs.readFileSync(e,"utf8")).substr(t.indexOf("{")+1,t.indexOf("}")-t.indexOf("{")-1).trim(),s=e.replace(/\.c$/,lastFileEXT),n=path.join(s,"..");fs.existsSync(n)&&fs.statSync(n).isDirectory()||mkDir(n),fs.writeFileSync(s,toBuffer(t)),fs.existsSync(e)?fs.unlinkSync(e):console.error("[31m","Failed to clean file ".concat(e,"."),"[39m")}function toBuffer(e){for(var t=e.split(","),s=Buffer.alloc(t.length),n=0;n<t.length;n++)s[n]=t[n];return s}module.exports=GenBinPlugin;