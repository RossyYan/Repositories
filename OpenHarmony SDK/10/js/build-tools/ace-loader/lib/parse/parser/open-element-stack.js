"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.OpenElementStack=void 0;const html_js_1=require("../common/html.js"),IMPLICIT_END_TAG_REQUIRED=new Set([html_js_1.TAG_ID.DD,html_js_1.TAG_ID.DT,html_js_1.TAG_ID.LI,html_js_1.TAG_ID.OPTGROUP,html_js_1.TAG_ID.OPTION,html_js_1.TAG_ID.P,html_js_1.TAG_ID.RB,html_js_1.TAG_ID.RP,html_js_1.TAG_ID.RT,html_js_1.TAG_ID.RTC]),IMPLICIT_END_TAG_REQUIRED_THOROUGHLY=new Set([...IMPLICIT_END_TAG_REQUIRED,html_js_1.TAG_ID.CAPTION,html_js_1.TAG_ID.COLGROUP,html_js_1.TAG_ID.TBODY,html_js_1.TAG_ID.TD,html_js_1.TAG_ID.TFOOT,html_js_1.TAG_ID.TH,html_js_1.TAG_ID.THEAD,html_js_1.TAG_ID.TR]),SCOPING_ELEMENT_NS=new Map([[html_js_1.TAG_ID.APPLET,html_js_1.NS.HTML],[html_js_1.TAG_ID.CAPTION,html_js_1.NS.HTML],[html_js_1.TAG_ID.HTML,html_js_1.NS.HTML],[html_js_1.TAG_ID.MARQUEE,html_js_1.NS.HTML],[html_js_1.TAG_ID.OBJECT,html_js_1.NS.HTML],[html_js_1.TAG_ID.TABLE,html_js_1.NS.HTML],[html_js_1.TAG_ID.TD,html_js_1.NS.HTML],[html_js_1.TAG_ID.TEMPLATE,html_js_1.NS.HTML],[html_js_1.TAG_ID.TH,html_js_1.NS.HTML],[html_js_1.TAG_ID.ANNOTATION_XML,html_js_1.NS.MATHML],[html_js_1.TAG_ID.MI,html_js_1.NS.MATHML],[html_js_1.TAG_ID.MN,html_js_1.NS.MATHML],[html_js_1.TAG_ID.MO,html_js_1.NS.MATHML],[html_js_1.TAG_ID.MS,html_js_1.NS.MATHML],[html_js_1.TAG_ID.MTEXT,html_js_1.NS.MATHML],[html_js_1.TAG_ID.DESC,html_js_1.NS.SVG],[html_js_1.TAG_ID.FOREIGN_OBJECT,html_js_1.NS.SVG],[html_js_1.TAG_ID.TITLE,html_js_1.NS.SVG]]),NAMED_HEADERS=[html_js_1.TAG_ID.H1,html_js_1.TAG_ID.H2,html_js_1.TAG_ID.H3,html_js_1.TAG_ID.H4,html_js_1.TAG_ID.H5,html_js_1.TAG_ID.H6],TABLE_ROW_CONTEXT=[html_js_1.TAG_ID.TR,html_js_1.TAG_ID.TEMPLATE,html_js_1.TAG_ID.HTML],TABLE_BODY_CONTEXT=[html_js_1.TAG_ID.TBODY,html_js_1.TAG_ID.TFOOT,html_js_1.TAG_ID.THEAD,html_js_1.TAG_ID.TEMPLATE,html_js_1.TAG_ID.HTML],TABLE_CONTEXT=[html_js_1.TAG_ID.TABLE,html_js_1.TAG_ID.TEMPLATE,html_js_1.TAG_ID.HTML],TABLE_CELLS=[html_js_1.TAG_ID.TD,html_js_1.TAG_ID.TH];class OpenElementStack{get currentTmplContentOrNode(){return this._isInTemplate()?this.treeAdapter.getTemplateContent(this.current):this.current}constructor(t,s,_){this.treeAdapter=s,this.handler=_,this.items=[],this.tagIDs=[],this.stackTop=-1,this.tmplCount=0,this.currentTagId=html_js_1.TAG_ID.UNKNOWN,this.current=t}_indexOf(t){return this.items.lastIndexOf(t,this.stackTop)}_isInTemplate(){return this.currentTagId===html_js_1.TAG_ID.TEMPLATE&&this.treeAdapter.getNamespaceURI(this.current)===html_js_1.NS.HTML}_updateCurrentElement(){this.current=this.items[this.stackTop],this.currentTagId=this.tagIDs[this.stackTop]}push(t,s){this.stackTop++,this.items[this.stackTop]=t,this.current=t,this.tagIDs[this.stackTop]=s,this.currentTagId=s,this._isInTemplate()&&this.tmplCount++,this.handler.onItemPush(t,s,!0)}pop(){var t=this.current;0<this.tmplCount&&this._isInTemplate()&&this.tmplCount--,this.stackTop--,this._updateCurrentElement(),this.handler.onItemPop(t,!0)}replace(t,s){t=this._indexOf(t);this.items[t]=s,t===this.stackTop&&(this.current=s)}insertAfter(t,s,_){t=this._indexOf(t)+1;this.items.splice(t,0,s),this.tagIDs.splice(t,0,_),this.stackTop++,t===this.stackTop&&this._updateCurrentElement(),this.handler.onItemPush(this.current,this.currentTagId,t===this.stackTop)}popUntilTagNamePopped(t){let s=this.stackTop+1;for(;0<(s=this.tagIDs.lastIndexOf(t,s-1))&&this.treeAdapter.getNamespaceURI(this.items[s])!==html_js_1.NS.HTML;);this.shortenToLength(s<0?0:s)}shortenToLength(t){for(;this.stackTop>=t;){var s=this.current;0<this.tmplCount&&this._isInTemplate()&&--this.tmplCount,this.stackTop--,this._updateCurrentElement(),this.handler.onItemPop(s,this.stackTop<t)}}popUntilElementPopped(t){t=this._indexOf(t);this.shortenToLength(t<0?0:t)}popUntilPopped(t,s){t=this._indexOfTagNames(t,s);this.shortenToLength(t<0?0:t)}popUntilNumberedHeaderPopped(){this.popUntilPopped(NAMED_HEADERS,html_js_1.NS.HTML)}popUntilTableCellPopped(){this.popUntilPopped(TABLE_CELLS,html_js_1.NS.HTML)}popAllUpToHtmlElement(){this.tmplCount=0,this.shortenToLength(1)}_indexOfTagNames(s,_){for(let t=this.stackTop;0<=t;t--)if(s.includes(this.tagIDs[t])&&this.treeAdapter.getNamespaceURI(this.items[t])===_)return t;return-1}clearBackTo(t,s){t=this._indexOfTagNames(t,s);this.shortenToLength(t+1)}clearBackToTableContext(){this.clearBackTo(TABLE_CONTEXT,html_js_1.NS.HTML)}clearBackToTableBodyContext(){this.clearBackTo(TABLE_BODY_CONTEXT,html_js_1.NS.HTML)}clearBackToTableRowContext(){this.clearBackTo(TABLE_ROW_CONTEXT,html_js_1.NS.HTML)}remove(t){var s=this._indexOf(t);0<=s&&(s===this.stackTop?this.pop():(this.items.splice(s,1),this.tagIDs.splice(s,1),this.stackTop--,this._updateCurrentElement(),this.handler.onItemPop(t,!1)))}tryPeekProperlyNestedBodyElement(){return 1<=this.stackTop&&this.tagIDs[1]===html_js_1.TAG_ID.BODY?this.items[1]:null}contains(t){return-1<this._indexOf(t)}getCommonAncestor(t){t=this._indexOf(t)-1;return 0<=t?this.items[t]:null}isRootHtmlElementCurrent(){return 0===this.stackTop&&this.tagIDs[0]===html_js_1.TAG_ID.HTML}hasInScope(s){for(let t=this.stackTop;0<=t;t--){var _=this.tagIDs[t],e=this.treeAdapter.getNamespaceURI(this.items[t]);if(_===s&&e===html_js_1.NS.HTML)return!0;if(SCOPING_ELEMENT_NS.get(_)===e)return!1}return!0}hasNumberedHeaderInScope(){for(let t=this.stackTop;0<=t;t--){var s=this.tagIDs[t],_=this.treeAdapter.getNamespaceURI(this.items[t]);if((0,html_js_1.isNumberedHeader)(s)&&_===html_js_1.NS.HTML)return!0;if(SCOPING_ELEMENT_NS.get(s)===_)return!1}return!0}hasInListItemScope(s){for(let t=this.stackTop;0<=t;t--){var _=this.tagIDs[t],e=this.treeAdapter.getNamespaceURI(this.items[t]);if(_===s&&e===html_js_1.NS.HTML)return!0;if((_===html_js_1.TAG_ID.UL||_===html_js_1.TAG_ID.OL)&&e===html_js_1.NS.HTML||SCOPING_ELEMENT_NS.get(_)===e)return!1}return!0}hasInButtonScope(s){for(let t=this.stackTop;0<=t;t--){var _=this.tagIDs[t],e=this.treeAdapter.getNamespaceURI(this.items[t]);if(_===s&&e===html_js_1.NS.HTML)return!0;if(_===html_js_1.TAG_ID.BUTTON&&e===html_js_1.NS.HTML||SCOPING_ELEMENT_NS.get(_)===e)return!1}return!0}hasInTableScope(s){for(let t=this.stackTop;0<=t;t--){var _=this.tagIDs[t],e=this.treeAdapter.getNamespaceURI(this.items[t]);if(e===html_js_1.NS.HTML){if(_===s)return!0;if(_===html_js_1.TAG_ID.TABLE||_===html_js_1.TAG_ID.TEMPLATE||_===html_js_1.TAG_ID.HTML)return!1}}return!0}hasTableBodyContextInTableScope(){for(let t=this.stackTop;0<=t;t--){var s=this.tagIDs[t],_=this.treeAdapter.getNamespaceURI(this.items[t]);if(_===html_js_1.NS.HTML){if(s===html_js_1.TAG_ID.TBODY||s===html_js_1.TAG_ID.THEAD||s===html_js_1.TAG_ID.TFOOT)return!0;if(s===html_js_1.TAG_ID.TABLE||s===html_js_1.TAG_ID.HTML)return!1}}return!0}hasInSelectScope(s){for(let t=this.stackTop;0<=t;t--){var _=this.tagIDs[t],e=this.treeAdapter.getNamespaceURI(this.items[t]);if(e===html_js_1.NS.HTML){if(_===s)return!0;if(_!==html_js_1.TAG_ID.OPTION&&_!==html_js_1.TAG_ID.OPTGROUP)return!1}}return!0}generateImpliedEndTags(){for(;IMPLICIT_END_TAG_REQUIRED.has(this.currentTagId);)this.pop()}generateImpliedEndTagsThoroughly(){for(;IMPLICIT_END_TAG_REQUIRED_THOROUGHLY.has(this.currentTagId);)this.pop()}generateImpliedEndTagsWithExclusion(t){for(;this.currentTagId!==t&&IMPLICIT_END_TAG_REQUIRED_THOROUGHLY.has(this.currentTagId);)this.pop()}}exports.OpenElementStack=OpenElementStack;