"use strict";var _util=require("./util"),path=require("path"),transCardArray=require("./templater/bind").transCardArray,resourceReferenceParsing=require("./resource-reference-script"),REG_EVENT_STRING=/("\s*\$event\..+")|('\s*\$event\..+')/g,REG_EVENT=/\$event\.[\w]+/g,REG_THIS=/this\..*/g;module.exports=function(source){this.cacheable&&this.cacheable();var extName=path.extname(this.resourcePath);if("card"===process.env.DEVICE_LEVEL&&(source=source.replace(/\/\*((\n|\r|.)*?)\*\//gm,""),source=source.replace(/(\s|\;|^|\{|\})\/\/.*$/gm,"$1"),".js"===extName||".json"===extName)){if(0===source.trim().indexOf("export default")&&(source=source.replace("export default","")),source=resourceReferenceParsing(source),source=source.replace(REG_EVENT_STRING,function(e){return e.slice(1,-1)}),source=source.replace(REG_EVENT,function(e){return'"'+e+'"'}),source=source.replace(REG_THIS,function(e){return e='"'!==e.charAt(e.length-1)&&"'"!==e.charAt(e.length-1)&&'",'!==e.slice(-2)&&"',"!==e.slice(-2)?(","===e.charAt(e.length-1)?'"{{'.concat(transCardArray(e.slice(0,-1)),'}}",'):'"{{'.concat(transCardArray(e),'}}"')).replace(/this\./g,""):e}),".js"!==extName)return source;try{source=JSON.stringify(eval("("+source+")"))}catch(e){return(0,_util.logWarn)(this,[{reason:"ERROR: Failed to parse the file : "+this.resourcePath+"\n".concat(e)}]),"{}"}}return"module.exports = ".concat(source)};