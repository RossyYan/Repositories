"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),_util=require("./util"),_parser=require("./parser");function loader(e){var r=this,i=(this.cacheable&&this.cacheable(),{sass:["sass-loader"],scss:["sass-loader"],less:["less-loader"]}),o=this.resourcePath,c=o.replace(_path.default.extname(o).toString(),""),u="//card_start\n",t=(u+="var card_template ="+(0,_util.getRequireString)(this,(0,_util.jsonLoaders)("template"),o),findStyleFile(c)),t=(1==t.extStyle&&(u+="var card_style ="+(0,_util.getRequireString)(this,(0,_util.jsonLoaders)("style",i[t.type]),t.styleFileName)),u=addJson(this,u,c,""),(0,_parser.parseFragment)(e)),_=new Set;return t.element&&t.element.forEach(function(e){var t,s,a,n,l;e.src?(e.src.match(/\.hml$/)||(e.src=e.src.concat(".hml")),t=_path.default.join(o,"..",e.src),_fs.default.existsSync(t)?(l=(e.name?e:_path.default.parse(e.src)).name.toLowerCase(),_.has(l)?(0,_util.logWarn)(r,[{reason:"ERROR: The custom elements cannot have the same attribute 'name' or file name (case insensitive).",line:e.node.__location.line,column:e.node.__location.col}]):(_.add(l),s=t.replace(_path.default.extname(t).toString(),""),a=_path.default.basename(t).replace(_path.default.extname(t).toString(),""),u+="var card_element_template_".concat(a," =")+(0,_util.getRequireString)(r,(0,_util.jsonLoaders)("template"),t+"?".concat(l,"#").concat(c)),1==(n=findStyleFile(s)).extStyle&&(u+="var card_element_style_".concat(a," =")+(0,_util.getRequireString)(r,(0,_util.jsonLoaders)("style",i[n.type]),n.styleFileName+"?".concat(l,"#").concat(c))),u=addJson(r,u,s,"?".concat(l,"#").concat(c),a))):(0,_util.logWarn)(r,[{reason:"ERROR: The custom element '".concat(t,"' can not be found."),line:e.node.__location.line,column:e.node.__location.col}])):(0,_util.logWarn)(r,[{reason:"ERROR: The attribute 'src' must be set in the custom element.",line:e.node.__location.line,column:e.node.__location.col}])}),u+="\n//card_end"}function findStyleFile(e){var t=!1,s=e+".css",a="css";return _fs.default.existsSync(s)?(t=!0,a="css"):_fs.default.existsSync(s=e+".less")?(t=!0,a="less"):_fs.default.existsSync(s=e+".sass")||_fs.default.existsSync(s=e+".scss")?(t=!0,a="sass"):t=!1,{extStyle:t,styleFileName:s,type:a}}function addJson(e,t,s,a,n){n="".concat(n?"var card_element_json_"+n:"var card_json"," =");return _fs.default.existsSync(s+".json")&&!_fs.default.existsSync(s+".js")?t+=n+(0,_util.getRequireString)(e,(0,_util.jsonLoaders)("json"),s+".json"+a):_fs.default.existsSync(s+".js")&&!_fs.default.existsSync(s+".json")?((0,_util.logWarn)(e,[{reason:"WARNING: The JS file '".concat(s,".js' will be discarded in future version, ")+"use the JSON file '".concat(s,".json' instead.")}]),t+=n+(0,_util.getRequireString)(e,(0,_util.jsonLoaders)("json"),s+".js"+a)):_fs.default.existsSync(s+".json")&&_fs.default.existsSync(s+".js")&&((0,_util.logWarn)(e,[{reason:"WARNING: '".concat(s,"' cannot have the same name files '.json' and '.js', otherwise '.json' in default.")}]),t+=n+(0,_util.getRequireString)(e,(0,_util.jsonLoaders)("json"),s+".json"+a)),t}module.exports=loader;