"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_toConsumableArray2=(Object.defineProperty(exports,"__esModule",{value:!0}),exports.isEs2Abc=isEs2Abc,exports.isLinux=isLinux,exports.isMacOs=isMacOs,exports.isTs2Abc=isTs2Abc,exports.isWindows=isWindows,exports.maxFilePathLength=maxFilePathLength,exports.validateFilePathLength=validateFilePathLength,_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray"))),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass"));function _createForOfIteratorHelper(e,t){var n,r,s,i,a="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(a)return r=!(n=!0),{s:function(){a=a.call(e)},n:function(){var e=a.next();return n=e.done,e},e:function(e){r=!0,s=e},f:function(){try{n||null==a.return||a.return()}finally{if(r)throw s}}};if(Array.isArray(e)||(a=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length)return a&&(e=a),i=0,{s:t=function(){},n:function(){return i>=e.length?{done:!0}:{done:!1,value:e[i++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){var n;if(e)return"string"==typeof e?_arrayLikeToArray(e,t):"Map"===(n="Object"===(n=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,t):void 0}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var n=0,r=new Array(t);n<t;n++)r[n]=e[n];return r}var output,arkDir,nodeJs,fs=require("fs"),path=require("path"),cluster=require("cluster"),process=require("process"),crypto=require("crypto"),events=require("events"),os=require("os"),childProcess=require("child_process"),forward='(global.___mainEntry___ = function (globalObjects) {\n  var define = globalObjects.define;\n  var require = globalObjects.require;\n  var bootstrap = globalObjects.bootstrap;\n  var register = globalObjects.register;\n  var render = globalObjects.render;\n  var $app_define$ = globalObjects.$app_define$;\n  var $app_bootstrap$ = globalObjects.$app_bootstrap$;\n  var $app_require$ = globalObjects.$app_require$;\n  var history = globalObjects.history;\n  var Image = globalObjects.Image;\n  var OffscreenCanvas = globalObjects.OffscreenCanvas;\n  (function(global) {\n    "use strict";\n',last="\n})(this.__appProto__);\n})",genAbcScript="gen-abc.js",isWin=!1,isMac=!1,isDebug=!1,intermediateJsBundle=[],workerFile=null,fileterIntermediateJsBundle=[],hashJsonObject={},buildPathInfo="",SUCCESS=0,FAIL=1,red="[31m",reset="[39m",blue="[34m",hashFile="gen_hash.json",ARK="/ark/",NODE_MODULES="node_modules",TEMPORARY="temporary",TS2ABC="ts2abc",ES2ABC="es2abc",WINDOWS="Windows_NT",LINUX="Linux",MAC="Darwin",FILESINFO_TXT="filesInfo.txt",manageBunldeWorkersScript="manage-bundle-workers.js",PREBUILDINFO_JSON="preBuildInfo.json",GenAbcPlugin=function(){function i(e,t,n,r,s){(0,_classCallCheck2.default)(this,i),output=e,arkDir=t,nodeJs=n,isDebug=s,workerFile=r}return(0,_createClass2.default)(i,[{key:"apply",value:function(e){if(fs.existsSync(path.resolve(arkDir,"build-win")))isWin=!0;else if(fs.existsSync(path.resolve(arkDir,"build-mac")))isMac=!0;else if(!fs.existsSync(path.resolve(arkDir,"build")))return console.error(red,"ERROR find build fail",reset),void(process.exitCode=FAIL);checkNodeModules()?(events.EventEmitter.defaultMaxListeners=100,e.hooks.emit.tap("GenAbcPlugin",function(e){var r=e.assets,e=Object.keys(r);buildPathInfo=output,e.forEach(function(e){var t,n;output&&".js"===path.extname(e)?(t=r[e].source(),checkWorksFile(e,workerFile)&&"commons.js"!==e&&"vendors.js"!==e&&(t=forward+t+last),"commons.js"!==e&&"vendors.js"!==e&&checkWorksFile(e,workerFile)||(t="\n\n\n\n\n\n\n\n\n\n\n\n\n\n"+t),n=e.replace(/\.js$/,".temp.js"),writeFileSync(t,output,n,e,!0)):output&&".json"===path.extname(e)&&"card"===process.env.DEVICE_LEVEL&&process.env.configOutput&&!checkI18n(e)&&writeFileSync(r[e].source(),output,e,e,!1)})}),e.hooks.afterEmit.tap("GenAbcPluginMultiThread",function(){0!==intermediateJsBundle.length&&(buildPathInfo=output,clearWebpackCacheByBuildInfo(),setPrebuildInfo(),processMultiThreadEntry())})):process.exitCode=FAIL}}]),i}();function processMultiThreadEntry(){isTs2Abc()||"8"===process.env.minPlatformVersion?invokeWorkerToGenAbc():isEs2Abc()?generateAbcByEs2AbcOfBundleMode(intermediateJsBundle):console.debug(red,"ERROR please set panda module",reset)}function checkI18n(e){return-1<path.resolve(process.env.configOutput,e).replace(output,process.env.projectPath).indexOf(path.resolve(__dirname,process.env.projectPath,"i18n"))}function checkWorksFile(e,t){if(null===t)return 0!==e.search("./workers/");for(var n in t)if(n+".js"===e)return!1;return!0}function writeFileSync(e,t,n,r,s){var i,t=path.resolve(t,n),a=(validateFilePathLength(t),path.join(t,".."));fs.existsSync(a)&&fs.statSync(a).isDirectory()||mkDir(a),s?(s="",validateFilePathLength(s=process.env.cachePath?(i=(i=buildPathInfo.split(path.sep))[i.length-1],path.join(process.env.cachePath,TEMPORARY,i,n)):t),a=path.join(s,".."),fs.existsSync(a)&&fs.statSync(a).isDirectory()||mkDir(a),fs.writeFileSync(s,e),fs.existsSync(s)?(i=fs.statSync(s).size,n=t.replace(/\.temp\.js$/,"_.js"),n=!isDebug&&process.env.aceBuildJson&&fs.existsSync(process.env.aceBuildJson)?(a=JSON.parse(fs.readFileSync(process.env.aceBuildJson).toString()),toUnixPath(n.replace(a.projectRootPath+path.sep,""))):toUnixPath(n),t=toUnixPath(t),s=toUnixPath(s),intermediateJsBundle.push({path:t,size:i,cacheOutputPath:s,sourceFile:n})):(console.debug(red,"ERROR Failed to convert file ".concat(r," to bin. ").concat(t," is lost"),reset),process.exitCode=FAIL)):fs.writeFileSync(t,e)}function mkDir(e){var t=path.join(e,"..");fs.existsSync(t)&&!fs.statSync(t).isFile()||mkDir(t),fs.mkdirSync(e)}function getSmallestSizeGroup(e){e=Array.from(e);return e.sort(function(e,t){return e[1]-t[1]}),e[0][0]}function splitJsBundlesBySize(e,t){var n=[];if(e.length<t){var r,s=_createForOfIteratorHelper(e);try{for(s.s();!(r=s.n()).done;){var i=r.value;n.push([i])}}catch(e){s.e(e)}finally{s.f()}}else{e.sort(function(e,t){return t.size-e.size});for(var a=new Map,o=0;o<t;++o)n.push([]),a.set(o,0);for(var c=0;c<e.length;){var l=getSmallestSizeGroup(a),u=(n[l].push(e[c]),a.get(l)+e[c].size);a.set(l,u),c++}}return n}function invokeWorkerToGenAbc(){"true"===process.env.isPreview&&(process.exitCode=SUCCESS);var e=isEs2Abc()?os.cpus().length:3,t=initCmdPrefix(initAbcEnv()),n=(filterIntermediateJsBundleByHashJson(buildPathInfo,intermediateJsBundle),splitJsBundlesBySize(fileterIntermediateJsBundle,e)),e=e<n.length?e:n.length;try{("true"===process.env.isPreview?processWorkersOfPreviewMode:processWorkersOfBuildMode)(n,t,e)}catch(e){console.debug(red,"ERROR failed to generate abc. Error message: ".concat(e," "),reset),process.env.abcCompileSuccess="false","true"!==process.env.isPreview&&process.exit(FAIL)}}function clearGlobalInfo(){"true"!==process.env.isPreview&&(intermediateJsBundle=[]),fileterIntermediateJsBundle=[],hashJsonObject={}}function filterIntermediateJsBundleByHashJson(e,t){t=removeDuplicateInfoOfBundleList(t);for(var n=0;n<t.length;++n)fileterIntermediateJsBundle.push(t[n]);e=genHashJsonPath(e);if(0!=e.length){var r,s={};if(fs.existsSync(e)){e=fs.readFileSync(e).toString(),r=JSON.parse(e),fileterIntermediateJsBundle=[];for(var i=0;i<t.length;++i){var a,o,c=t[i].cacheOutputPath,l=c.replace(/\.temp\.js$/,".abc");if(!fs.existsSync(c)){console.debug(red,"ERROR ".concat(c," is lost"),reset),process.exitCode=FAIL;break}fs.existsSync(l)&&(a=toHashData(c),o=toHashData(l),r[c]===a)&&r[l]===o?(s[c]=a,s[l]=o):fileterIntermediateJsBundle.push(t[i])}}hashJsonObject=s}}function writeHashJson(){for(var e=0;e<fileterIntermediateJsBundle.length;++e){var t=fileterIntermediateJsBundle[e].cacheOutputPath,n=t.replace(/\.temp\.js$/,".abc");if(!fs.existsSync(t)||!fs.existsSync(n)){console.debug(red,"ERROR ".concat(t," is lost"),reset),process.exitCode=FAIL;break}var r=toHashData(t),s=toHashData(n);hashJsonObject[t]=r,hashJsonObject[n]=s}var i=genHashJsonPath(buildPathInfo);0!=i.length&&fs.writeFileSync(i,JSON.stringify(hashJsonObject))}function genHashJsonPath(e){var t,n;return e=toUnixPath(e),process.env.cachePath?fs.existsSync(process.env.cachePath)&&fs.statSync(process.env.cachePath).isDirectory()?(n=(n=buildPathInfo.split(path.sep))[n.length-1],validateFilePathLength(n=path.join(process.env.cachePath,TEMPORARY,n,hashFile)),t=path.join(n,".."),fs.existsSync(t)&&fs.statSync(t).isDirectory()||mkDir(t),n):"":0<=e.indexOf(ARK)&&(t=e.split(ARK),n=path.join(t[0],ARK),fs.existsSync(n))&&fs.statSync(n).isDirectory()?(validateFilePathLength(e=path.join(n,hashFile)),e):""}function toUnixPath(e){var t,n;return/^win/.test(require("os").platform())?(n=e.split(path.sep),(t=path.posix).join.apply(t,(0,_toConsumableArray2.default)(n))):e}function toHashData(e){var e=fs.readFileSync(e),t=crypto.createHash("sha256");return t.update(e),t.digest("hex")}function copyFileCachePathToBuildPath(){for(var e=0;e<intermediateJsBundle.length;++e){var t=intermediateJsBundle[e].path.replace(/\.temp\.js$/,".abc"),n=intermediateJsBundle[e].cacheOutputPath,r=intermediateJsBundle[e].cacheOutputPath.replace(/\.temp\.js$/,".abc");if(!fs.existsSync(r)){console.debug(red,"ERROR ".concat(r," is lost"),reset),process.exitCode=FAIL;break}var s=path.join(t,"..");fs.existsSync(s)&&fs.statSync(s).isDirectory()||mkDir(s),void 0!==process.env.cachePath&&fs.copyFileSync(r,t),void 0===process.env.cachePath&&fs.existsSync(n)&&fs.unlinkSync(n)}}function processExtraAssetForBundle(){writeHashJson(),copyFileCachePathToBuildPath(),clearGlobalInfo()}function checkNodeModules(){if(process.env.panda===TS2ABC){var e=path.join(arkDir,"build"),t=(isWin?e=path.join(arkDir,"build-win"):isMac&&(e=path.join(arkDir,"build-mac")),path.join(e,NODE_MODULES));if(validateFilePathLength(t),!fs.existsSync(t)||!fs.statSync(t).isDirectory())return console.error(red,'ERROR: node_modules for ark compiler not found.\n        Please make sure switch to non-root user before runing "npm install" for safity requirements and try re-run "npm install" under '.concat(e),reset),!1}return!0}function initAbcEnv(){var e,t=[];return"8"===process.env.minPlatformVersion?(process.env.panda=TS2ABC,e=path.join(arkDir,"build","legacy_api8","src","index.js"),isWin?e=path.join(arkDir,"build-win","legacy_api8","src","index.js"):isMac&&(e=path.join(arkDir,"build-mac","legacy_api8","src","index.js")),validateFilePathLength(e),t=["--expose-gc",e='"'+e+'"'],isDebug&&t.push("--debug")):process.env.panda===TS2ABC?(e=path.join(arkDir,"build","src","index.js"),isWin?e=path.join(arkDir,"build-win","src","index.js"):isMac&&(e=path.join(arkDir,"build-mac","src","index.js")),validateFilePathLength(e),t=["--expose-gc",e='"'+e+'"'],isDebug&&t.push("--debug")):process.env.panda===ES2ABC||"undefined"===process.env.panda||void 0===process.env.panda?(e=path.join(arkDir,"build","bin","es2abc"),isWin?e=path.join(arkDir,"build-win","bin","es2abc.exe"):isMac&&(e=path.join(arkDir,"build-mac","bin","es2abc")),validateFilePathLength(e),t=['"'+e+'"'],isDebug&&t.push("--debug-info")):console.debug(red,"ERROR: please set panda module",reset),t}function isWindows(){return os.type()===WINDOWS}function isLinux(){return os.type()===LINUX}function isMacOs(){return os.type()===MAC}function maxFilePathLength(){return isWindows()?32766:isLinux()?4095:isMacOs()?1016:-1}function validateFilePathLength(e){return maxFilePathLength()<0?(console.error("Unknown OS platform"),process.exitCode=FAIL,!1):0<e.length&&e.length<=maxFilePathLength()||(e.length>maxFilePathLength()?console.error("The length of ".concat(e," exceeds the limitation of current platform, which is ")+"".concat(maxFilePathLength(),". Please try moving the project folder to avoid deeply nested file path and try again")):console.error("Validate file path failed"),process.exitCode=FAIL,!1)}function isEs2Abc(){return process.env.panda===ES2ABC||"undefined"===process.env.panda||void 0===process.env.panda}function isTs2Abc(){return process.env.panda===TS2ABC}function generateAbcByEs2AbcOfBundleMode(e){if(filterIntermediateJsBundleByHashJson(buildPathInfo,e),0===fileterIntermediateJsBundle.length)processExtraAssetForBundle();else{var t,n=generateFileOfBundle(fileterIntermediateJsBundle),e=os.cpus().length<16?os.cpus().length:16,e="".concat(initAbcEnv().join(" "),' "@').concat(n,'" --file-threads "').concat(e,'"');console.debug("gen abc cmd is: ",e);try{"true"===process.env.isPreview?(childProcess.execSync(e),processExtraAssetForBundle()):((t=childProcess.exec(e)).on("exit",function(e){e===FAIL&&(console.debug(red,"ERROR failed to execute es2abc",reset),process.exit(FAIL)),void 0===process.env.cachePath&&unlinkSync(n),processExtraAssetForBundle()}),t.on("error",function(e){console.debug(red,e.toString(),reset),process.exit(FAIL)}),t.stderr.on("data",function(e){console.debug(red,e.toString(),reset)}))}catch(e){console.debug(red,"ERROR failed to generate abc with filesInfo ".concat(n,". Error message: ").concat(e," "),reset),process.env.abcCompileSuccess="false","true"!==process.env.isPreview&&process.exit(FAIL)}finally{"true"===process.env.isPreview&&void 0===process.env.cachePath&&unlinkSync(n)}}}function generateFileOfBundle(e){var t=buildCachePath(FILESINFO_TXT),r=(e=removeDuplicateInfoOfBundleList(e),"");return e.forEach(function(e){var t=e.cacheOutputPath,e=e.sourceFile,n=t.replace(/\.temp\.js$/,".abc");r+="".concat(t,";").concat("null_recordName",";").concat("script",";").concat(e,";").concat(n,"\n")}),fs.writeFileSync(t,r,"utf-8"),t}function removeDuplicateInfoOfBundleList(e){var n=[];return e.forEach(function(t){n.every(function(e){return t.path!==e.path})&&n.push(t)}),e=n}function buildCachePath(e){e=void 0!==process.env.cachePath?path.join(process.env.cachePath,e):path.join(buildPathInfo,e);return validateFilePathLength(e),e}function unlinkSync(e){fs.existsSync(e)&&fs.unlinkSync(e)}function initCmdPrefix(e){var t="";return process.env.panda===TS2ABC?t="".concat(nodeJs," ").concat(e.join(" ")):process.env.panda===ES2ABC||"undefined"===process.env.panda||void 0===process.env.panda?t="".concat(e.join(" ")):console.debug(red,"ERROR please set panda module",reset),t}function processWorkersOfPreviewMode(e,t,n){var r=Object.assign({},process.env),e={splittedData:JSON.stringify(e),cmdPrefix:t,workerNumber:n.toString()},t=(r.arkEnvParams=JSON.stringify(e),"".concat(nodeJs,' "').concat(path.resolve(__dirname,manageBunldeWorkersScript),'"'));childProcess.execSync(t,{env:r}),processExtraAssetForBundle()}function processWorkersOfBuildMode(e,t,n){var r=16<=parseInt(process.version.split(".")[0]);if(r&&cluster.isPrimary||!r&&cluster.isMaster){r?cluster.setupPrimary({exec:path.resolve(__dirname,genAbcScript)}):cluster.setupMaster({exec:path.resolve(__dirname,genAbcScript)});for(var s=0;s<n;++s){var i={inputs:JSON.stringify(e[s]),cmd:t};cluster.fork(i)}cluster.on("exit",function(e,t,n){t===FAIL&&(process.exitCode=FAIL),console.debug("worker ".concat(e.process.pid," finished"))}),process.on("exit",function(e){process.exitCode!==FAIL&&"true"!==process.env.isPreview&&processExtraAssetForBundle()})}}function clearWebpackCacheByBuildInfo(){if(process.env.cachePath){var e=path.join(process.env.cachePath,PREBUILDINFO_JSON);if(fs.existsSync(e)){var t=void 0;try{t=JSON.parse(fs.readFileSync(e).toString())}catch(e){return void removeHashJsonFile()}t&&t.minAPIVersion&&t.minAPIVersion.toString()!==process.env.minPlatformVersion&&removeHashJsonFile()}}}function setPrebuildInfo(){var e,t;process.env.cachePath&&process.env.minPlatformVersion&&(e={},validateFilePathLength(t=path.join(process.env.cachePath,PREBUILDINFO_JSON)),e.minAPIVersion=process.env.minPlatformVersion,fs.writeFile(t,JSON.stringify(e,null,2),"utf-8",function(e){e&&logger.error(red,"ArkTS:ERROR Failed to write bundle build info.",reset)}))}function removeHashJsonFile(){var e=genHashJsonPath(buildPathInfo);0!==e.length&&fs.existsSync(e)&&fs.unlinkSync(e)}module.exports={GenAbcPlugin:GenAbcPlugin,checkWorksFile:checkWorksFile};