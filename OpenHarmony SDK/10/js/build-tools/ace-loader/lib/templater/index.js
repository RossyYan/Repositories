const componentValidator=require("./component_validator"),parse5=require("../parse/index"),path=require("path");let compileResult;const EVENT_START_REGEXP=/^(on:|on|@|grab:)/,REGEXP_TEXT=/^#/,REGEXP_DATA=/^data-/;function parse(e,t,l){var a=replaceAll(path.sep,"/",path.relative(process.env.aceModuleRoot||process.cwd(),l)).replace(path.parse(l).ext,""),e=(compileResult={jsonTemplate:{},deps:[],log:[]},hmlParse(e,{sourceCodeLocationInfo:!0,componentValidator:componentValidator,compileResult:compileResult}));if(!checkNullNode(e,t)&&!checkRootNode(e,t,a)){e=e.childNodes.filter(function(e){return-1===e.nodeName.indexOf("#")});let o=0;e.forEach((e,t)=>{"element"!==e.tagName&&(o=t)}),generate(e[o],l,void 0,a),t(null,compileResult)}}function hmlParse(e,t){return parse5.parseFragment(e,t)}function checkNullNode(e,t){let o=!1;return 0===e.childNodes.length&&(compileResult.log.push({reason:"ERROR: parsing hml file failed"}),t(null,compileResult),o=!0),o}function checkRootNode(e,t,l){let o=!1;e=e.childNodes.filter(function(e){return-1===e.nodeName.indexOf("#")});let a=0;return e.forEach(t=>{if("element"!==t.nodeName)a++;else if(t.attrs&&t.attrs.length)for(let e=0;e<t.attrs.length;e++){var o=t.attrs[e];if("name"===o.name){componentValidator.elementNames[l]=componentValidator.elementNames[l]||[],componentValidator.elementNames[l].push(o.value.toLowerCase());break}}}),1!==a&&(a||compileResult.log.push({reason:"ERROR: need a legal root node",line:1,column:1}),1<a&&compileResult.log.push({reason:"ERROR: there can only be one root node",line:1,column:1}),t(null,compileResult),o=!0),o}function generate(e,t,o,l){componentValidator.validateTagName(e,compileResult,l),e.attrs&&0!==e.attrs.length&&checkNodeAttrs(e,t,o,l),e.childNodes&&0!==e.childNodes.length&&checkNodeChildren(e,t,l)}function checkNodeAttrs(a,n,r,c){const i=a.attrs,s={line:a.sourceCodeLocation.startLine,col:a.sourceCodeLocation.endLine};i.forEach((e,t)=>{var o=e.name,l=e.value;switch(o){case"style":componentValidator.validateStyle(l,compileResult,s,c);break;case"class":componentValidator.validateClass(l,compileResult,s,c);break;case"id":componentValidator.validateId(l,compileResult,s,c);break;case"for":checkAttrFor(a,i,s),componentValidator.validateFor(l,compileResult,s,c);break;case"if":componentValidator.validateIf(l,compileResult,!1,s,c);break;case"elif":componentValidator.validateAttrElif(r,l,i,t,compileResult,s,c);break;case"else":componentValidator.validateAttrElse(r,compileResult,s,c);break;case"append":componentValidator.validateAppend(l,compileResult,s,c);break;default:EVENT_START_REGEXP.test(o)?componentValidator.validateEvent(o,l,compileResult,s,c):REGEXP_DATA.test(o)?componentValidator.parseDataAttr(o,l,compileResult,s,c):componentValidator.validateAttr(n,o,l,compileResult,a.tagName,s,c)}})}function checkAttrFor(e,a,n){if("card"===process.env.DEVICE_LEVEL){let t=!1,o=!1,l=(a.forEach(e=>{"tid"===e.name&&(t=!0),"if"!==e.name&&"elif"!==e.name&&"else"!==e.name||(o=!0)}),t||compileResult.log.push({line:n.line||1,column:n.col||1,reason:"WARNING: The 'tid' is recommended here."}),o&&compileResult.log.push({line:n.line||1,column:n.col||1,reason:"ERROR: The 'for' and 'if' cannot be used in the same node."}),!1);e&&e.parentNode&&e.parentNode.attrs&&e.parentNode.attrs.forEach(e=>{"for"===e.name&&(l=!0)}),l&&compileResult.log.push({line:n.line||1,column:n.col||1,reason:"ERROR: The nested 'for' is not supported."})}}function replaceAll(e,t,o){return e=e.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),o.replace(new RegExp(e,"g"),t)}function checkNodeChildren(o,l,a){var n=o.childNodes.filter(e=>"#text"===e.nodeName&&e.value.trim()||!REGEXP_TEXT.test(e.nodeName)),r=compileResult.jsonTemplate;for(let t=0;t<n.length;t++){var c,i=n[t];let e;0<t&&(e=n[t-1]),REGEXP_TEXT.test(i.nodeName)?(c={line:i.sourceCodeLocation.startLine,col:i.sourceCodeLocation.endLine},"option"===o.nodeName?componentValidator.validateAttr(l,"content",i.value,compileResult,i.tagName,c,a):componentValidator.validateAttr(l,"value",i.value,compileResult,i.tagName,c,a)):(compileResult.jsonTemplate={},r.children=r.children||[],r.children.push(compileResult.jsonTemplate),generate(i,l,e,a))}compileResult.jsonTemplate=r}module.exports={parse:parse};