"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_typeof=require("@babel/runtime/helpers/typeof"),_loaderUtils=_interopRequireDefault(require("loader-utils")),_path=_interopRequireDefault(require("path")),_fs=_interopRequireDefault(require("fs")),legacy=_interopRequireWildcard(require("./legacy")),_parser=require("./parser"),_util=require("./util"),_component_validator=require("./templater/component_validator");function _getRequireWildcardCache(e){var t,r;return"function"!=typeof WeakMap?null:(t=new WeakMap,r=new WeakMap,(_getRequireWildcardCache=function(e){return e?r:t})(e))}function _interopRequireWildcard(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==_typeof(e)&&"function"!=typeof e)return{default:e};t=_getRequireWildcardCache(t);if(t&&t.has(e))return t.get(e);var r,a,n={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(r in e)"default"!==r&&Object.prototype.hasOwnProperty.call(e,r)&&((a=o?Object.getOwnPropertyDescriptor(e,r):null)&&(a.get||a.set)?Object.defineProperty(n,r,a):n[r]=e[r]);return n.default=e,t&&t.set(e,n),n}function _createForOfIteratorHelper(e,t){var r,a,n,o,s="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(s)return a=!(r=!0),{s:function(){s=s.call(e)},n:function(){var e=s.next();return r=e.done,e},e:function(e){a=!0,n=e},f:function(){try{r||null==s.return||s.return()}finally{if(a)throw n}}};if(Array.isArray(e)||(s=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length)return s&&(e=s),o=0,{s:t=function(){},n:function(){return o>=e.length?{done:!0}:{done:!1,value:e[o++]}},e:function(e){throw e},f:t};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,t){var r;if(e)return"string"==typeof e?_arrayLikeToArray(e,t):"Map"===(r="Object"===(r=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:r)||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?_arrayLikeToArray(e,t):void 0}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,a=new Array(t);r<t;r++)a[r]=e[r];return a}var key,_require=require("./lite/lite-enum"),DEVICE_LEVEL=_require.DEVICE_LEVEL,loaderPath=__dirname,defaultLoaders={none:"",main:_path.default.resolve(loaderPath,"loader.js"),template:_path.default.resolve(loaderPath,"template.js"),style:_path.default.resolve(loaderPath,"style.js"),script:_path.default.resolve(loaderPath,"script.js"),json:_path.default.resolve(loaderPath,"json.js"),babel:(0,_util.loadBabelModule)("babel-loader"),manifest:_path.default.resolve(loaderPath,"manifest-loader.js"),resourceReferenceScript:_path.default.resolve(loaderPath,"resource-reference-script.js")};function getLoaderString(e,t){var r,a=loadCustomLoader(t=t||{});switch(e){case"main":return mainLoaderString(r);case"element":return elementLoaderString(r,t);case"template":return templateLoaderString(r,t,a);case"style":return styleLoaderString(r,t,a);case"script":return scriptLoaderString(r,t,a);case"config":return configLoaderString(r,t);case"data":return dataLoaderString(r,t)}}function loadCustomLoader(e){if(e.lang&&e.customLang[e.lang])return(0,_util.loadBabelModule)(e.customLang[e.lang][0])}function mainLoaderString(e){return e=[{name:defaultLoaders.main}],(0,_util.stringifyLoaders)(e)}function elementLoaderString(e,t){return e=[{name:defaultLoaders.main,query:{element:!t.source||void 0}}],(0,_util.stringifyLoaders)(e)}function templateLoaderString(e,t,r){return e=[{name:defaultLoaders.json},{name:defaultLoaders.template}],r&&(e=e.concat(r)),(0,_util.stringifyLoaders)(e)}function styleLoaderString(e,t,r){return e=[{name:defaultLoaders.json},{name:defaultLoaders.style}],r&&(e=e.concat(r)),(0,_util.stringifyLoaders)(e)}function scriptLoaderString(e,t,r){return e=[{name:defaultLoaders.script}],r?e=e.concat(r):(r={extends:_path.default.resolve(__dirname,"../babel.config.js")},process.env.DEVICE_LEVEL===DEVICE_LEVEL.RICH&&(r.targets="node 8"),e.push({name:defaultLoaders.babel,query:r}),e.push({name:defaultLoaders.resourceReferenceScript})),t.app&&"page"===process.env.abilityType&&_fs.default.existsSync(process.env.aceManifestPath)&&e.push({name:defaultLoaders.manifest,query:{path:t.source}}),(0,_util.stringifyLoaders)(e)}function configLoaderString(e,t){return e=[{name:defaultLoaders.json}],(0,_util.stringifyLoaders)(e)}function dataLoaderString(e,t){return e=[{name:defaultLoaders.json}],(0,_util.stringifyLoaders)(e)}function loader(e){this.cacheable&&this.cacheable();var t,r={sass:["sass-loader"],scss:["sass-loader"],less:["less-loader"]},a=this.resourceQuery&&_loaderUtils.default.parseQuery(this.resourceQuery)||{},n=a.entry,o=_path.default.parse(this.resourcePath),o=n?o.name:a.name||(0,_util.getNameByPath)(this.resourcePath),a=a.parentPath||this.resourcePath;return n?(_util.elements[this.resourcePath]=_util.elements[this.resourcePath]||{},_util.elements[this.resourcePath][o]=!0):(_util.elements[this.resourcePath]=_util.elements[this.resourcePath]||{},_util.elements[this.resourcePath].parent=a,_util.elements[a]&&_util.elements[a].parent&&(_util.elements[this.resourcePath].parent=_util.elements[_util.elements[a].parent],a=_util.elements[this.resourcePath].parent)),(0,_component_validator.isReservedTag)(o)&&"page"===process.env.abilityType?((0,_util.logWarn)(this,[{reason:"ERROR: The file name cannot contain reserved tag name: "+o}]),""):(t="",(t+=loadApp(this,o,n,r,e))+loadPage(this,o,n,r,e,a))}function checkApp(e){return"testrunner"===process.env.abilityType||e.resourcePath===_path.default.resolve(process.env.projectPath,"page"===process.env.abilityType?"app.js":"".concat(process.env.abilityType,".js"))}function loadApp(e,t,r,a,n){var o,s="",i=!1;return checkApp(e)?(o=e.resourcePath.replace(_path.default.extname(e.resourcePath).toString(),"")+".css",_fs.default.existsSync(o)?(i=!0,s+="var $app_style$ = "+(0,_util.getRequireString)(e,getLoaderString("style",{customLang:a,lang:void 0,element:void 0,elementName:void 0,source:o}),o)):i=!1,s+="var $app_script$ = "+(0,_util.getRequireString)(e,getLoaderString("script",{customLang:a,lang:void 0,element:void 0,elementName:void 0,source:e.resourcePath,app:!0}),e.resourcePath),process.env.DEVICE_LEVEL!==DEVICE_LEVEL.RICH&&"card"!==process.env.DEVICE_LEVEL||(s+="\n      $app_define$('@app-application/".concat(t,"', [], function($app_require$, $app_exports$, $app_module$) {\n      ")+"\n      $app_script$($app_module$, $app_exports$, $app_require$)\n      if ($app_exports$.__esModule && $app_exports$.default) {\n        $app_module$.exports = $app_exports$.default\n      }\n      "+(i?"\n      $app_module$.exports.style = $app_style$\n      ":"")+"\n      })\n      ",r&&(s+="$app_bootstrap$('@app-application/".concat(t,"'")+",undefined,undefined)")),process.env.DEVICE_LEVEL===DEVICE_LEVEL.LITE&&(s+="var options=$app_script$\n if ($app_script$.__esModule) {\n\n        options = $app_script$.default;\n }\n"+(i?"options.styleSheet=$app_style$\n":"")+"module.exports=new ViewModel(options);"),s):/\.js$/.test(e.resourcePath)?n:s}function loadPage(e,t,r,a,n,o){var s,i,l,u="";return _path.default.extname(e.resourcePath).match(/\.hml/)?(s=e.resourcePath.replace(_path.default.extname(e.resourcePath).toString(),""),i=e.resourcePath,l=(_loaderUtils.default.getOptions(e)||{}).element,u=(u+=loadPageCheckElementLength(e,(n=(0,_parser.parseFragment)(n)).element.length,n,[],i,a,o))+("var $app_template$ = "+(0,_util.getRequireString)(e,getLoaderString("template",{customLang:a,lang:void 0,element:l,elementName:l?t:void 0,source:e.resourcePath}),e.resourcePath)),i=(n=loadPageFindCss(e,s,a)).extcss,u+=n.output,l=(o=loadPageFindJs(e,s,a)).extscript,(u+=o.output)+(process.env.DEVICE_LEVEL===DEVICE_LEVEL.RICH?loadPageCheckRich(t,l,i,r):loadPageCheckLite(l,i))):u}function loadPageCheckElementLength(e,t,r,a,n,o,s){var i="";if(t)for(var l=0;l<t;l++){var u=r.element[l],p=n;if(!u.src)return(0,_util.logWarn)(e,[{reason:"ERROR: src attributes must be set for custom elements."}]),"";(p=u.src).match(/\.hml$/)||(p=p.concat(".hml"));var c=_path.default.join(_path.default.dirname(n),p);if(!_fs.default.existsSync(c)&&p.match(/^(\/|\.)/))return(0,_util.logWarn)(e,[{reason:"ERROR: The file path of custom element does not exist, src: "+p}]),"";u.name||(u.name=_path.default.parse(p).name),u.name=u.name.toLowerCase(),_util.elements[s]=_util.elements[s]||{},_util.elements[s][u.name]?(0,_util.logWarn)(e,[{reason:"ERROR: The element name can not be same with the page "+'"'.concat(u.name,'" (ignore case).')}]):_util.elements[s][u.name]=!0,checkEntry(e,c,u.src),a.push(u.name),i+=(0,_util.getRequireString)(e,getLoaderString("element",{customLang:o,name:u.name,source:p}),"".concat(p,"?name=").concat(u.name,"&parentPath=").concat(s))}return i}function loadPageFindCss(e,t,r){var a="",n=!1,o=t+".css";return _fs.default.existsSync(o)?(n=!0,a="var $app_style$ = "+(0,_util.getRequireString)(e,getLoaderString("style",{customLang:r,lang:void 0,element:void 0,elementName:void 0,source:o}),o)):_fs.default.existsSync(o=t+".less")?(n=!0,a="var $app_style$ = "+(0,_util.getRequireString)(e,getLoaderString("style",{customLang:r,lang:"less",element:void 0,elementName:void 0,source:o}),o)):_fs.default.existsSync(o=t+".scss")?(n=!0,a="var $app_style$ = "+(0,_util.getRequireString)(e,getLoaderString("style",{customLang:r,lang:"scss",element:void 0,elementName:void 0,source:o}),o)):_fs.default.existsSync(o=t+".sass")?(n=!0,a="var $app_style$ = "+(0,_util.getRequireString)(e,getLoaderString("style",{customLang:r,lang:"sass",element:void 0,elementName:void 0,source:o}),o)):n=!1,{extcss:n,output:a}}function loadPageFindJs(e,t,r){var a="",n=!1,t=t+".js";return _fs.default.existsSync(t)?(n=!0,a="var $app_script$ = "+(0,_util.getRequireString)(e,getLoaderString("script",{customLang:r,lang:void 0,element:void 0,elementName:void 0,source:t}),t)):(n=!1,console.log("missing "+t)),{extscript:n,output:a}}function loadPageCheckRich(e,t,r,a){var n="";return n+="\n$app_define$('@app-component/".concat(e,"', [], function($app_require$, $app_exports$, $app_module$) {\n")+(t?"\n$app_script$($app_module$, $app_exports$, $app_require$)\nif ($app_exports$.__esModule && $app_exports$.default) {\n$app_module$.exports = $app_exports$.default\n}\n":"")+"\n$app_module$.exports.template = $app_template$\n"+(r?"\n$app_module$.exports.style = $app_style$\n":"")+"\n})\n",a&&(n+="$app_bootstrap$('@app-component/".concat(e,"'")+",undefined,undefined)"),n}function loadPageCheckLite(e,t){return(e?"var options=$app_script$\n if ($app_script$.__esModule) {\n\n      options = $app_script$.default;\n }\n":"var options={}\n")+(t?"options.styleSheet=$app_style$\n":"")+"options.render=$app_template$;\nmodule.exports=new ViewModel(options);"}for(key in legacy)loader[key]=legacy[key];function checkEntry(e,t,r){if(e._compilation.entries){var a,n=_createForOfIteratorHelper(e._compilation.entries.keys());try{for(n.s();!(a=n.n()).done;){var o=a.value;_path.default.join(_path.default.resolve(process.env.projectPath),o+".hml")===t&&(0,_util.logWarn)(e,[{reason:'WARNING: The page "'.concat(r,"\" configured in 'config.json'")+" can not be uesd as a custom component.To ensure that the debugging function is normal, please delete this page in 'config.json'."}])}}catch(e){n.e(e)}finally{n.f()}}}module.exports=loader;