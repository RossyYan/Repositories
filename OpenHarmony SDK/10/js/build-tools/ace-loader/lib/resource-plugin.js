"use strict";var watchCSSFiles,resourcesPath,sharePath,workerFile,_interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_util=require("./util"),_main=require("../main.product"),fs=require("fs"),path=require("path"),SingleEntryPlugin=require("webpack/lib/SingleEntryPlugin"),CUSTOM_THEME_PROP_GROUPS=require("./theme/customThemeStyles"),OHOS_THEME_PROP_GROUPS=require("./theme/ohosStyles"),FILE_EXT_NAME=[".js",".css",".jsx",".less",".sass",".scss",".md",".DS_Store",".hml",".json"],red="[31m",reset="[39m",input="",output="",manifestFilePath="",shareThemePath="",internalThemePath="";function copyFile(t,e){try{if(fs.existsSync(t)){var r,n,s,i=path.join(e,".."),a=(fs.existsSync(i)&&fs.statSync(i).isDirectory()||(0,_util.mkDir)(i),path.parse(t)),o=addPageEntryObj(),c=a.dir+path.sep+a.name+".hml?entry";for(r in o)if(o[r]===c)return;".json"===a.ext&&(a.dir===shareThemePath||a.dir===internalThemePath)&&themeFileBuild(t,e)||(n=fs.createReadStream(t),s=fs.createWriteStream(e),n.pipe(s),n.on("close",function(){s.end()}))}}catch(e){throw e&&/ERROR: /.test(e)?e:new Error("".concat(red,"Failed to build file ").concat(t,".").concat(reset)).message}}function circularFile(a,o,c){var l=path.join(a,c);fs.existsSync(l)&&l!==output&&fs.readdirSync(l).forEach(function(e){var t,r,n,s=path.join(l,e),i=fs.statSync(s);i.isFile()?(r=path.basename(s),n=path.extname(s),(t=path.join(o,c,path.basename(e)))!==path.join(output,"manifest.json")&&(FILE_EXT_NAME.indexOf(n)<0&&".DS_Store"!==r||".json"===n&&(r=path.join(s,".."),n=path.join(r,".."),"i18n"===path.parse(r).name&&"share"===path.parse(n).name||s.toString().startsWith(resourcesPath)||s.toString().startsWith(sharePath)))&&toCopyFile(s,t,i)):i.isDirectory()&&circularFile(a,o,path.join(c,e))})}function toCopyFile(e,t,r){var n;(!fs.existsSync(t)||(n=fs.statSync(t)).isFile()&&r.size!==n.size)&&copyFile(e,t)}var ResourcePlugin=function(){function i(e,t,r,n){var s=4<arguments.length&&void 0!==arguments[4]?arguments[4]:null;(0,_classCallCheck2.default)(this,i),input=e,output=t,manifestFilePath=r,watchCSSFiles=n,shareThemePath=path.join(e,"../share/resources/styles"),internalThemePath=path.join(e,"resources/styles"),resourcesPath=path.resolve(e,"resources"),sharePath=path.resolve(e,"../share/resources"),workerFile=s}return(0,_createClass2.default)(i,[{key:"apply",value:function(s){s.hooks.beforeCompile.tap("resource Copy",function(){var e;_main.multiResourceBuild.value?(e=_main.multiResourceBuild.value.res)&&e.forEach(function(e){circularFile(path.resolve(input,e),path.resolve(output,e),"")}):circularFile(input,output,""),circularFile(input,output,"../share")}),s.hooks.watchRun.tap("i18n",function(e){checkRemove(e)}),s.hooks.normalModuleFactory.tap("OtherEntryOptionPlugin",function(){if("testrunner"===process.env.abilityType)for(var e in checkTestRunner(input,entryObj),entryObj)new SingleEntryPlugin("",entryObj[e],e).apply(s);else{var t=readCSSInfo(watchCSSFiles);if("card"===process.env.DEVICE_LEVEL&&"moduleJson"!==process.env.compileMode)for(var r in s.options.entry)setCSSEntry(t,r);else for(var n in addPageEntryObj(),entryObj=Object.assign(entryObj,abilityEntryObj))s.options.entry[n]||new SingleEntryPlugin("",entryObj[n],n).apply(s),setCSSEntry(t,n);writeCSSInfo(watchCSSFiles,t)}}),s.hooks.done.tap("copyManifest",function(){copyManifest()})}}]),i}();function checkRemove(e){(e.removedFiles||[]).forEach(function(e){-1<e.indexOf(process.env.projectPath)&&".json"===path.extname(e)&&-1<e.indexOf("i18n")&&(e=e.replace(process.env.projectPath,process.env.buildPath),fs.existsSync(e))&&fs.unlinkSync(e)})}function copyManifest(){copyFile(manifestFilePath,path.join(output,"manifest.json")),fs.existsSync(path.join(output,"app.js"))&&fs.utimesSync(path.join(output,"app.js"),new Date,new Date)}var configPath,entryObj={};function addPageEntryObj(){if(entryObj={},"page"===process.env.abilityType){var e=_main.multiResourceBuild.value&&Object.keys(_main.multiResourceBuild.value).length?_main.multiResourceBuild.value:readManifest(manifestFilePath),e=e.pages;if(void 0===e)throw Error("ERROR: missing pages").message;e.forEach(function(e){var e=e.replace(/^\.\/js\//,""),t=path.join(input,e+".hml"),r=process.env.aceSuperVisualPath||"",n=path.join(r,e+".visual"),t=fs.existsSync(t),n=fs.existsSync(n),s=process.env.projectPath;t&&n?console.error("ERROR: "+e+" cannot both have hml && visual"):t?entryObj["./"+e]=path.resolve(s,"./"+e+".hml?entry"):n?entryObj["./"+e]=path.resolve(r,"./"+e+".visual?entry"):entryErrorLog(e)})}return"true"!==process.env.isPreview&&"rich"===process.env.DEVICE_LEVEL&&loadWorker(entryObj),entryObj}function entryErrorLog(e){if(!process.env.watchMode||"true"!==process.env.watchMode)throw Error("[31mERROR: Invalid route "+e+". Verify the route infomation"+(configPath?" in the "+configPath:"")+", and then restart the Build.").message;console.error("COMPILE RESULT:FAIL "),console.error("ERROR: Invalid route "+e+". Verify the route infomation"+(configPath?" in the "+configPath:"")+", and then restart the Previewer.")}var abilityEntryObj={};function addAbilityEntryObj(e){return abilityEntryObj={},readAbilityEntrance(e).forEach(function(e){var t=e.replace(/^\.\/js\//,"./").replace(/\.js$/,"");abilityEntryObj[t]=path.resolve(process.env.projectPath,"../",e)}),abilityEntryObj}function readAbilityEntrance(e){var t=[];return e.module&&(e.module.srcEntrance&&t.push(e.module.srcEntrance),e.module.abilities&&e.module.abilities.length&&readEntrances(e.module.abilities,t),e.module.extensionAbilities)&&e.module.extensionAbilities.length&&readEntrances(e.module.extensionAbilities,t),t}function readEntrances(e,t){e.forEach(function(e){e.type&&"form"===e.type||!e.srcEntrance||t.push(e.srcEntrance)})}function readManifest(e){var t={};try{if(fs.existsSync(e)){configPath=e;var r=fs.readFileSync(e).toString(),t=JSON.parse(r)}else{if(!process.env.aceModuleJsonPath||!fs.existsSync(process.env.aceModuleJsonPath))throw Error("[31mERROR: the manifest.json or module.json is lost.[39m").message;buildManifest(t)}process.env.minPlatformVersion=t.minPlatformVersion}catch(e){throw Error("[31mERROR: the manifest.json or module.json file format is invalid.[39m").message}return t}function readModulePages(e){if(e.module.pages){e=path.resolve(process.env.aceProfilePath,"".concat(e.module.pages.replace(/\$profile\:/,""),".json"));if(fs.existsSync(e))return configPath=e,JSON.parse(fs.readFileSync(e,"utf-8")).src}}function readFormPages(e){var t=[];return e.module.extensionAbilities&&e.module.extensionAbilities.length&&e.module.extensionAbilities.forEach(function(e){e.type&&"form"===e.type&&e.metadata&&e.metadata.length&&e.metadata.forEach(function(e){e.resource&&/\$profile\:/.test(e.resource)&&parseFormConfig(e.resource,t)})}),t}function parseFormConfig(e,t){var e=path.resolve(process.env.aceProfilePath,"".concat(e.replace(/\$profile\:/,""),".json"));fs.existsSync(e)&&(configPath=e,(e=JSON.parse(fs.readFileSync(e,"utf-8"))).forms)&&e.forms.length&&e.forms.forEach(function(e){!e.src||"hml"!==e.uiSyntax&&e.uiSyntax||t.push(e.src)})}function buildManifest(e){try{var t=JSON.parse(fs.readFileSync(process.env.aceModuleJsonPath).toString());"rich"===process.env.DEVICE_LEVEL&&(e.pages=readModulePages(t),e.abilityEntryObj=addAbilityEntryObj(t)),"card"===process.env.DEVICE_LEVEL&&(e.pages=readFormPages(t)),e.minPlatformVersion=t.app.minAPIVersion}catch(e){throw Error("[31mERROR: the module.json file is lost or format is invalid.[39m").message}}function loadWorker(r){var n,e;workerFile?r=Object.assign(r,workerFile):(n=path.resolve(input,"workers"),fs.existsSync(n)&&(readFile(n,e=[]),e.forEach(function(e){var t;/\.js$/.test(e)&&(t=path.relative(n,e).replace(/\.js$/,"").replace(/\\/g,"/"),r["./workers/"+t]=e)})))}function validateWorkOption(){if(process.env.aceBuildJson&&fs.existsSync(process.env.aceBuildJson)&&JSON.parse(fs.readFileSync(process.env.aceBuildJson).toString()).workers)return!0;return!1}function filterWorker(e){return/\.(ts|js)$/.test(e)}function readFile(t,r){try{fs.readdirSync(t).forEach(function(e){e=path.join(t,e);fs.statSync(e).isDirectory()?readFile(e,r):r.push(e)})}catch(e){console.error(e.message)}}function themeFileBuild(e,t){if(fs.existsSync(e)){var n,e=JSON.parse(fs.readFileSync(e)),s={};if(e&&e.style)return s.style={},n=e.style,Object.keys(n).forEach(function(e){var t=CUSTOM_THEME_PROP_GROUPS[e],r=OHOS_THEME_PROP_GROUPS[e];r?s.style[r]=n[e]:t?s.style[t]=n[e]:s.style[e]=n[e]}),fs.writeFileSync(t,JSON.stringify(s,null,2)),!0}return!1}function readCSSInfo(e){return fs.existsSync(e)?JSON.parse(fs.readFileSync(e)):{}}function writeCSSInfo(e,t){fs.existsSync(path.resolve(e,".."))||(0,_util.mkDir)(path.resolve(e,"..")),fs.existsSync(e)&&fs.unlinkSync(e),fs.writeFileSync(e,JSON.stringify(t,null,2))}function setCSSEntry(e,t){e.entry=e.entry||{},fs.existsSync(path.join(input,t+".css"))&&(e.entry[path.join(input,t+".css")]=!0)}function checkTestRunner(e,t){walkSync(e,[],t,e)}function walkSync(n,s,i,a){fs.readdirSync(n).forEach(function(e){var t,e=path.join(n,e),r=fs.statSync(e);r.isFile()&&(".js"===path.extname(e)?(t=e.replace(a,"").replace(".js",""),i["./".concat(t)]=e):r.isDirectory()&&walkSync(e,s,i,a))})}module.exports=ResourcePlugin;