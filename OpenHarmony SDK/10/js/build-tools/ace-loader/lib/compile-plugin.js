"use strict";var _interopRequireDefault=require("@babel/runtime/helpers/interopRequireDefault"),_toConsumableArray2=_interopRequireDefault(require("@babel/runtime/helpers/toConsumableArray")),_classCallCheck2=_interopRequireDefault(require("@babel/runtime/helpers/classCallCheck")),_createClass2=_interopRequireDefault(require("@babel/runtime/helpers/createClass")),_Compilation=_interopRequireDefault(require("webpack/lib/Compilation")),_JavascriptModulesPlugin=_interopRequireDefault(require("webpack/lib/javascript/JavascriptModulesPlugin")),_CachedSource=_interopRequireDefault(require("webpack-sources/lib/CachedSource")),_ConcatSource=_interopRequireDefault(require("webpack-sources/lib/ConcatSource")),_util=require("./util"),_cluster=_interopRequireDefault(require("cluster"));function _createForOfIteratorHelper(e,r){var n,o,t,a,s="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(s)return o=!(n=!0),{s:function(){s=s.call(e)},n:function(){var e=s.next();return n=e.done,e},e:function(e){o=!0,t=e},f:function(){try{n||null==s.return||s.return()}finally{if(o)throw t}}};if(Array.isArray(e)||(s=_unsupportedIterableToArray(e))||r&&e&&"number"==typeof e.length)return s&&(e=s),a=0,{s:r=function(){},n:function(){return a>=e.length?{done:!0}:{done:!1,value:e[a++]}},e:function(e){throw e},f:r};throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}function _unsupportedIterableToArray(e,r){var n;if(e)return"string"==typeof e?_arrayLikeToArray(e,r):"Map"===(n="Object"===(n=Object.prototype.toString.call(e).slice(8,-1))&&e.constructor?e.constructor.name:n)||"Set"===n?Array.from(e):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?_arrayLikeToArray(e,r):void 0}function _arrayLikeToArray(e,r){(null==r||r>e.length)&&(r=e.length);for(var n=0,o=new Array(r);n<r;n++)o[n]=e[n];return o}var mStats,GLOBAL_COMMON_MODULE_CACHE,fs=require("fs"),path=require("path"),mErrorCount=0,mWarningCount=0,isShowError=!0,isShowWarning=!0,isShowNote=!0,warningCount=0,noteCount=0,errorCount=0,ResultStates=function(){function r(e){(0,_classCallCheck2.default)(this,r),this.options=e,GLOBAL_COMMON_MODULE_CACHE='\n      globalThis["__common_module_cache__'.concat(process.env.hashProjectPath,'"] =')+' globalThis["__common_module_cache__'.concat(process.env.hashProjectPath,'"] || {};')}return(0,_createClass2.default)(r,[{key:"apply",value:function(e){var s=this.options.build,i=new Set,c=new Set,l=path.resolve(process.env.cachePath,".rich_cache"),u=path.join(l,"entry.json"),h=new Set;e.hooks.compilation.tap("toFindModule",function(e){e.hooks.buildModule.tap("findModule",function(e){var r,n;e.resource&&fs.existsSync(e.resource)&&h.add(e.resource),0<=e.context.indexOf(process.env.projectPath)||(r=(e=path.join(e.context)).lastIndexOf(path.join("src","main","js")))<0||(n=path.resolve(e.substring(0,r),"src","main","js","common"),fs.existsSync(n)&&i.add(n),n=path.resolve(e.substring(0,r),"src","main","js","i18n"),fs.existsSync(n)&&c.add(n))})}),e.hooks.afterCompile.tap("copyFindModule",function(){var e,r=_createForOfIteratorHelper(i);try{for(r.s();!(e=r.n()).done;){var n=e.value;(0,_util.circularFile)(n,path.resolve(s,"../share/common"))}}catch(e){r.e(e)}finally{r.f()}var o,t=_createForOfIteratorHelper(c);try{for(t.s();!(o=t.n()).done;){var a=o.value;(0,_util.circularFile)(a,path.resolve(s,"../share/i18n"))}}catch(e){t.e(e)}finally{t.f()}addCacheFiles(u,l,h)}),e.hooks.done.tap("Result States",function(e){Object.keys(_util.elements).forEach(function(e){delete _util.elements[e]}),process.env.isPreview&&process.env.aceSoPath&&_util.useOSFiles&&0<_util.useOSFiles.size&&writeUseOSFiles(),errorCount=noteCount=warningCount=0,(mStats=e).compilation.errors&&(mErrorCount=mStats.compilation.errors.length),mStats.compilation.warnings&&(mWarningCount=mStats.compilation.warnings.length),"false"===process.env.error&&(isShowError=!1),"false"===process.env.warning&&(isShowWarning=!1),"false"===process.env.note&&(isShowNote=!1),printResult(s)}),e.hooks.compilation.tap("CommonAsset",function(e){e.hooks.processAssets.tap({name:"GLOBAL_COMMON_MODULE_CACHE",stage:_Compilation.default.PROCESS_ASSETS_STAGE_ADDITIONS},function(e){e["commons.js"]?e["commons.js"]=new _CachedSource.default(new _ConcatSource.default(e["commons.js"],GLOBAL_COMMON_MODULE_CACHE)):e["vendors.js"]&&(e["vendors.js"]=new _CachedSource.default(new _ConcatSource.default(e["vendors.js"],GLOBAL_COMMON_MODULE_CACHE)))})}),e.hooks.compilation.tap("Require",function(e){_JavascriptModulesPlugin.default.getCompilationHooks(e).renderRequire.tap("renderRequire",function(e){return"rich"===process.env.DEVICE_LEVEL?"var commonCachedModule ="+' globalThis["__common_module_cache__'.concat(process.env.hashProjectPath,'"] ? ')+'globalThis["__common_module_cache__'.concat(process.env.hashProjectPath,'"]')+"[moduleId]: null;\nif (commonCachedModule) { return commonCachedModule.exports; }\n"+e.replace("// Execute the module function",'function isCommonModue(moduleId) {\n              if (globalThis["webpackChunk'.concat(process.env.hashProjectPath,'"]) {\n                const length = globalThis["webpackChunk').concat(process.env.hashProjectPath,'"].length;\n                switch (length) {\n                  case 1:\n                    return globalThis["webpackChunk').concat(process.env.hashProjectPath,'"][0][1][moduleId];\n                  case 2:\n                    return globalThis["webpackChunk').concat(process.env.hashProjectPath,'"][0][1][moduleId] ||\n                    globalThis["webpackChunk').concat(process.env.hashProjectPath,'"][1][1][moduleId];\n                }\n              }\n              return undefined;\n            }\n')+'if (globalThis["__common_module_cache__'.concat(process.env.hashProjectPath,'"]')+' && String(moduleId).indexOf("?name=") < 0 && isCommonModue(moduleId)) {\n'+'  globalThis["__common_module_cache__'.concat(process.env.hashProjectPath,'"]')+"[moduleId] = module;\n}"):e})})}}]),r}();function addCacheFiles(e,r,n){var o=[];fs.existsSync(e)?JSON.parse(fs.readFileSync(e)).forEach(function(e){n.add(e)}):fs.existsSync(r)||(0,_util.mkDir)(r),o.push.apply(o,(0,_toConsumableArray2.default)(n)),fs.writeFileSync(e,JSON.stringify(o))}var red="[31m",yellow="[33m",blue="[34m",reset="[39m",writeError=function(e,r){fs.writeFile(path.resolve(e,"compile_error.log"),r,function(e){if(e)return console.error(e)})};function printResult(e){var r;printWarning(),printError(e),0<errorCount+warningCount+noteCount||"false"===process.env.abcCompileSuccess?(e={},r=0<errorCount?(e.ERROR=errorCount,"FAIL "):"SUCCESS ","false"===process.env.abcCompileSuccess&&(r="FAIL "),0<warningCount&&(e.WARN=warningCount),0<noteCount&&(e.NOTE=noteCount),"SUCCESS "===r&&"true"===process.env.isPreview?printPreviewResult(e):console.log(blue,"COMPILE RESULT:"+r+JSON.stringify(e),reset)):"true"===process.env.isPreview?printPreviewResult():console.log(blue,"COMPILE RESULT:SUCCESS ",reset),clearArkCompileStatus()}function clearArkCompileStatus(){process.env.abcCompileSuccess="true"}function printPreviewResult(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:"";0===Object.keys(_cluster.default.workers).length&&printSuccessInfo(e)}function printSuccessInfo(e){0===e.length?console.log(blue,"COMPILE RESULT:SUCCESS ",reset):console.log(blue,"COMPILE RESULT:SUCCESS "+JSON.stringify(e),reset)}function printWarning(){if(0<mWarningCount){for(var e=mStats.compilation.warnings,r=e.length,n=0;n<r;n++){var o=e[n].message;null!==o.match(/noteStart(([\s\S])*)noteEnd/)?(noteCount++,isShowNote&&console.info(" "+o.match(/noteStart(([\s\S])*)noteEnd/)[1].trim(),reset,"\n")):null!==o.match(/warnStart(([\s\S])*)warnEnd/)&&(warningCount++,isShowWarning)&&console.warn(yellow,o.match(/warnStart(([\s\S])*)warnEnd/)[1].trim(),reset,"\n")}r<mWarningCount&&(warningCount=warningCount+mWarningCount-r)}}function printError(e){if(0<mErrorCount){var o=mStats.compilation.errors,r=o.length;if(isShowError){for(var t="",a=0;a<r;a++)!function(){var e,r,n;o[a]&&(e=o[a].message)&&(null!==e.match(/errorStart(([\s\S])*)errorEnd/)?(r=e.match(/errorStart(([\s\S])*)errorEnd/)[1],console.error(red,r.trim(),reset,"\n")):(r=e.split("\n"),n="",r.forEach(function(e){/^at/.test(e.trim())||(n=n+e+"\n")}),console.error(red,n,reset,"\n")),errorCount++,t+=e)}();writeError(e,t)}}}function writeUseOSFiles(){var e,r="";fs.existsSync(process.env.aceSoPath)?r=fs.readFileSync(process.env.aceSoPath,"utf-8")+"\n":(e=path.join(process.env.aceSoPath,".."),fs.existsSync(e)&&!fs.statSync(e).isFile()||(0,_util.mkDir)(e)),fs.writeFileSync(process.env.aceSoPath,r+Array.from(_util.useOSFiles).join("\n"))}module.exports=ResultStates;